<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plan Pepe 3.8 (Ultimate Saiyan)</title>
    
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><circle cx=%2250%22 cy=%2250%22 r=%2245%22 fill=%22%23fbbf24%22 stroke=%22%23b45309%22 stroke-width=%223%22/><path d=%22M50 25L55 40L70 40L58 50L63 65L50 55L37 65L42 50L30 40L45 40Z%22 fill=%22%23dc2626%22/></svg>">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>

    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Bangers&family=Rajdhani:wght@500;700&family=Inter:wght@300;400;600&display=swap');
        
        :root { 
            --anime-bg: url('https://img.asmedia.epimg.net/resizer/v2/DGT4YH6XWRETPCDYD54YIZIOXA.jpg?auth=66daaf9f308debf7a1645374b9cce9160fbcfb78d168e9bbe65833e97cc953ed&width=1472&height=828&smart=true'); 
            --saiyan-gold: #fbbf24;
            --power-blue: #3b82f6;
            --energy-green: #22c55e;
            --danger-red: #ef4444;
        }

        body { 
            font-family: 'Inter', sans-serif; color: #e2e8f0; margin: 0; padding: 0;
            background-color: #0b0f19; 
            background-image: linear-gradient(rgba(0,0,0,0.88), rgba(0,0,0,0.92)), var(--anime-bg);
            background-size: cover; background-position: center; background-attachment: fixed;
            min-height: 100vh;
        }

        .comic-font { font-family: 'Bangers', cursive; letter-spacing: 2px; }
        .scouter-font { font-family: 'Rajdhani', sans-serif; font-weight: 700; letter-spacing: 0.5px; }
        
        .glass { 
            background: rgba(15, 23, 42, 0.95); backdrop-filter: blur(16px); 
            border: 1px solid rgba(59, 130, 246, 0.2); box-shadow: 0 0 20px rgba(0, 0, 0, 0.6); 
        }
        
        .chart-container { position: relative; width: 100%; height: 200px; max-height: 300px; }
        #auth-screen { position: fixed; inset: 0; z-index: 100; display: flex; align-items: center; justify-content: center; background: #050505; }
        
        .hidden { display: none !important; }
        .hidden-tab { display: none; }
        .fade-in { animation: fadeIn 0.5s cubic-bezier(0.4, 0, 0.2, 1); }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
        
        .nav-btn.active { color: #fbbf24 !important; transform: scale(1.2); border-bottom: 3px solid #fbbf24; text-shadow: 0 0 15px rgba(251, 191, 36, 0.8); } 
        .nav-btn { transition: all 0.3s ease; border-bottom: 3px solid transparent; color: #64748b; }
        
        .calendar-day { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 0.6rem; border-radius: 0.75rem; border: 1px solid #334155; background-color: rgba(15, 23, 42, 0.8); cursor: pointer; transition: all 0.2s; }
        .calendar-day.active { border-color: #fbbf24; background-color: rgba(251, 191, 36, 0.2); color: #fcd34d; transform: scale(1.1); }
    </style>
</head>
<body class="pb-32">

    <div id="auth-screen" class="bg-black/95">
        <div class="glass p-10 rounded-3xl max-w-sm w-full mx-4 text-center border-t-4 border-yellow-500 shadow-[0_0_60px_rgba(234,179,8,0.25)]">
            <h1 class="text-6xl text-white comic-font mb-2 uppercase italic">PEPE <span class="text-blue-500 font-sans">3.8</span></h1>
            <p class="text-blue-300 scouter-font text-xl mb-8 uppercase italic">Terminal Namek</p>
            <form id="login-form" class="space-y-5 text-left">
                <input type="email" id="auth-email" class="w-full bg-slate-900 border border-blue-900 rounded-xl p-4 text-white outline-none focus:border-yellow-400" placeholder="Email" required>
                <input type="password" id="auth-pass" class="w-full bg-slate-900 border border-blue-900 rounded-xl p-4 text-white outline-none focus:border-yellow-400" placeholder="Contrase√±a" required>
                <div id="register-nickname-field" class="hidden"><input type="text" id="auth-nickname" class="w-full bg-slate-900 border border-yellow-500 rounded-xl p-4 text-white outline-none mb-4" placeholder="Tu Apodo Z"></div>
                <div class="text-xs text-red-400 hidden" id="auth-error">Error</div>
                <button type="submit" class="w-full bg-blue-700 hover:bg-blue-600 text-white font-bold py-4 rounded-xl scouter-font text-2xl uppercase tracking-widest transition-all">ACCEDER</button>
            </form>
        </div>
    </div>

    <header class="p-4 pt-6 border-b border-blue-900/30 sticky top-0 z-40 glass shadow-2xl">
        <div class="max-w-3xl mx-auto flex justify-between items-center">
            <div onclick="switchTab('home')" class="cursor-pointer">
                <h1 class="text-4xl text-white comic-font italic uppercase leading-none">PLAN <span class="text-yellow-400">Z</span></h1>
                <p class="text-[11px] text-blue-200 scouter-font uppercase italic">Guerrero: <span id="header-username">...</span></p>
            </div>
            <div class="cursor-pointer p-3" onclick="toggleSettings()"><i data-lucide="settings" class="w-7 h-7 text-blue-300"></i></div>
        </div>

        <div id="settings-panel" class="hidden mt-4 p-5 bg-slate-900 rounded-2xl border border-blue-800 max-w-2xl mx-auto space-y-5">
            <div class="flex items-center justify-between bg-slate-800 p-4 rounded-xl">
                <span class="text-sm font-bold text-white italic" id="user-email-display">...</span>
                <button onclick="logout()" class="text-xs text-red-400 border border-red-400/50 px-3 py-1 rounded font-bold uppercase">Salir</button>
            </div>
            <div class="grid grid-cols-2 gap-3">
                <button onclick="changeNickname()" class="bg-slate-700 text-white text-xs py-3 rounded font-bold uppercase">Apodo</button>
                <button onclick="changeGroup()" class="bg-indigo-900 text-white text-xs py-3 rounded font-bold uppercase">Clan</button>
                <button onclick="deleteCurrentWeek()" class="bg-red-900 text-white text-xs py-3 rounded font-bold uppercase">Borrar Ciclo</button>
                <button onclick="resetDefaultPlan()" class="bg-slate-800 text-white text-xs py-3 rounded font-bold uppercase">Reset</button>
            </div>
	<div class="pt-3 border-t border-slate-700 text-center">
    <p class="text-[10px] text-slate-400 mb-3 uppercase font-bold italic">Protocolo IA</p>
    <div class="flex gap-3 mb-3">
        <button onclick="copyPrompt()" class="flex-1 text-[10px] bg-purple-700 p-3 rounded-xl text-white font-bold uppercase shadow-lg">Copiar Comando IA</button>
        <button onclick="importNewWeek()" class="flex-1 text-[10px] bg-green-800 p-3 rounded-xl text-white font-bold uppercase shadow-lg">Importar JSON</button>
    </div>
    <div class="relative">
        <textarea id="import-code-area" class="w-full bg-black text-green-400 p-4 rounded-xl border border-green-900 h-24 text-[10px] font-mono outline-none" placeholder="Pega el c√≥digo JSON aqu√≠..."></textarea>
        <button onclick="document.getElementById('import-code-area').value=''" class="absolute bottom-2 right-2 text-[8px] bg-red-900/50 text-red-300 px-2 py-1 rounded border border-red-800 uppercase font-bold">Limpiar</button>
    </div>
</div>
        </div>
    </header>

    <main class="max-w-2xl mx-auto p-4 space-y-6 pb-24">
        
<div id="tab-home" class="tab-content fade-in space-y-8">
    <div class="text-center p-6 glass rounded-3xl border-b-4 border-yellow-500 shadow-2xl">
        <h2 class="text-5xl text-yellow-400 comic-font uppercase italic tracking-tighter">Terminal Z</h2>
        <p class="text-slate-300 text-sm mt-2 font-medium">Gu√≠a de supervivencia y evoluci√≥n para el Guerrero.</p>
    </div>

    <div class="grid gap-4">
        <div class="bg-purple-900/20 p-6 rounded-3xl border-2 border-purple-500/30 shadow-lg">
            <h3 class="text-purple-400 scouter-font text-2xl uppercase italic mb-4 flex items-center gap-3">
                <i data-lucide="bot" class="animate-bounce w-7 h-7"></i> ¬øC√≥mo importar tu Plan?
            </h3>
            <div class="space-y-4 text-sm">
                <div class="flex gap-4">
                    <div class="bg-purple-600 text-white font-bold rounded-full w-6 h-6 flex-shrink-0 flex items-center justify-center">1</div>
                    <p class="text-slate-200"><strong class="text-yellow-400">PERFIL:</strong> Entra al usuario. Pon tu Meta de Peso y Lesiones. En **STATS**, pon tu peso actual. La IA necesita esto para ser eficiente.</p>
                </div>
                <div class="flex gap-4">
                    <div class="bg-purple-600 text-white font-bold rounded-full w-6 h-6 flex-shrink-0 flex items-center justify-center">2</div>
                    <p class="text-slate-200"><strong class="text-yellow-400">COMANDO:</strong> Ve a Ajustes (rueda arriba) y pulsa "Copiar Comando IA".</p>
                </div>
                <div class="flex gap-4">
                    <div class="bg-purple-600 text-white font-bold rounded-full w-6 h-6 flex-shrink-0 flex items-center justify-center">3</div>
                    <p class="text-slate-200"><strong class="text-yellow-400">IMPORTAR:</strong> Pega el comando en Gemini. Copia el JSON que te d√© y p√©galo en Ajustes.</p>
                </div>
            </div>
        </div>

        <div id="ki-status-card" class="bg-slate-900/80 p-5 rounded-2xl border-l-4 border-blue-500 shadow-xl hidden">
            <h3 class="text-white scouter-font text-lg uppercase flex items-center gap-2">
                <i data-lucide="zap" class="w-5 h-5 text-yellow-400"></i> Estado del Ki Actual
            </h3>
            <p id="ki-status-text" class="text-xs text-slate-400 mt-1 italic">Calculando biometr√≠a...</p>
        </div>
    </div>

    <button onclick="switchTab('plan')" class="w-full bg-yellow-500 hover:bg-yellow-400 text-black font-bold py-6 rounded-3xl comic-font text-3xl shadow-[0_0_40px_rgba(234,179,8,0.3)] transition-all transform active:scale-95 uppercase italic">
        ¬°EMPEZAR ENTRENAMIENTO!
    </button>
</div>

		<div id="tab-ranking" class="tab-content hidden-tab fade-in space-y-8">
            <div class="glass p-1 rounded-3xl border border-yellow-500/30 mb-8 relative overflow-hidden shadow-2xl">
                <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-yellow-500 via-red-500 to-yellow-500"></div>
                <div class="p-6">
                    <div class="text-center mb-6">
                        <h2 class="text-4xl font-bold text-white comic-font flex items-center justify-center gap-4 italic tracking-widest text-shadow-lg uppercase"><i data-lucide="swords" class="text-yellow-400 w-10 h-10"></i> TORNEO DE PODER</h2>
                        <div class="inline-flex items-center gap-3 bg-indigo-950/80 px-6 py-2 rounded-full border border-indigo-500/50 mt-3 shadow-2xl">
                            <span class="text-[10px] text-indigo-300 uppercase font-bold tracking-widest">SECTOR CLAN:</span>
                            <span id="ranking-group-name" class="text-base text-white scouter-font font-bold uppercase text-indigo-100 tracking-wider">...</span>
                        </div>
                    </div>
                    <div class="overflow-x-auto rounded-2xl bg-black/20 p-2 shadow-inner border border-slate-800">
                        <table class="w-full text-sm text-left text-slate-300 border-separate border-spacing-y-2">
                            <thead class="text-[10px] text-blue-400 uppercase tracking-widest">
                                <tr>
                                    <th class="px-2 py-3 text-center">Rango</th>
                                    <th class="px-2 py-3">Guerrero</th>
                                    <th class="px-2 py-3 text-center">Evoluci√≥n %</th>
                                    <th class="px-2 py-3 text-center text-yellow-200">Press Z</th>
                                    <th class="px-2 py-3 text-center text-yellow-200">Prensa Z</th>
                                </tr>
                            </thead>
                            <tbody id="rankingTableBody" class="scouter-font text-base italic">
                                </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <div class="glass p-6 rounded-3xl border-l-8 border-blue-500 relative shadow-[0_20px_40px_rgba(0,0,0,0.4)]">
                <div class="flex items-center justify-between mb-5">
                    <h3 class="text-sm font-bold text-blue-300 uppercase tracking-widest flex items-center gap-2 scouter-font"><i data-lucide="scan-face" class="w-5 h-5 text-blue-400"></i> Firma Biom√©trica Actual</h3>
                </div>
                <div class="grid grid-cols-3 gap-3 text-center">
                    <div class="bg-slate-900/90 p-3 rounded-2xl border border-slate-700 shadow-xl"><p class="text-[8px] text-slate-500 uppercase font-black mb-1">Cambio%</p><p id="card-weight-change" class="text-sm font-bold text-white scouter-font tracking-tight">--</p></div>
                    <div class="bg-slate-900/90 p-3 rounded-2xl border border-yellow-900/40 shadow-xl"><p class="text-[8px] text-yellow-600 uppercase font-black mb-1">Press KG</p><p id="card-bench-press" class="text-sm font-bold text-yellow-400 scouter-font">--</p></div>
                    <div class="bg-slate-900/90 p-3 rounded-2xl border border-yellow-900/40 shadow-xl"><p class="text-[8px] text-yellow-600 uppercase font-black mb-1">Prensa KG</p><p id="card-leg-press" class="text-sm font-bold text-yellow-400 scouter-font">--</p></div>
                </div>
            </div>
        </div>

        <div id="tab-plan" class="tab-content hidden-tab fade-in space-y-6">
            <div class="flex justify-between items-center gap-4">
                <select id="week-selector" onchange="changeWeek()" class="bg-slate-900 text-white scouter-font font-bold p-3 rounded-xl flex-1 outline-none border border-slate-700"></select>
                <button onclick="openSpyModal()" class="glass p-4 rounded-xl border border-purple-500 text-purple-300 font-bold text-xs flex items-center gap-2"><i data-lucide="eye"></i> ESPIAR</button>
            </div>
            <div class="grid grid-cols-7 gap-2 text-center" id="calendar-grid">
                <div class="calendar-day" onclick="scrollToDay(0)"><span>LUN</span><span class="day-num block font-bold text-lg">--</span></div>
                <div class="calendar-day" onclick="scrollToDay(1)"><span>MAR</span><span class="day-num block font-bold text-lg">--</span></div>
                <div class="calendar-day" onclick="scrollToDay(2)"><span>MI√â</span><span class="day-num block font-bold text-lg">--</span></div>
                <div class="calendar-day" onclick="scrollToDay(3)"><span>JUE</span><span class="day-num block font-bold text-lg">--</span></div>
                <div class="calendar-day" onclick="scrollToDay(4)"><span>VIE</span><span class="day-num block font-bold text-lg">--</span></div>
                <div class="calendar-day" onclick="scrollToDay(5)"><span>S√ÅB</span><span class="day-num block font-bold text-lg">--</span></div>
                <div class="calendar-day" onclick="scrollToDay(6)"><span>DOM</span><span class="day-num block font-bold text-lg">--</span></div>
            </div>
            <div id="plan-container" class="space-y-6"></div>
        </div>

        <div id="tab-running" class="tab-content hidden-tab fade-in space-y-8">
            <div class="glass p-8 rounded-[2.5rem] border border-orange-500/30">
                <h3 class="text-2xl font-bold text-white mb-6 scouter-font uppercase italic border-b border-orange-900/30 pb-3">Actividad Aer√≥bica</h3>
                <form id="runForm" class="space-y-6">
                    <input type="date" id="runDate" class="w-full bg-slate-900 border border-slate-700 p-4 rounded-xl text-white" required>
                    <div class="grid grid-cols-2 gap-4">
                        <input type="number" id="runDist" step="0.01" placeholder="KM" class="bg-slate-900 border border-slate-700 p-4 rounded-xl text-3xl font-bold text-white text-center">
                        <input type="number" id="runTime" step="1" placeholder="MIN" class="bg-slate-900 border border-slate-700 p-4 rounded-xl text-3xl font-bold text-white text-center">
                    </div>
                    <button type="submit" class="w-full bg-orange-700 text-white font-bold py-5 rounded-2xl uppercase scouter-font">Guardar Sesi√≥n</button>
                </form>
            </div>
            <div class="chart-container glass rounded-3xl p-4"><canvas id="chartRunning"></canvas></div>
            <div class="glass rounded-3xl overflow-hidden"><table class="w-full text-sm text-left"><tbody id="runningTableBody"></tbody></table></div>
        </div>

        <div id="tab-strength" class="tab-content hidden-tab fade-in space-y-8">
            <div class="glass p-8 rounded-3xl border border-blue-500/20 shadow-2xl">
                <h3 class="text-2xl font-bold text-white mb-6 scouter-font uppercase italic">Esc√°ner de Potencia</h3>
                <select id="exercise-select" onchange="renderStrengthChart()" class="w-full bg-slate-900 border border-slate-700 p-4 rounded-xl text-white mb-6"></select>
                <div class="chart-container h-64"><canvas id="chartStrength"></canvas></div>
            </div>
            <div id="pr-list" class="space-y-3"></div>
        </div>

        <div id="tab-supplements" class="tab-content hidden-tab fade-in space-y-8">
            <div class="flex justify-between items-center">
                <h3 class="text-3xl font-bold text-white scouter-font italic">Ki Suministros</h3>
                <button onclick="openSuppModal()" class="bg-teal-700 text-white px-5 py-2 rounded-xl font-bold uppercase text-xs">+ A√±adir</button>
            </div>
            <div id="supplements-list" class="grid gap-4"></div>
        </div>

        <div id="tab-gallery" class="tab-content hidden-tab fade-in space-y-8 text-center">
            <div class="glass p-10 rounded-3xl border border-purple-500/30">
                <h3 class="text-2xl font-bold mb-6 scouter-font uppercase italic">Expediente Visual</h3>
                <button onclick="document.getElementById('photo-input').click()" class="bg-purple-700 text-white px-8 py-4 rounded-2xl font-bold uppercase shadow-lg">+ Generar Captura</button>
                <input type="file" id="photo-input" accept="image/*" class="hidden" onchange="handlePhotoUpload(this)">
            </div>
            <div id="gallery-grid" class="grid grid-cols-2 gap-4"></div>
        </div>

        <div id="tab-stats" class="tab-content hidden-tab fade-in space-y-8">
            <div class="glass p-8 rounded-[2.5rem] border border-green-500/30 relative overflow-hidden shadow-2xl">
                 <div class="absolute -right-16 -top-16 text-green-500/5"><i data-lucide="activity" class="w-80 h-80"></i></div>
                <h3 class="text-3xl font-bold text-white mb-8 relative z-10 scouter-font uppercase italic flex items-center gap-5 border-b border-green-900/30 pb-4">
                    <i data-lucide="activity" class="text-green-400 w-8 h-8"></i> DIAGN√ìSTICO VITAL
                </h3>
                <form id="entryForm" class="space-y-6 relative z-10">
                    <input type="date" id="inputDate" class="w-full bg-slate-900/95 border border-slate-700 rounded-2xl p-5 text-white outline-none focus:border-green-500 transition-all font-mono text-lg" required>
                    <div class="grid grid-cols-2 gap-6">
                        <div class="space-y-2">
                            <label class="text-[10px] text-blue-400 ml-2 font-bold uppercase tracking-widest">Peso Actual (KG)</label>
                            <input type="number" id="inputWeight" step="0.1" class="w-full bg-slate-900 border border-slate-700 rounded-2xl p-5 text-white outline-none focus:border-blue-500 scouter-font text-4xl shadow-inner" required>
                        </div>
                        <div class="space-y-2">
                            <label class="text-[10px] text-green-400 ml-2 font-bold uppercase tracking-widest">VFC (Latencia)</label>
                            <input type="number" id="inputVfc" class="w-full bg-slate-900 border border-slate-700 rounded-2xl p-5 text-white outline-none focus:border-green-500 scouter-font text-4xl shadow-inner" required>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-6">
                        <div class="space-y-2">
                            <label class="text-[10px] text-red-400 ml-2 font-bold uppercase tracking-widest">PPM Reposo</label>
                            <input type="number" id="inputRhr" class="w-full bg-slate-900 border border-slate-700 rounded-2xl p-5 text-white outline-none focus:border-red-500 scouter-font text-4xl shadow-inner">
                        </div>
                        <div class="space-y-2">
                            <label class="text-[10px] text-purple-400 ml-2 font-bold uppercase tracking-widest">Sue√±o (Horas)</label>
                            <input type="number" id="inputSleep" step="0.5" class="w-full bg-slate-900 border border-slate-700 rounded-2xl p-5 text-white outline-none focus:border-purple-500 scouter-font text-4xl shadow-inner">
                        </div>
                    </div>
                    <button type="submit" class="w-full bg-green-700 hover:bg-green-600 text-white font-bold py-6 rounded-3xl border-b-4 border-green-900 uppercase tracking-widest text-xl scouter-font transition-all transform active:scale-95">Sincronizar Diagn√≥stico</button>
                </form>
            </div>

            <div class="grid grid-cols-2 lg:grid-cols-4 gap-4">
                <div class="glass p-4 rounded-2xl border border-blue-900/20 text-center">
                    <p class="text-[9px] text-blue-300 font-bold uppercase mb-2">Peso</p>
                    <div class="chart-container h-32"><canvas id="chartWeight"></canvas></div>
                </div>
                <div class="glass p-4 rounded-2xl border border-green-900/20 text-center">
                    <p class="text-[9px] text-green-300 font-bold uppercase mb-2">VFC</p>
                    <div class="chart-container h-32"><canvas id="chartVfc"></canvas></div>
                </div>
                <div class="glass p-4 rounded-2xl border border-red-900/20 text-center">
                    <p class="text-[9px] text-red-300 font-bold uppercase mb-2">PPM</p>
                    <div class="chart-container h-32"><canvas id="chartRhr"></canvas></div>
                </div>
                <div class="glass p-4 rounded-2xl border border-purple-900/20 text-center">
                    <p class="text-[9px] text-purple-300 font-bold uppercase mb-2">Sue√±o</p>
                    <div class="chart-container h-32"><canvas id="chartSleep"></canvas></div>
                </div>
            </div>

            <div class="glass p-6 rounded-[2.5rem] overflow-x-auto shadow-2xl border-t-4 border-green-500/20">
                <table class="w-full text-xs text-left text-slate-300 border-separate border-spacing-y-2">
                    <thead class="text-[10px] text-blue-400 uppercase tracking-widest bg-slate-900/50 font-black italic">
                        <tr>
                            <th class="px-4 py-4 rounded-l-xl">Fecha</th>
                            <th class="px-2 py-4 text-center">KG</th>
                            <th class="px-2 py-4 text-center">VFC</th>
                            <th class="px-2 py-4 text-center text-red-400">PPM</th>
                            <th class="px-4 py-4 text-right rounded-r-xl">Acci√≥n</th>
                        </tr>
                    </thead>
                    <tbody id="historyTableBody" class="scouter-font text-lg italic"></tbody>
                </table>
            </div>
        </div>

        <div id="tab-profile" class="tab-content hidden-tab fade-in space-y-8">
            <div class="glass p-8 rounded-[2.5rem] border border-yellow-500/30 shadow-2xl relative overflow-hidden">
                <div class="absolute -right-10 -top-10 text-yellow-500/5 rotate-12"><i data-lucide="shield-check" class="w-48 h-48"></i></div>
                <h3 class="text-3xl font-bold text-white mb-6 scouter-font uppercase italic border-b border-yellow-900/30 pb-3">Expediente de Guerrero</h3>
                <div class="space-y-6 relative z-10">
                    <div class="space-y-2">
                        <label class="text-[10px] text-yellow-400 font-bold uppercase ml-1">Meta de Peso Maestro (KG)</label>
                        <input type="number" id="profile-target" step="0.1" onchange="updateProfileData()" class="w-full bg-slate-900 border border-slate-700 rounded-2xl p-5 text-white text-3xl scouter-font outline-none focus:border-yellow-500 shadow-inner" placeholder="Ej: 85.0">
                    </div>
                    <div class="space-y-2">
                        <label class="text-[10px] text-red-400 font-bold uppercase ml-1 italic">Historial de Lesiones / Limitaciones</label>
                        <textarea id="profile-injuries" rows="3" onchange="updateProfileData()" class="w-full bg-slate-900 border border-slate-700 rounded-2xl p-5 text-white text-sm outline-none focus:border-red-500 italic shadow-inner" placeholder="Ej: Lesi√≥n lumbar L5-S1..."></textarea>
                    </div>
                    <div class="bg-blue-900/20 p-4 rounded-2xl border border-blue-500/20">
                        <p class="text-[10px] text-blue-300 uppercase font-black mb-2">Sincronizaci√≥n IA Activa</p>
                        <p class="text-[11px] text-slate-400 italic">Los datos del perfil se env√≠an a Gemini autom√°ticamente para un entrenamiento 100% seguro.</p>
                    </div>
                </div>
            </div>
        </div>

    </main>

    <div id="spy-modal" class="hidden fixed inset-0 bg-black/98 z-50 flex items-center justify-center p-6 backdrop-blur-xl">
        <div class="glass bg-slate-900 w-full max-w-xl p-8 rounded-[2rem] border border-purple-500/50 relative h-[80vh] flex flex-col shadow-2xl">
            <button onclick="closeSpyModal()" class="absolute top-4 right-4 text-slate-400 p-2"><i data-lucide="x"></i></button>
            <h4 class="text-3xl font-bold text-purple-400 scouter-font mb-6 italic uppercase">Radar de Objetivos</h4>
            <div id="spy-user-list" class="flex gap-4 overflow-x-auto pb-4 border-b border-slate-800 mb-4"></div>
            <div id="spy-weeks-container" class="flex-1 overflow-y-auto space-y-4"></div>
        </div>
    </div>

    <div id="spy-preview-modal" class="hidden fixed inset-0 bg-black/99 z-[60] flex items-center justify-center p-6 backdrop-blur-3xl">
         <div class="glass bg-slate-950 w-full max-w-lg p-10 rounded-[2rem] border-2 border-blue-500 relative max-h-[85vh] flex flex-col shadow-2xl">
             <button onclick="closeSpyPreview()" class="absolute top-4 right-4 text-slate-400 p-2"><i data-lucide="x"></i></button>
             <h4 class="text-2xl font-bold text-white scouter-font mb-6 italic uppercase">Vista Previa</h4>
             <div id="spy-preview-content" class="flex-1 overflow-y-auto space-y-4 text-slate-200 text-xs italic bg-black/50 p-4 rounded-xl shadow-inner border border-slate-800"></div>
             <button id="btn-copy-preview" class="w-full bg-green-700 hover:bg-green-600 text-white font-bold py-6 rounded-2xl uppercase mt-4 shadow-xl transition-all active:scale-95">CLONAR PLAN Z</button>
         </div>
    </div>

    <div id="supp-modal" class="hidden fixed inset-0 bg-black/95 z-50 flex items-center justify-center p-6 backdrop-blur-sm">
        <div class="glass bg-slate-900 w-full max-w-lg p-8 rounded-3xl border border-teal-500 shadow-2xl">
            <h4 id="supp-modal-title" class="text-2xl font-bold text-white mb-6 uppercase italic">Editar Suministro</h4>
            <form id="suppForm" class="space-y-4">
                <input type="hidden" id="suppId">
                <input type="text" id="suppName" class="w-full bg-slate-800 p-4 rounded-xl text-white border border-slate-700 outline-none" placeholder="Nombre" required>
                <input type="text" id="suppDose" class="w-full bg-slate-800 p-4 rounded-xl text-white border border-slate-700 outline-none" placeholder="Dosis" required>
                <select id="suppTiming" class="w-full bg-slate-800 p-4 rounded-xl text-white border border-slate-700 outline-none">
                    <option value="morning">Ma√±ana</option>
                    <option value="workout">Entrenamiento</option>
                    <option value="meal">Comidas</option>
                    <option value="night">Noche</option>
                </select>
                <textarea id="suppDesc" class="w-full bg-slate-800 p-4 rounded-xl text-white border border-slate-700 outline-none" placeholder="Descripci√≥n"></textarea>
                <div class="flex items-center gap-3"><input type="checkbox" id="suppActive" class="w-5 h-5 rounded" checked> <label class="text-sm font-bold uppercase italic">Fase Activa</label></div>
                <div class="flex gap-4 pt-4">
                    <button type="button" onclick="deleteCurrentSupp()" id="btn-delete-supp" class="bg-red-900/50 text-red-200 border border-red-800 p-4 rounded-xl flex-1 hidden transition-all">Borrar</button>
                    <button type="submit" class="bg-teal-600 hover:bg-teal-500 text-white p-4 rounded-xl flex-[2] font-bold uppercase transition-all shadow-lg">Guardar Registro</button>
                </div>
            </form>
        </div>
    </div>

    <nav class="fixed bottom-0 w-full bg-slate-900/98 backdrop-blur-3xl border-t border-slate-800 p-1 pb-10 z-50 flex justify-around shadow-[0_-20px_60px_rgba(0,0,0,0.98)]">
        <button onclick="switchTab('home')" id="btn-home" class="nav-btn active p-2 w-full flex flex-col items-center gap-1"><i data-lucide="home"></i></button>
        <button onclick="switchTab('ranking')" id="btn-ranking" class="nav-btn p-2 w-full flex flex-col items-center gap-1"><i data-lucide="trophy"></i></button>
        <button onclick="switchTab('plan')" id="btn-plan" class="nav-btn p-2 w-full flex flex-col items-center gap-1"><i data-lucide="calendar-days"></i></button>
        <button onclick="switchTab('running')" id="btn-running" class="nav-btn p-2 w-full flex flex-col items-center gap-1"><i data-lucide="footprints"></i></button>
        <button onclick="switchTab('strength')" id="btn-strength" class="nav-btn p-2 w-full flex flex-col items-center gap-1"><i data-lucide="dumbbell"></i></button>
        <button onclick="switchTab('supplements')" id="btn-supplements" class="nav-btn p-2 w-full flex flex-col items-center gap-1"><i data-lucide="pill"></i></button>
        <button onclick="switchTab('stats')" id="btn-stats" class="nav-btn p-2 w-full flex flex-col items-center gap-1"><i data-lucide="activity"></i></button>
        <button onclick="switchTab('profile')" id="btn-profile" class="nav-btn p-2 w-full flex flex-col items-center gap-1"><i data-lucide="user-circle"></i></button>
    </nav>

<script>
        // --- üî¥ CONFIGURACI√ìN DE FIREBASE üî¥ ---
        const firebaseConfig = {
            apiKey: "AIzaSyCa9FJBYgHvwzT_MT-bfsOTJSOnMxhmcss", 
            authDomain: "pepe-entrenamiento-2026.firebaseapp.com",
            projectId: "pepe-entrenamiento-2026",
            storageBucket: "pepe-entrenamiento-2026.firebasestorage.app",
            messagingSenderId: "725522983850",
            appId: "1:725522983850:web:909a18e2541bc99349d9d3"
        };
        // ----------------------------------------------------

        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        let currentUser = null;

        // Estado Global
        let runningChartInstance = null, weightChartInstance = null, vfcChartInstance = null, rhrChartInstance = null, sleepChartInstance = null, strengthChartInstance = null;
        let appData = {
            nickname: "Guerrero Z", group: "Global", targetWeight: 0,
            plan: [], strength: {}, running: [], progress: [], supplements: []
        };
        let galleryData = JSON.parse(localStorage.getItem('pepeGallery')) || []; 
        let currentWeekIndex = 0;
        let spyUsersCache = []; 
        let spyPendingWeek = null;

        // --- SISTEMA DE AUTENTICACI√ìN ---
        auth.onAuthStateChanged(user => {
            if (user) {
                currentUser = user;
                document.getElementById('auth-screen').classList.add('hidden');
                document.getElementById('user-email-display').innerText = user.email;
                loadDataFromCloud();
            } else {
                document.getElementById('auth-screen').classList.remove('hidden');
            }
        });

        document.getElementById('login-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const email = document.getElementById('auth-email').value, pass = document.getElementById('auth-pass').value, nick = document.getElementById('auth-nickname').value;
            const errorMsg = document.getElementById('auth-error'); errorMsg.classList.add('hidden');
            
            auth.signInWithEmailAndPassword(email, pass).catch(err => {
                if (['auth/user-not-found', 'auth/invalid-credential', 'auth/invalid-login-credentials'].includes(err.code)) {
                    const nickField = document.getElementById('register-nickname-field');
                    if (nickField.classList.contains('hidden')) { 
                        nickField.classList.remove('hidden'); 
                        errorMsg.innerText = "Usuario no detectado. Escribe un apodo y pulsa de nuevo para registrarte."; 
                        errorMsg.classList.remove('hidden'); return; 
                    }
                    auth.createUserWithEmailAndPassword(email, pass).then(() => initializeNewUser(nick || "Novato Z")).catch(e => {
                        errorMsg.innerText = e.code === 'auth/email-already-in-use' ? "Identidad registrada. Contrase√±a mal." : e.message;
                        errorMsg.classList.remove('hidden');
                    });
                } else { errorMsg.innerText = err.message; errorMsg.classList.remove('hidden'); }
            });
        });

        function logout() { auth.signOut().then(() => window.location.reload()); }

        // --- SINCRONIZACI√ìN NUBE ---
        async function loadDataFromCloud() {
            if (!currentUser) return;
            try {
                const doc = await db.collection('users').doc(currentUser.uid).get();
                if (doc.exists) {
                    const data = doc.data();
                    // Reparar labels undefined
                    if (data.plan) {
                        data.plan.forEach((w, i) => { if (!w.label || w.label === "undefined") w.label = `Ciclo Z ${i + 1}`; });
                    }
                    // Parche estructura
                    if (data.plan && data.plan.length > 0 && !data.plan[0].days) {
                         data.plan = [{ id: "rec-" + Date.now(), label: "Plan Maestro Recuperado", days: data.plan }];
                    }
                    appData = { ...appData, ...data };
                    if (!appData.plan || appData.plan.length === 0) appData.plan = [{ id: "w1", label: "Ciclo 1 (Inicio Maestro)", days: getDefaultPlan() }];
                    if (!appData.supplements || appData.supplements.length === 0) appData.supplements = getDefaultSupplements();
                } else { initializeNewUser(appData.nickname); }
                initAppUI(); loadLeaderboard(); updateExerciseSelector();
            } catch (error) { console.error("Error sincronizaci√≥n:", error); initAppUI(); }
        }

        function saveDataToCloud() {
            if (!currentUser) return;
            db.collection('users').doc(currentUser.uid).set(appData, { merge: true }).then(() => updateLeaderboardEntry());
        }

        function initializeNewUser(nick) {
            appData.nickname = nick || "Guerrero Z";
            appData.plan = [{ id: "w-init", label: "Semana 1 (Protocolo Inicial)", days: getDefaultPlan() }];
            appData.supplements = getDefaultSupplements();
            saveDataToCloud();
        }

        // --- CALENDARIO DIN√ÅMICO (TIEMPO REAL) ---
		function updateCalendarDates() {
            const today = new Date();
            const dayOfWeek = today.getDay(); 
            const diff = today.getDate() - dayOfWeek + (dayOfWeek === 0 ? -6 : 1);
            const monday = new Date(new Date().setDate(diff));

            const calendarDays = document.querySelectorAll('.calendar-day');
            calendarDays.forEach((el, i) => {
                const date = new Date(monday);
                date.setDate(monday.getDate() + i);
                const numSpan = el.querySelector('.day-num');
                if(numSpan) numSpan.innerText = date.getDate();
                
                // Marcar d√≠a actual
                el.classList.remove('active');
                if (i === (dayOfWeek === 0 ? 6 : dayOfWeek - 1)) {
                    el.classList.add('active');
                }
            });
        }

        function scrollToDay(idx) {
            const target = document.getElementById(`day-card-${idx}`);
            if(target) target.scrollIntoView({ behavior: "smooth", block: "center" });
        }

        // --- INICIALIZACI√ìN UI ---
        function initAppUI() {
            currentWeekIndex = Math.max(0, appData.plan.length - 1);
            document.getElementById('header-username').innerText = appData.nickname;
            updateCalendarDates();
            renderPlan(); 
            renderSupplements(); 
            updateHistoryTable(); 
            updateRunningUI(); 
            renderGallery();
            updateExerciseSelector();
            updateHomeMiniStats();
            switchTab('home');
			document.getElementById('profile-target').value = appData.targetWeight || "";
			document.getElementById('profile-injuries').value = appData.injuries || "";
        }

        function updateHomeMiniStats() {
            if(appData.progress.length > 0) {
                const s = [...appData.progress].sort((a,b)=>new Date(a.date)-new Date(b.date));
                const change = ((s[s.length-1].weight - s[0].weight) / s[0].weight) * 100;
                const el = document.getElementById('card-weight-change');
                if(el) {
                    el.innerText = (change >= 0 ? "+" : "") + change.toFixed(1) + "%";
                    el.className = change < 0 ? "text-xs font-bold text-green-400 scouter-font" : "text-xs font-bold text-red-400 scouter-font";
                }
				updateKiStatus(); // A√±adimos esto aqu√≠
            }
        }

        function renderPlan() {
            const s = document.getElementById('week-selector');
            if(appData.plan.length === 0) return;
            s.innerHTML = appData.plan.map((w, i) => `<option value="${i}" ${i === currentWeekIndex ? 'selected' : ''}>${w.label || "Protocolo"}</option>`).join('');
            
            if(!appData.plan[currentWeekIndex]) return;
            document.getElementById('plan-container').innerHTML = appData.plan[currentWeekIndex].days.map((day, dIdx) => {
                let color = day.type === 'gym' ? 'border-blue-500' : day.type === 'cardio' ? 'border-green-500' : 'border-purple-500';
                const exHtml = day.exercises.map((ex, eIdx) => {
                    const vid = ex.vid ? `<a href="${ex.vid}" target="_blank" class="text-pink-400 text-[10px] ml-2 border border-pink-500/30 rounded px-2 py-0.5 font-bold uppercase italic">Video</a>` : '';
                    let inputHtml = '';
                    if (ex.track) {
                        const sets = parseInt(ex.sets);
                        if (!isNaN(sets) && sets > 1 && sets < 10) {
                            const saved = (ex.weight || "").toString().split('/');
                            let boxes = '';
                            for(let i=0; i<sets; i++) boxes += `<input type="number" placeholder="kg" value="${saved[i]||''}" class="bg-slate-800 border-slate-600 rounded-lg w-10 text-center text-white text-xs py-1.5 mx-0.5 focus:border-yellow-400 outline-none" onchange="saveMultiSetWeight(${dIdx}, ${eIdx}, ${sets}, this)">`;
                            inputHtml = `<div class="flex flex-wrap justify-end items-center mt-2"><span class="text-[8px] text-slate-500 mr-2 font-bold italic uppercase">Kilos:</span>${boxes}</div>`;
                        } else {
                            inputHtml = `<input type="text" placeholder="KG" value="${ex.weight || ''}" class="bg-slate-800 border-slate-600 rounded-lg w-16 text-center text-white text-xs py-2 focus:border-yellow-500 outline-none" onchange="saveWeight(${dIdx}, ${eIdx}, this.value)">`;
                        }
                    }
                    return `<div class="py-3 border-b border-slate-800/50 flex flex-col sm:flex-row sm:items-start justify-between group hover:bg-slate-800/10 rounded-xl px-1 transition-colors"><div class="flex-1"><div><span class="text-white font-bold text-sm uppercase italic">${ex.name}</span>${vid}</div><div class="text-[11px] text-blue-300 font-mono mt-0.5">${ex.sets} x ${ex.reps}</div><div class="text-[10px] text-slate-500 italic mt-1 leading-tight">${ex.desc || ''}</div></div>${inputHtml}</div>`;
                }).join('');
                return `<div id="day-card-${dIdx}" class="glass rounded-3xl shadow-lg border-l-4 ${color} mb-5 anime-border overflow-hidden transition-all"><div class="p-4 bg-slate-900/80 flex justify-between items-center border-b border-slate-800 shadow-sm"><h3 class="font-bold text-white text-[12px] uppercase tracking-widest italic">${day.day} | ${day.title}</h3><button onclick="editDay(${dIdx})" class="p-2 hover:bg-slate-700 rounded-xl transition-all text-slate-500 hover:text-white"><i data-lucide="edit-3" class="w-4 h-4"></i></button></div><div class="p-3 bg-slate-900/20">${exHtml}${day.notes ? `<div class="mt-3 text-[10px] text-yellow-200 bg-yellow-900/30 p-3 rounded-xl border border-yellow-500/10 flex gap-2 italic"><i data-lucide="sticky-note" class="w-4 h-4 mt-0.5 flex-shrink-0 text-yellow-500"></i>${day.notes}</div>` : ''}</div></div>`;
            }).join('');
            lucide.createIcons();
        }
		function changeWeek() {
            const selector = document.getElementById('week-selector');
            currentWeekIndex = parseInt(selector.value);
            renderPlan();
            // Esto hace que al cambiar de semana, el calendario se actualice visualmente
            updateCalendarDates(); 
        }

        // --- FUERZA ---
        function saveMultiSetWeight(d, e, s, el) {
            const inputs = el.parentElement.querySelectorAll('input');
            const vals = Array.from(inputs).map(i => i.value);
            const maxVal = Math.max(...vals.map(v => parseFloat(v)||0));
            appData.plan[currentWeekIndex].days[d].exercises[e].weight = vals.join('/');
            if(maxVal > 0) saveStrengthRecord(appData.plan[currentWeekIndex].days[d].exercises[e].name, maxVal);
            saveDataToCloud();
        }
        function saveWeight(d, e, v) {
            appData.plan[currentWeekIndex].days[d].exercises[e].weight = v;
            const n = parseFloat(v); if(!isNaN(n) && n > 0) saveStrengthRecord(appData.plan[currentWeekIndex].days[d].exercises[e].name, n);
            saveDataToCloud();
        }
        function saveStrengthRecord(n, w) {
            if(!appData.strength[n]) appData.strength[n] = [];
            const today = new Date().toISOString().split('T')[0];
            const existing = appData.strength[n].find(e => e.date === today);
            if(existing) existing.weight = w; else appData.strength[n].push({ date: today, weight: w });
            updateExerciseSelector(); updatePRs();
        }
        function updateExerciseSelector() {
            const select = document.getElementById('exercise-select'); if(!select) return;
            const keys = Object.keys(appData.strength).sort();
            const defaults = ["Prensa de Piernas", "Jal√≥n al Pecho", "Press Pecho M√°quina", "Extensi√≥n Cu√°driceps", "Curl Femoral", "Face Pull"];
            const all = [...new Set([...defaults, ...keys])];
            const curr = select.value;
            select.innerHTML = all.map(k => `<option value="${k}" ${k===curr?'selected':''}>${k}</option>`).join('');
            if(!curr) renderStrengthChart();
        }
        function renderStrengthChart() {
            const select = document.getElementById('exercise-select'); if(!select) return;
            const data = (appData.strength[select.value] || []).sort((a,b) => new Date(a.date) - new Date(b.date));
            const canvas = document.getElementById('chartStrength'); if(!canvas) return;
            const ctx = canvas.getContext('2d'); if(strengthChartInstance) strengthChartInstance.destroy();
            strengthChartInstance = new Chart(ctx, { type: 'line', data: { labels: data.map(d=>d.date.slice(5)), datasets: [{ label: 'POTENCIA (KG)', data: data.map(d=>d.weight), borderColor: '#60a5fa', tension: 0.3, fill: true, backgroundColor: 'rgba(59,130,246,0.15)', pointBackgroundColor: '#fbbf24' }] }, options: { maintainAspectRatio: false, plugins: { legend: { display: false } } } });
        }
        function updatePRs() {
            const list = document.getElementById('pr-list'); if(!list) return;
            list.innerHTML = Object.keys(appData.strength).sort().map(k => {
                const max = Math.max(...appData.strength[k].map(d=>parseFloat(d.weight)||0));
                return max > 0 ? `<div class="flex justify-between items-center border-b border-slate-800 pb-2 mb-2 group hover:bg-slate-800/20 px-2 rounded-lg transition-all"><span class="text-slate-400 font-bold uppercase tracking-widest text-[10px] italic">${k}</span><span class="text-white font-bold scouter-font text-2xl tracking-tighter drop-shadow-md">${max}<span class="text-[10px] text-yellow-500 ml-1 font-sans">KG</span></span></div>` : '';
            }).join('');
        }

		// --- SALUD Y KI (CORREGIDO) ---
        document.getElementById('entryForm').addEventListener('submit', e => {
            e.preventDefault();
            const newEntry = {
                date: document.getElementById('inputDate').value,
                weight: parseFloat(document.getElementById('inputWeight').value),
                vfc: parseFloat(document.getElementById('inputVfc').value),
                rhr: parseFloat(document.getElementById('inputRhr').value) || 0,
                sleep: parseFloat(document.getElementById('inputSleep').value) || 0
            };
            
            appData.progress.push(newEntry);
            saveDataToCloud(); 
            updateHistoryTable(); 
            e.target.reset();
            document.getElementById('inputDate').valueAsDate = new Date();
            alert("‚úÖ Diagn√≥stico vital sincronizado.");
        });

		function updateHistoryTable() {
            const sorted = [...appData.progress].sort((a,b) => new Date(b.date) - new Date(a.date));
            const tbody = document.getElementById('historyTableBody'); 
            if(!tbody) return;

            tbody.innerHTML = sorted.map((r, i) => `
                <tr class="border-b border-slate-800 hover:bg-slate-800/40 transition-colors">
                    <td class="px-2 py-4 font-mono text-slate-400 text-[10px] font-bold uppercase">${r.date.slice(5)}</td>
                    <td class="px-2 py-4 font-bold text-white text-base">${r.weight}kg</td>
                    <td class="px-2 py-4 text-green-400 font-bold">${r.vfc}</td>
                    <td class="px-2 py-4 text-red-400 font-bold">${r.rhr || '-'}</td>
                    <td class="px-2 py-4 text-right">
                        <button onclick="delProg(${i})" class="text-slate-600 hover:text-red-500 p-2"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                    </td>
                </tr>`).join('');
            
            lucide.createIcons(); 
            renderStatsCharts(); // Esto dibuja las 4 gr√°ficas autom√°ticamente
        }

        function renderStatsCharts() {
            const data = [...appData.progress].sort((a,b) => new Date(a.date) - new Date(b.date));
            const lbs = data.map(d => d.date.slice(5));

            const build = (id, label, set, col) => {
                const canvas = document.getElementById(id); if(!canvas) return;
                const ctx = canvas.getContext('2d'); 
                if(window[id+'Inst']) window[id+'Inst'].destroy();
                window[id+'Inst'] = new Chart(ctx, { 
                    type: 'line', 
                    data: { labels: lbs, datasets: [{ label, data: set, borderColor: col, backgroundColor: col+'15', fill: true, tension: 0.3 }] }, 
                    options: { maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { display: false }, y: { ticks: { color: '#64748b', font: { size: 8 } } } } } 
                });
            };

            build('chartWeight', 'Peso', data.map(d=>d.weight), '#3b82f6');
            build('chartVfc', 'VFC', data.map(d=>d.vfc), '#22c55e');
            build('chartRhr', 'PPM', data.map(d=>d.rhr), '#ef4444');
            build('chartSleep', 'Sue√±o', data.map(d=>d.sleep), '#a855f7');
        }
        function delProg(i) { if(confirm("¬øBorrar?")) { const sorted=[...appData.progress].sort((a,b)=>new Date(b.date)-new Date(a.date)); const realIdx=appData.progress.indexOf(sorted[i]); if(realIdx>-1){ appData.progress.splice(realIdx,1); saveDataToCloud(); updateHistoryTable(); } } }

        // --- SUPLEMENTOS (PROTOCOLO KI) ---
        function renderSupplements() {
            const c = document.getElementById('supplements-list'); if(!c) return;
            if(!appData.supplements.length) { c.innerHTML='<p class="text-slate-500 text-center italic py-10 opacity-50">Pulsa "+" para registrar suministros de Ki.</p>'; return; }
            const trans = { 'morning':'Ma√±ana', 'workout':'Entrenamiento', 'meal':'Comida', 'night':'Noche' };
            c.innerHTML = appData.supplements.map(s => `<div class="bg-slate-900/60 border border-slate-800 rounded-3xl p-5 relative mb-4 ${s.active?'':'opacity-40 grayscale'}"><div class="flex justify-between items-start mr-8"><div><h4 class="font-bold text-white text-base uppercase italic tracking-wider">${s.name}</h4><div class="text-[11px] text-teal-400 font-mono font-black mt-1 uppercase italic">${s.dose}</div></div><span class="text-[9px] px-3 py-1 border rounded-full uppercase font-black text-teal-300 border-teal-500/50 bg-teal-900/40">${trans[s.timing] || s.timing}</span></div><p class="text-[10px] text-slate-500 mt-4 leading-relaxed italic">${s.desc}</p><button onclick="openSuppModal('${s.id}')" class="absolute top-5 right-5 text-slate-600 hover:text-white transition-all transform active:scale-75 p-2"><i data-lucide="edit-2" class="w-5 h-5"></i></button></div>`).join('');
            lucide.createIcons();
        }

        function openSuppModal(id) {
            document.getElementById('suppForm').reset();
            document.getElementById('suppId').value = id || '';
            const s = id ? appData.supplements.find(i=>i.id===id) : null;
            if(s) {
                document.getElementById('suppName').value=s.name; document.getElementById('suppDose').value=s.dose; 
                document.getElementById('suppTiming').value=s.timing; document.getElementById('suppDesc').value=s.desc;
                document.getElementById('suppActive').checked=s.active;
                document.getElementById('btn-delete-supp').classList.remove('hidden');
            } else {
                document.getElementById('suppActive').checked=true;
                document.getElementById('btn-delete-supp').classList.add('hidden');
            }
            document.getElementById('supp-modal').classList.remove('hidden');
        }
        function closeSuppModal() { document.getElementById('supp-modal').classList.add('hidden'); }
        function deleteCurrentSupp() { const id=document.getElementById('suppId').value; if(confirm("¬øBorrar?")){ appData.supplements=appData.supplements.filter(s=>s.id!==id); saveDataToCloud(); renderSupplements(); closeSuppModal(); } }
        document.getElementById('suppForm').addEventListener('submit', e=>{
            e.preventDefault(); const id=document.getElementById('suppId').value;
            const obj={ id:id||"s"+Date.now(), name:document.getElementById('suppName').value, dose:document.getElementById('suppDose').value, timing:document.getElementById('suppTiming').value, desc:document.getElementById('suppDesc').value, active:document.getElementById('suppActive').checked };
            if(id) { const i=appData.supplements.findIndex(x=>x.id===id); if(i>-1) appData.supplements[i]=obj; } else { appData.supplements.push(obj); }
            saveDataToCloud(); renderSupplements(); closeSuppModal();
        });

        // --- ESP√çA (SHARINGAN) ---
		async function openSpyModal() {
            const l = document.getElementById('spy-user-list');
            l.innerHTML = '<span class="text-xs animate-pulse p-4">Escaneando guerreros...</span>';
            document.getElementById('spy-modal').classList.remove('hidden');

            try {
                // Buscamos a todos los usuarios en la tabla de ranking
                const snap = await db.collection('leaderboard').get();
                spyUsersCache = [];
                snap.forEach(doc => { 
                    if(doc.id !== currentUser.uid) {
                        spyUsersCache.push({id: doc.id, name: doc.data().nickname}); 
                    }
                });
                
                l.innerHTML = spyUsersCache.map(u => `
                    <button onclick="loadSpyPlan('${u.id}')" class="bg-slate-800 text-slate-300 border border-slate-700 px-6 py-4 rounded-2xl text-[10px] whitespace-nowrap hover:bg-purple-900 transition-all font-bold uppercase italic tracking-widest">
                        ${u.name}
                    </button>
                `).join('') || '<span class="text-xs text-slate-500 italic p-4">No hay se√±ales de otros clanes.</span>';
            } catch(e) {
                console.error(e);
                l.innerHTML = '<span class="text-red-500 text-xs p-4">Fallo en el radar.</span>';
            }
        }
        function closeSpyModal() { document.getElementById('spy-modal').classList.add('hidden'); }

        async function loadSpyPlan(uid) {
            const container = document.getElementById('spy-weeks-container');
            container.innerHTML = '<p class="text-center animate-pulse text-purple-400 text-xs font-bold uppercase mt-20 tracking-widest italic">Interceptando se√±al remota...</p>';
            try {
                const doc = await db.collection('users').doc(uid).get();
                if(doc.exists && doc.data().plan) {
                    container.innerHTML = doc.data().plan.map(w => `
                        <div class="bg-slate-900/70 border border-slate-800 p-5 rounded-2xl flex justify-between items-center mb-4 shadow-xl border-l-4 border-purple-500/50">
                            <p class="text-white text-xs font-bold uppercase italic tracking-tighter">${w.label || "T√°ctica"}</p>
                            <div class="flex gap-3">
                                <button onclick='previewSpyWeek(${JSON.stringify(w).replace(/'/g,"&#39;")})' class="bg-blue-600/30 text-blue-200 px-4 py-2 rounded-xl text-[10px] border border-blue-500/40 hover:bg-blue-600 font-bold uppercase transition-all italic">Ojeada</button>
                                <button onclick='copySpyWeek(${JSON.stringify(w).replace(/'/g,"&#39;")})' class="bg-green-700/80 text-white px-4 py-2 rounded-xl text-[10px] font-bold hover:bg-green-600 uppercase transition-all italic shadow-lg">Clonar</button>
                            </div>
                        </div>`).join('');
                } else container.innerHTML = '<p class="text-red-400 text-center text-[10px] uppercase font-bold mt-20">Terminal encriptado.</p>';
            } catch(e) { container.innerHTML = '<p class="text-red-400 text-center text-xs mt-20 uppercase">Fallo de enlace.</p>'; }
        }
        function previewSpyWeek(w) {
            spyPendingWeek = w;
            document.getElementById('spy-preview-content').innerHTML = w.days.map(d => `<div class="border-b border-slate-900 pb-3 mb-3"><p class="text-yellow-400 font-bold text-[11px] uppercase italic tracking-widest mb-1">${d.day}: ${d.title}</p><ul class="text-[10px] text-slate-400 list-disc ml-5 space-y-1">${d.exercises.map(e => `<li><span class="text-slate-200">${e.name}</span> <span class="text-[9px] text-blue-400 font-mono ml-1">(${e.sets}x${e.reps})</span></li>`).join('')}</ul></div>`).join('');
            document.getElementById('spy-preview-modal').classList.remove('hidden');
        }
        function closeSpyPreview() { document.getElementById('spy-preview-modal').classList.add('hidden'); spyPendingWeek = null; }
        document.getElementById('btn-copy-preview').onclick = () => { if(spyPendingWeek) copySpyWeek(spyPendingWeek); };
        function copySpyWeek(w) {
            if(confirm(`¬øClonar "${w.label}"?`)){
                const nw = JSON.parse(JSON.stringify(w)); nw.id = "clon-" + Date.now(); nw.label = (nw.label || "Semana") + " (Copia)"; appData.plan.push(nw);
                saveDataToCloud(); alert("Protocolo clonado."); closeSpyPreview(); closeSpyModal(); changeWeek();
            }
        }

        // --- IA PROMPT MAESTRO ---
function copyPrompt() {
            // VALIDACI√ìN: ¬øTiene meta de peso y lesiones?
            if (!appData.targetWeight || appData.targetWeight <= 0 || !appData.injuries) {
                alert("‚ö†Ô∏è ¬°ERROR DE PROTOCOLO!\n\nAntes de hablar con la IA, debes ir a la pesta√±a PERFIL (icono de usuario) y configurar tu Meta de Peso y tus Lesiones/Notas M√©dicas.");
                switchTab('profile'); // Lo mandamos autom√°ticamente a la pesta√±a de perfil
                return;
            }

            const today = new Date(); 
            const nm = new Date(today); 
            nm.setDate(today.getDate() + ((1+7-today.getDay())%7||7)); 
            const ns = new Date(nm); 
            ns.setDate(nm.getDate()+6);
            const dStr = `${nm.toLocaleDateString('es-ES', { day: 'numeric', month: 'long' })} al ${ns.toLocaleDateString('es-ES', { day: 'numeric', month: 'long' })}`;
            
            const ultimoPeso = appData.progress.length > 0 ? appData.progress[appData.progress.length-1].weight : "No registrado";
            const misSupps = appData.supplements.map(s => s.name).join(", ");

            const prompt = `Act√∫a como mi entrenador personal Saiyan experto en biomec√°nica. Genera el c√≥digo JSON para mi pr√≥xima semana de entrenamiento: del ${dStr}.

DATOS CR√çTICOS DEL ATLETA:
- Peso Actual: ${ultimoPeso} kg.
- Meta de Peso: ${appData.targetWeight} kg.
- Lesiones/Limitaciones: ${appData.injuries}.
- Suplementaci√≥n: ${misSupps}.

REGLAS OBLIGATORIAS: Responde SOLO con el c√≥digo JSON. Genera 7 d√≠as. Usa "track": true en pesas. Adapta la rutina para NO agravar mis lesiones mencionadas.

ESTRUCTURA: { "id": "tactica-${Date.now()}", "label": "Semana X: [T√≠tulo]", "days": [...] }`;

            navigator.clipboard.writeText(prompt).then(() => alert("‚úÖ ¬°COMANDO MAESTRO COPIADO!\n\nP√©galo en Gemini ahora. Tus lesiones y metas van incluidas."));
        }

        // --- UTILS RESTANTES ---
function switchTab(id) {
            // 1. Ocultar todas las pesta√±as con doble seguridad (clase propia y tailwind)
            document.querySelectorAll('.tab-content').forEach(e => {
                e.classList.add('hidden-tab');
                e.classList.add('hidden'); 
            });
            // 2. Quitar estado activo de todos los botones de navegaci√≥n
            document.querySelectorAll('.nav-btn').forEach(e => e.classList.remove('active')); 
            
            // 3. Mostrar la pesta√±a seleccionada
            const target = document.getElementById(`tab-${id}`);
            if(target) {
                target.classList.remove('hidden-tab');
                target.classList.remove('hidden');
            }
            
            // 4. Activar el bot√≥n correspondiente en el men√∫
            const btn = document.getElementById(`btn-${id}`); 
            if(btn) btn.classList.add('active'); 

            // 5. Cargas autom√°ticas de datos al entrar en la pesta√±a
            if(id==='strength') { renderStrengthChart(); updatePRs(); }
            if(id==='running') updateRunningUI();
            if(id==='stats') updateHistoryTable(); // Esto activa las 4 gr√°ficas de salud
            if(id==='ranking') loadLeaderboard();
            if(id==='supplements') renderSupplements();
            if(id==='home') updateHomeMiniStats();
            if(id==='profile') { 
                document.getElementById('profile-target').value = appData.targetWeight || "";
                document.getElementById('profile-injuries').value = appData.injuries || "";
            }
            lucide.createIcons();
        }

        function updateHistoryTable() {
            const tbody = document.getElementById('historyTableBody'); 
            if(!tbody) return;
            const sorted = [...appData.progress].sort((a,b) => new Date(b.date) - new Date(a.date));

            tbody.innerHTML = sorted.map((r, i) => `
                <tr class="border-b border-slate-800 hover:bg-slate-800/40 transition-colors">
                    <td class="px-2 py-4 font-mono text-slate-400 text-[10px] font-bold uppercase">${r.date.slice(5)}</td>
                    <td class="px-2 py-4 font-bold text-white text-base text-center">${r.weight}kg</td>
                    <td class="px-2 py-4 text-green-400 font-bold text-center">${r.vfc}</td>
                    <td class="px-2 py-4 text-red-400 font-bold text-center">${r.rhr || '-'}</td>
                    <td class="px-2 py-4 text-right">
                        <button onclick="delProg(${i})" class="text-slate-600 hover:text-red-500 p-2"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                    </td>
                </tr>`).join('');
            
            lucide.createIcons(); 
            renderStatsCharts();
        }

        function renderStatsCharts() {
            const data = [...appData.progress].sort((a,b) => new Date(a.date) - new Date(b.date));
            if (data.length === 0) return;
            const lbs = data.map(d => d.date.slice(5));

            const build = (id, label, set, col) => {
                const canvas = document.getElementById(id); if(!canvas) return;
                const ctx = canvas.getContext('2d'); 
                if(window[id+'Inst']) window[id+'Inst'].destroy();
                window[id+'Inst'] = new Chart(ctx, { 
                    type: 'line', 
                    data: { labels: lbs, datasets: [{ label, data: set, borderColor: col, backgroundColor: col+'15', fill: true, tension: 0.3, pointRadius: 2 }] }, 
                    options: { maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { display: false }, y: { ticks: { color: '#64748b', font: { size: 8 } } } } } 
                });
            };

            build('chartWeight', 'Peso', data.map(d=>d.weight), '#3b82f6');
            build('chartVfc', 'VFC', data.map(d=>d.vfc), '#22c55e');
            build('chartRhr', 'PPM', data.map(d=>d.rhr), '#ef4444');
            build('chartSleep', 'Sue√±o', data.map(d=>d.sleep), '#a855f7');
        }

        // --- VALIDACI√ìN DE SEGURIDAD PARA EL COMANDO IA ---
        function copyPrompt() {
            // Si el usuario no ha puesto meta o lesiones, le obligamos
            if (!appData.targetWeight || appData.targetWeight <= 0 || !appData.injuries) {
                alert("‚ö†Ô∏è ¬°BLOQUEO DE SEGURIDAD!\n\nAntes de generar tu comando, debes ir a la pesta√±a PERFIL (icono de usuario) y rellenar tu Meta de Peso y tus Lesiones (ej: esguince).");
                switchTab('profile'); 
                return;
            }

            const today = new Date(); 
            const dStr = today.toLocaleDateString('es-ES', { day: 'numeric', month: 'long' });
            const ultimoPeso = appData.progress.length > 0 ? appData.progress[appData.progress.length-1].weight : "No registrado";
            const misSupps = appData.supplements.map(s => s.name).join(", ");

            const prompt = `Act√∫a como mi entrenador personal Saiyan experto en biomec√°nica. Genera el c√≥digo JSON para mi pr√≥xima semana de entrenamiento a partir del ${dStr}.

DATOS CR√çTICOS:
- Peso Actual: ${ultimoPeso} kg.
- Meta de Peso: ${appData.targetWeight} kg.
- Lesiones: ${appData.injuries}.
- Suplementos: ${misSupps}.

REGLAS: Responde SOLO con el c√≥digo JSON. Genera 7 d√≠as. Usa "track": true en pesas. Adapta la rutina para NO agravar mi lesi√≥n de ${appData.injuries}.

ESTRUCTURA: { "id": "tactica-${Date.now()}", "label": "Semana de Poder", "days": [...] }`;

            navigator.clipboard.writeText(prompt).then(() => alert("‚úÖ ¬°COMANDO COPIADO!\n\nP√©galo en Gemini ahora. Tus datos de salud y lesiones han sido incluidos autom√°ticamente."));
        }
        function toggleSettings() { document.getElementById('settings-panel').classList.toggle('hidden'); }
        function changeNickname() { const n=prompt("Nuevo apodo:", appData.nickname); if(n){ appData.nickname=n; document.getElementById('header-username').innerText=n; saveDataToCloud(); } }
        function changeGroup() { const g=prompt("Nuevo clan:", appData.group); if(g){ appData.group=g.trim(); saveDataToCloud(); loadLeaderboard(); } }
        function resetDefaultPlan() { if(confirm("¬øRestaurar plan inicial?")){ appData.plan = [{id:"w-res-"+Date.now(), label:"Semana 1 (Inicio)", days:getDefaultPlan()}]; saveDataToCloud(); renderPlan(); } }
        function editDay(i) { const n=prompt("Notas t√°cticas de campo:", appData.plan[currentWeekIndex].days[i].notes); if(n!==null){ appData.plan[currentWeekIndex].days[i].notes=n; saveDataToCloud(); renderPlan(); } }
        
		function editDay(i) { 
            const n = prompt("Notas t√°cticas de campo:", appData.plan[currentWeekIndex].days[i].notes); 
            if(n !== null) { 
                appData.plan[currentWeekIndex].days[i].notes = n; 
                saveDataToCloud(); 
                renderPlan(); 
            } 
        }
		function updateProfileData() {
            appData.targetWeight = parseFloat(document.getElementById('profile-target').value) || 0;
            appData.injuries = document.getElementById('profile-injuries').value || "";
            saveDataToCloud(); // Guarda autom√°ticamente en Firebase
        }
		function importNewWeek() { 
            try { 
                let text = document.getElementById('import-code-area').value.trim();
                // Limpiar posibles bloques de c√≥digo Markdown de la IA (```json ... ```)
                text = text.replace(/```json/g, "").replace(/```/g, "").trim();
                
                const w = JSON.parse(text); 
                if(!w.days) throw new Error("Formato inv√°lido"); 
                
                // Forzar un nombre legible para evitar el 'undefined'
                w.label = w.label || w.title || `Ciclo Z ${appData.plan.length + 1}`;
                w.id = w.id || "tactica-" + Date.now();

                appData.plan.push(w); 
                saveDataToCloud(); 
                currentWeekIndex = appData.plan.length - 1; 
                renderPlan(); 
                toggleSettings(); 
                document.getElementById('import-code-area').value = "";
                alert("‚úÖ ¬°Plan Maestro Importado!"); 
            } catch(e) { 
                alert("‚ùå ERROR: El c√≥digo JSON es incorrecto o est√° incompleto."); 
            } 
        }

        function deleteCurrentWeek() {
            if (appData.plan.length <= 1) {
                alert("No puedes borrar el √∫ltimo protocolo. El sistema requiere al menos un plan activo.");
                return;
            }
            if (confirm(`¬øEliminar permanentemente "${appData.plan[currentWeekIndex].label}"?`)) {
                appData.plan.splice(currentWeekIndex, 1);
                currentWeekIndex = Math.max(0, currentWeekIndex - 1);
                saveDataToCloud();
                renderPlan();
                toggleSettings();
                alert("Ciclo eliminado.");
            }
        }

        function resetDefaultPlan() {
            if(confirm("¬øRestaurar plan inicial? Se borrar√°n todos tus ciclos actuales.")){ 
                appData.plan = [{id:"w-res-"+Date.now(), label:"Semana 1 (Inicio)", days:getDefaultPlan()}]; 
                currentWeekIndex = 0;
                saveDataToCloud(); 
                renderPlan(); 
                toggleSettings();
            } 
        }
        function getDefaultPlan() {
            return [
                { id: "d1", day: "Lunes", title: "Empuje (Pierna)", type: "gym", exercises: [{ name: "Prensa de Piernas", sets: "3", reps: "12", track: true }, { name: "Extensi√≥n Cu√°driceps", sets: "3", reps: "15", track: true }] },
                { id: "d2", day: "Martes", title: "Cardio Z2", type: "cardio", exercises: [{ name: "Bici Est√°tica", sets: "45min", reps: "Z2", track: false }] },
                { id: "d3", day: "Mi√©rcoles", title: "Torso Maestro", type: "gym", exercises: [{ name: "Jal√≥n al Pecho", sets: "3", reps: "12", track: true }, { name: "Press Pecho M√°quina", sets: "3", reps: "12", track: true }] },
                { id: "d4", day: "Jueves", title: "Reparaci√≥n Activa", type: "rest", exercises: [{ name: "Caminar", sets: "30min", reps: "Suave", track: false }] },
                { id: "d5", day: "Viernes", title: "Protocolo Ca-Co", type: "run", exercises: [{ name: "Trote Z", sets: "20min", reps: "Bloque", track: false, desc: "1' trote / 2' camina." }] },
                { id: "d6", day: "S√°bado", title: "Movilidad Cadera", type: "rest", exercises: [{ name: "Estiramientos", sets: "20min", reps: "Total", track: false }] },
                { id: "d7", day: "Domingo", title: "Auditor√≠a Vital", type: "rest", exercises: [{ name: "Peso + VFC", sets: "-", reps: "-", track: false }] }
            ];
        }
        function getDefaultSupplements() { return [{ id: '1', name: 'Prote√≠na Whey Isolate', dose: '1 Scoop (30g)', timing: 'workout', active: true, desc: 'Reparaci√≥n de Ki.' }, { id: '2', name: 'Omega 3 EPA/DHA', dose: '2 Perlas', timing: 'meal', active: true, desc: 'Salud cardiovascular.' }, { id: '3', name: 'Magnesio Bisglicinato', dose: '2 C√°psulas', timing: 'night', active: true, desc: 'Reparaci√≥n profunda.' }]; }

        async function loadLeaderboard() { 
            try { 
                const snap = await db.collection('leaderboard').get(); const users = []; spyUsersCache = []; const cg = appData.group || "Global";
                document.getElementById('ranking-group-name').innerText = cg;
                snap.forEach(doc => { const d = doc.data(); if(d.group === cg) { users.push({...d, id:doc.id}); spyUsersCache.push({id:doc.id, name:d.nickname}); } });
                users.sort((a,b) => parseFloat(a.weightChange) - parseFloat(b.weightChange));
                document.getElementById('rankingTableBody').innerHTML = users.map((u,i) => `<tr class="border-b border-blue-900/20"><td>#${i+1}</td><td class="${u.id===currentUser.uid?'text-yellow-400 font-bold':''}">${u.nickname}</td><td class="text-center">${u.weightChange}%</td><td class="text-center font-bold text-yellow-200">${u.maxBench||0}</td><td class="text-center font-bold text-yellow-200">${u.maxLegPress||0}</td></tr>`).join('');
            } catch(e) {}
        }
        function updateLeaderboardEntry() { if(!currentUser)return; let c=0; let mb=0; let ml=0; if(appData.progress.length>1){ const s=[...appData.progress].sort((a,b)=>new Date(a.date)-new Date(b.date)); c=((s[s.length-1].weight-s[0].weight)/s[0].weight)*100; } if(appData.strength["Press Pecho M√°quina"]) mb = Math.max(...appData.strength["Press Pecho M√°quina"].map(x=>parseFloat(x.weight)||0)); if(appData.strength["Prensa de Piernas"]) ml = Math.max(...appData.strength["Prensa de Piernas"].map(x=>parseFloat(x.weight)||0)); db.collection('leaderboard').doc(currentUser.uid).set({ nickname: appData.nickname, group: appData.group, weightChange: c.toFixed(1), maxBench: mb, maxLegPress: ml, lastUpdate: new Date() }, {merge:true}); }
        function updateRunningUI() {
            const s = [...appData.running].sort((a,b)=>new Date(b.date)-new Date(a.date));
            document.getElementById('runningTableBody').innerHTML = s.map((r,i)=>`<tr class="border-b border-slate-800"><td class="text-slate-400 p-2 text-[10px] font-black italic uppercase">${r.date.slice(5)}</td><td class="text-white font-bold">${r.dist}km</td><td class="text-slate-400 text-xs">${r.time}min</td><td class="text-orange-400 font-bold">${Math.floor(r.pace)}'${Math.round((r.pace%1)*60)}"</td><td class="text-right p-2"><button onclick="delRun(${i})" class="text-red-900"><i data-lucide="trash-2" class="w-3"></i></button></td></tr>`).join('');
            lucide.createIcons();
            const rev = [...s].reverse(); if(rev.length && document.getElementById('chartRunning')) {
                if(runningChartInstance) runningChartInstance.destroy();
                runningChartInstance = new Chart(document.getElementById('chartRunning').getContext('2d'), {type:'line', data:{labels:rev.map(d=>d.date.slice(5)), datasets:[{label:'RITMO', data:rev.map(d=>d.pace), borderColor:'#f97316', tension:0.3, fill:true, backgroundColor:'rgba(249,115,22,0.1)'}]}, options:{maintainAspectRatio:false, scales:{y:{reverse:true, grid:{color:'rgba(255,255,255,0.05)'}}, x:{grid:{display:false}}}}});
            }
        }
        function delRun(i) { if(confirm("¬øBorrar?")){ const s=[...appData.running].sort((a,b)=>new Date(b.date)-new Date(a.date)); const realIdx=appData.running.indexOf(s[i]); if(realIdx>-1){appData.running.splice(realIdx,1); saveDataToCloud(); updateRunningUI();} } }
        function handlePhotoUpload(input) { const f = input.files[0]; if(!f) return; const r = new FileReader(); r.onload = e => { const img = new Image(); img.onload = () => { const c = document.createElement('canvas'); const ctx = c.getContext('2d'); const max = 800; let w = img.width, h = img.height; if(w > max){ h *= max/w; w = max; } c.width = w; c.height = h; ctx.drawImage(img, 0, 0, w, h); galleryData.unshift({ date: new Date().toISOString().split('T')[0], img: c.toDataURL('image/jpeg', 0.8) }); localStorage.setItem('pepeGallery', JSON.stringify(galleryData)); renderGallery(); }; img.src = e.target.result; }; r.readAsDataURL(f); }
        function renderGallery() { const g = document.getElementById('gallery-grid'); if(!g) return; if(!galleryData.length) { g.innerHTML='<p class="text-[10px] text-slate-600 text-center col-span-2 uppercase font-black italic mt-10 opacity-40">Sin archivos visuales.</p>'; return; } g.innerHTML = galleryData.map((x,i) => `<div class="relative group overflow-hidden rounded-2xl shadow-xl"><img src="${x.img}" class="w-full h-40 object-cover transition-transform duration-500 group-hover:scale-110" onclick="window.open('${x.img}')"><button onclick="delPhoto(${i})" class="absolute top-2 right-2 bg-black/60 text-white rounded-lg p-2 opacity-0 group-hover:opacity-100 transition-opacity"><i data-lucide="trash-2" class="w-4 h-4"></i></button></div>`).join(''); lucide.createIcons(); }
        function delPhoto(i) { if(confirm("¬øBorrar?")){ galleryData.splice(i,1); localStorage.setItem('pepeGallery', JSON.stringify(galleryData)); renderGallery(); } }
// LOGICA DE GUARDADO DE RUNNING
        document.getElementById('runForm').addEventListener('submit', e => {
            e.preventDefault();
            const dist = parseFloat(document.getElementById('runDist').value);
            const time = parseFloat(document.getElementById('runTime').value);
            if(isNaN(dist) || isNaN(time) || dist <= 0) return alert("Introduce datos v√°lidos");
            
            const pace = time / dist; 

            appData.running.push({
                date: document.getElementById('runDate').value,
                dist: dist,
                time: time,
                pace: pace
            });

            saveDataToCloud();
            updateRunningUI();
            e.target.reset();
            document.getElementById('runDate').valueAsDate = new Date();
            alert("üèÉ Sesi√≥n de running registrada.");
        });
		function updateProfileData() {
            appData.targetWeight = parseFloat(document.getElementById('profile-target').value) || 0;
            appData.injuries = document.getElementById('profile-injuries').value || "";
            saveDataToCloud();
        }
		function closeSpyModal() { document.getElementById('spy-modal').classList.add('hidden'); }
        function closeSpyPreview() { document.getElementById('spy-preview-modal').classList.add('hidden'); spyPendingWeek = null; }
        // Corregir espiar
        async function loadSpyPlan(uid) {
            const container = document.getElementById('spy-weeks-container');
            container.innerHTML = '<p class="text-center animate-pulse py-10">Interceptando se√±al...</p>';
            try {
                const doc = await db.collection('users').doc(uid).get();
                if(doc.exists && doc.data().plan) {
                    container.innerHTML = doc.data().plan.map(w => `
                        <div class="bg-slate-800/70 p-4 rounded-xl flex justify-between items-center mb-3 border border-slate-700">
                            <span class="text-white font-bold text-sm">${w.label || "Protocolo"}</span>
                            <div class="flex gap-2">
                                <button onclick='previewSpyWeek(${JSON.stringify(w).replace(/'/g,"&apos;")})' class="bg-blue-600 px-3 py-1 rounded text-[10px] font-bold">VER</button>
                                <button onclick='copySpyWeek(${JSON.stringify(w).replace(/'/g,"&apos;")})' class="bg-green-600 px-3 py-1 rounded text-[10px] font-bold">CLONAR</button>
                            </div>
                        </div>`).join('');
                }
            } catch(e) { container.innerHTML = '<p class="text-red-500">Error de conexi√≥n.</p>'; }
        }
		// Activa el bot√≥n de clonado en la previsualizaci√≥n
        document.getElementById('btn-copy-preview').onclick = () => { if(spyPendingWeek) copySpyWeek(spyPendingWeek); };
        window.onload = () => { document.getElementById('inputDate').valueAsDate = new Date(); document.getElementById('runDate').valueAsDate = new Date(); lucide.createIcons(); };
		function updateKiStatus() {
    const card = document.getElementById('ki-status-card');
    const text = document.getElementById('ki-status-text');
    if (!card || !appData.progress.length) return;

    card.classList.remove('hidden');
    const lastVfc = appData.progress[appData.progress.length - 1].vfc;

    if (lastVfc >= 65) {
        card.style.borderColor = "#22c55e"; 
        text.innerHTML = `<span class="text-green-400 font-bold font-sans">KI ALTO (${lastVfc}):</span> Tu sistema nervioso est√° recuperado. Es el momento de buscar un nuevo R√©cord Personal (PR).`;
    } else if (lastVfc >= 45) {
        card.style.borderColor = "#fbbf24"; 
        text.innerHTML = `<span class="text-yellow-400 font-bold font-sans">KI ESTABLE (${lastVfc}):</span> Recuperaci√≥n normal. Entrena con intensidad moderada, sin llegar al fallo extremo.`;
    } else {
        card.style.borderColor = "#ef4444"; 
        text.innerHTML = `<span class="text-red-400 font-bold font-sans">KI AGOTADO (${lastVfc}):</span> Estr√©s alto detectado. Considera un d√≠a de descanso o una sesi√≥n muy suave para evitar lesiones.`;
    }
}
    </script>
</body>
</html>
