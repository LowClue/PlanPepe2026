<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plan Z (Ultimate Saiyan)</title>
    
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><circle cx=%2250%22 cy=%2250%22 r=%2245%22 fill=%22%23fbbf24%22 stroke=%22%23b45309%22 stroke-width=%223%22/><path d=%22M50 25L55 40L70 40L58 50L63 65L50 55L37 65L42 50L30 40L45 40Z%22 fill=%22%23dc2626%22/></svg>">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>

    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <style>
	
        @import url('https://fonts.googleapis.com/css2?family=Bangers&family=Rajdhani:wght@500;700&family=Inter:wght@300;400;600&display=swap');
        
        :root { 
            --anime-bg: url('https://img.asmedia.epimg.net/resizer/v2/DGT4YH6XWRETPCDYD54YIZIOXA.jpg?auth=66daaf9f308debf7a1645374b9cce9160fbcfb78d168e9bbe65833e97cc953ed&width=1472&height=828&smart=true'); 
            --saiyan-gold: #fbbf24;
            --power-blue: #3b82f6;
            --energy-green: #22c55e;
            --danger-red: #ef4444;
        }

        body { 
            font-family: 'Inter', sans-serif; color: #e2e8f0; margin: 0; padding: 0;
            background-color: #0b0f19; 
            background-image: linear-gradient(rgba(0,0,0,0.88), rgba(0,0,0,0.92)), var(--anime-bg);
            background-size: cover; background-position: center; background-attachment: fixed;
            min-height: 100vh;
        }

        .comic-font { font-family: 'Bangers', cursive; letter-spacing: 2px; }
        .scouter-font { font-family: 'Rajdhani', sans-serif; font-weight: 700; letter-spacing: 0.5px; }
        
        .glass { 
            background: rgba(15, 23, 42, 0.95); backdrop-filter: blur(16px); 
            border: 1px solid rgba(59, 130, 246, 0.2); box-shadow: 0 0 20px rgba(0, 0, 0, 0.6); 
        }
        
        .chart-container { position: relative; width: 100%; height: 200px; max-height: 300px; }
        #auth-screen { position: fixed; inset: 0; z-index: 100; display: flex; align-items: center; justify-content: center; background: #050505; }
        
        .hidden { display: none !important; }
        .hidden-tab { display: none; }
        .fade-in { animation: fadeIn 0.5s cubic-bezier(0.4, 0, 0.2, 1); }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
        
        .nav-btn.active { color: #fbbf24 !important; transform: scale(1.2); border-bottom: 3px solid #fbbf24; text-shadow: 0 0 15px rgba(251, 191, 36, 0.8); } 
        .nav-btn { transition: all 0.3s ease; border-bottom: 3px solid transparent; color: #64748b; }
        
        .calendar-day { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 0.6rem; border-radius: 0.75rem; border: 1px solid #334155; background-color: rgba(15, 23, 42, 0.8); cursor: pointer; transition: all 0.2s; }
        .calendar-day.active { border-color: #fbbf24; background-color: rgba(251, 191, 36, 0.2); color: #fcd34d; transform: scale(1.1); }
		/* --- A√ëADIR ESTO AL FINAL DEL CSS --- */
		/* --- BORRA LO QUE TENGAS DE TOGGLE Y PEGA ESTO --- */
		.toggle-checkbox:checked { 
			transform: translateX(100%); 
			border-color: #22c55e; 
		}
		.toggle-checkbox:checked + .toggle-label { 
			background-color: #22c55e; 
		}
		.toggle-checkbox { transition: transform 0.3s ease-in-out; }
		/* --- ESTILO FINAL FORM --- */
		.final-form-text {
			background: linear-gradient(to bottom, #fbbf24, #d97706, #78350f);
			-webkit-background-clip: text;
			background-clip: text;
			color: transparent;
			filter: drop-shadow(0 0 10px rgba(251, 191, 36, 0.5));
		}
		.lore-text {
			border-left: 2px solid #fbbf24;
			padding-left: 10px;
			font-style: italic;
			color: #94a3b8;
		}
		/* --- ESTADO SERIE COMPLETADA --- */
        .completed-set {
            background-color: rgba(34, 197, 94, 0.2) !important; /* Verde suave */
            border-color: #22c55e !important;
            color: #fff !important;
            box-shadow: 0 0 10px rgba(34, 197, 94, 0.3);
            transition: all 0.3s ease;
        }
    </style>
</head>
<body class="pb-32">

    <div id="auth-screen" class="bg-black/95">
		<div class="glass p-10 rounded-[2rem] max-w-sm w-full mx-4 text-center border-t-4 border-yellow-500 shadow-[0_0_80px_rgba(234,179,8,0.4)] relative overflow-hidden">
			<!-- Efecto de Aura de fondo -->
			<div class="absolute inset-0 bg-gradient-to-b from-yellow-500/10 to-transparent pointer-events-none"></div>
			
			<h1 class="text-6xl comic-font mb-0 uppercase italic final-form-text">PLAN Z</h1>
			<h2 class="text-2xl text-white scouter-font font-bold uppercase tracking-[0.5em] mb-6 border-b border-yellow-500/30 pb-2">Final Form</h2>
			
			<!-- El LORE (La historia) -->
			<div class="text-[10px] text-slate-400 mb-8 text-left bg-black/40 p-4 rounded-xl border border-white/5">
				<p class="mb-2"><span class="text-red-500 font-bold">‚úñ</span> Plan A... Fallido.</p>
				<p class="mb-2"><span class="text-red-500 font-bold">‚úñ</span> Plan B... Fallido.</p>
				<p class="text-yellow-400 font-bold animate-pulse">‚ö° El Plan Z es tu √∫ltima transformaci√≥n.</p>
			</div>

			<form id="login-form" class="space-y-5 text-left relative z-10">
				<input type="email" id="auth-email" class="w-full bg-slate-900 border border-blue-900 rounded-xl p-4 text-white outline-none focus:border-yellow-400 transition-all" placeholder="Email del Guerrero" required>
				<input type="password" id="auth-pass" class="w-full bg-slate-900 border border-blue-900 rounded-xl p-4 text-white outline-none focus:border-yellow-400 transition-all" placeholder="Contrase√±a" required>
				<div id="register-nickname-field" class="hidden"><input type="text" id="auth-nickname" class="w-full bg-slate-900 border border-yellow-500 rounded-xl p-4 text-white outline-none mb-4" placeholder="Tu Apodo Z"></div>
				<div class="text-xs text-red-400 hidden" id="auth-error">Error</div>
				<button type="submit" class="w-full bg-gradient-to-r from-blue-800 to-blue-600 hover:from-blue-700 hover:to-blue-500 text-white font-bold py-4 rounded-xl scouter-font text-2xl uppercase tracking-widest transition-all shadow-lg border border-blue-400/30">DESBLOQUEAR PODER</button>
			</form>
		</div>
    </div>

    <header class="p-4 pt-6 border-b border-blue-900/30 sticky top-0 z-40 glass shadow-2xl">
        <div class="max-w-3xl mx-auto flex justify-between items-center">
			<!-- DENTRO DEL HEADER, BUSCA EL DIV DEL T√çTULO Y REEMPL√ÅZALO POR ESTO -->
			<div onclick="switchTab('home')" class="cursor-pointer">
				<h1 class="text-3xl text-white comic-font italic uppercase leading-none flex flex-col">
					<span>PLAN <span class="text-yellow-400">Z</span></span>
					<span class="text-[10px] tracking-[0.4em] text-blue-300 font-sans font-bold -mt-1">FINAL FORM</span>
				</h1>
				<p class="text-[9px] text-slate-400 scouter-font uppercase italic mt-1">Guerrero: <span id="header-username" class="text-yellow-200">...</span></p>
			</div>
            <div class="cursor-pointer p-3" onclick="toggleSettings()"><i data-lucide="settings" class="w-7 h-7 text-blue-300"></i></div>
        </div>

        <div id="settings-panel" class="hidden mt-4 p-5 bg-slate-900 rounded-2xl border border-blue-800 max-w-2xl mx-auto space-y-5">
            <div class="flex items-center justify-between bg-slate-800 p-4 rounded-xl">
                <span class="text-sm font-bold text-white italic" id="user-email-display">...</span>
                <button onclick="logout()" class="text-xs text-red-400 border border-red-400/50 px-3 py-1 rounded font-bold uppercase">Salir</button>
            </div>
            
            <!-- BLOQUE DE BOTONES CORREGIDO (5 BOTONES) -->
            <div class="grid grid-cols-2 gap-3">
                <button onclick="changeNickname()" class="bg-slate-700 text-white text-xs py-3 rounded font-bold uppercase">Apodo</button>
                <button onclick="changeGroup()" class="bg-indigo-900 text-white text-xs py-3 rounded font-bold uppercase">Clan</button>
                
                <!-- Exportar JSON (Ancho completo para destacar) -->
                <!--<button onclick="exportPlanJSON()" class="col-span-2 bg-cyan-900 text-cyan-200 text-xs py-3 rounded font-bold uppercase border border-cyan-700/50 shadow-lg">Exportar JSON (Para la IA)</button>-->
                
                <!-- Acciones Destructivas -->
                <button onclick="deleteCurrentWeek()" class="bg-red-900/80 text-white text-xs py-3 rounded font-bold uppercase hover:bg-red-800">Borrar Semana Seleccionada</button>
                <button onclick="resetDefaultPlan()" class="bg-slate-800 text-white text-xs py-3 rounded font-bold uppercase hover:bg-slate-700 border border-slate-600">Borrar todas las semanas</button>
            </div>

            <div class="pt-3 border-t border-slate-700 text-center">
                <p class="text-[10px] text-slate-400 mb-3 uppercase font-bold italic">Protocolo IA</p>
                <div class="flex gap-3 mb-3">
                    <button onclick="copyPrompt()" class="flex-1 text-[10px] bg-purple-700 p-3 rounded-xl text-white font-bold uppercase shadow-lg">Copiar Comando para IA</button>
                    <button onclick="importNewWeek()" class="flex-1 text-[10px] bg-green-800 p-3 rounded-xl text-white font-bold uppercase shadow-lg">Importar Semana</button>
                </div>
                <div class="relative">
                    <textarea id="import-code-area" class="w-full bg-black text-green-400 p-4 rounded-xl border border-green-900 h-24 text-[10px] font-mono outline-none" placeholder="Pega el c√≥digo JSON que te ha respondido la IA aqu√≠ y luego dale a importar semana..."></textarea>
                    <button onclick="document.getElementById('import-code-area').value=''" class="absolute bottom-2 right-2 text-[8px] bg-red-900/50 text-red-300 px-2 py-1 rounded border border-red-800 uppercase font-bold">Limpiar</button>
                </div>
            </div>
        </div>
    </header>

    <main class="max-w-2xl mx-auto p-4 space-y-6 pb-24">
        
<!-- SECTOR: HOME (DASHBOARD) -->
	<div id="tab-home" class="tab-content fade-in space-y-6">

		<div class="text-center p-8 glass rounded-[2rem] border-b-4 border-yellow-500 shadow-[0_0_50px_rgba(234,179,8,0.2)] relative overflow-hidden">
			<div class="absolute top-0 left-0 w-full h-full bg-[url('https://www.transparenttextures.com/patterns/carbon-fibre.png')] opacity-20 pointer-events-none"></div>
			<h2 class="text-6xl final-form-text comic-font uppercase italic tracking-tighter relative z-10">PLAN Z</h2>
			<div class="inline-block bg-yellow-500/20 border border-yellow-500/50 px-4 py-1 rounded-full mt-2 backdrop-blur-sm">
				<p class="text-yellow-100 text-xs font-bold scouter-font tracking-[0.3em] uppercase shadow-black drop-shadow-md">SISTEMA DE ENTRENAMIENTO IA</p>
			</div>
		</div>

		<div class="glass border border-blue-500/30 rounded-3xl overflow-hidden shadow-2xl">
			<div class="bg-blue-900/40 p-4 border-b border-blue-500/20 flex justify-between items-center">
				<h3 class="text-white font-bold uppercase italic tracking-widest text-sm flex items-center gap-2">
					<i data-lucide="book-open" class="text-blue-400 w-5 h-5"></i> Protocolo de Inicio
				</h3>
				<span class="text-[9px] text-blue-300 bg-blue-900/50 px-2 py-1 rounded border border-blue-500/30">LEER OBLIGATORIO</span>
			</div>

			<div class="p-6 space-y-8">
				<div class="relative pl-8 border-l-2 border-slate-700">
					<div class="absolute -left-[9px] top-0 w-4 h-4 rounded-full bg-slate-900 border-2 border-red-500"></div>
					<h4 class="text-red-400 font-bold uppercase text-xs tracking-widest mb-1">Paso 1: Define tu ADN</h4>
					<p class="text-xs text-slate-300 leading-relaxed mb-3">La IA necesita tus l√≠mites. Ve a <strong>PERFIL</strong> y define Meta y Lesiones.</p>
					<button onclick="switchTab('profile')" class="bg-red-900/30 hover:bg-red-900/50 text-red-200 border border-red-800/50 px-4 py-2 rounded-xl text-[10px] uppercase font-bold transition-all">Ir a Perfil</button>
				</div>
				<div class="relative pl-8 border-l-2 border-slate-700">
					<div class="absolute -left-[9px] top-0 w-4 h-4 rounded-full bg-slate-900 border-2 border-purple-500"></div>
					<h4 class="text-purple-400 font-bold uppercase text-xs tracking-widest mb-1">Paso 2: Generar Semana 1</h4>
					<div class="bg-black/30 p-3 rounded-xl border border-white/5 space-y-2">
						<p class="text-[10px] text-slate-400">1. Toca <i data-lucide="settings" class="w-3 h-3 inline"></i> y pulsa <strong class="text-purple-400">COPIAR COMANDO</strong>.</p>
						<div class="text-[10px] text-yellow-200/80 bg-yellow-900/20 p-2 rounded border-l-2 border-yellow-500 italic"><strong>‚ö†Ô∏è IMPORTANTE:</strong> Rellena tus objetivos al final del texto que pegues en la IA.</div>
						<p class="text-[10px] text-slate-400">2. Pega el JSON de la IA en Ajustes > <strong class="text-green-400">IMPORTAR</strong>.</p>
					</div>
				</div>
				<div class="relative pl-8 border-l-2 border-yellow-500">
					<div class="absolute -left-[9px] top-0 w-4 h-4 rounded-full bg-slate-900 border-2 border-yellow-500 animate-pulse"></div>
					<h4 class="text-yellow-400 font-bold uppercase text-xs tracking-widest mb-1">Paso 3: Evoluci√≥n (Domingos)</h4>
					<p class="text-[10px] text-slate-400 italic">Repite el proceso de Copiar Comando cada domingo. El sistema leer√° tus progresos y le pedir√° a la IA una semana m√°s dura.</p>
				</div>
			</div>
		</div>

		<div class="grid grid-cols-1 gap-4 mt-4">
			<button onclick="switchTab('plan')" class="w-full bg-yellow-500 hover:bg-yellow-400 text-black font-bold py-6 rounded-3xl comic-font text-3xl shadow-[0_0_40px_rgba(234,179,8,0.3)] transition-all transform active:scale-95 uppercase italic border-4 border-yellow-600/20">
				¬°INICIAR ENTRENAMIENTO!
			</button>
			
			<div id="ki-status-card" class="bg-slate-900/80 p-4 rounded-2xl border border-slate-700 shadow-xl hidden flex items-center justify-between">
				<div class="flex items-center gap-3">
					<i data-lucide="zap" class="w-5 h-5 text-yellow-400 animate-pulse"></i>
					<div>
						<h3 class="text-white text-[10px] font-bold uppercase tracking-widest">Diagn√≥stico Vital</h3>
						<p id="ki-status-text" class="text-xs text-slate-400 italic">Calculando...</p>
					</div>
				</div>
				<button onclick="switchTab('profile')" class="text-[10px] bg-slate-800 text-white px-3 py-1 rounded border border-slate-600 uppercase">Ver Datos</button>
			</div>
		</div>

	</div>


</div>

<!-- SECTOR: RANKING (GENKIDAMA + HISTORIAL) -->
        <div id="tab-ranking" class="tab-content hidden-tab fade-in space-y-6">
            
            <!-- ZONA DE CAMPE√ìN (GIF DEL L√çDER ACTUAL) -->
            <div id="champion-display" class="hidden relative overflow-hidden rounded-2xl border-4 border-yellow-500 shadow-[0_0_60px_rgba(234,179,8,0.5)] mb-6 group aspect-video">
                <!-- GIF DE FONDO -->
                <img src="https://media0.giphy.com/media/v1.Y2lkPTc5MGI3NjExemxvc3J2bTZ4bWplMms4d2hiNTgxODFpZ2hkaWVjYWM5NzU0ZmgwdSZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9Zw/1gVUhlXhETaRRxzeHO/giphy.gif" class="absolute inset-0 w-full h-full object-cover opacity-80 group-hover:opacity-100 transition-opacity">
                
                <div class="absolute inset-0 bg-gradient-to-t from-black via-transparent to-transparent flex flex-col justify-end p-6">
                    <div class="flex items-center gap-2 mb-1">
                        <span class="bg-yellow-500 text-black text-[10px] font-black px-2 py-1 rounded uppercase tracking-widest">L√≠der Supremo</span>
                        <span class="text-yellow-300 text-[10px] font-bold uppercase tracking-widest animate-pulse" id="ranking-group-display">Global</span>
                    </div>
                    <!-- NOMBRE DEL GANADOR -->
                    <h3 id="winner-name" class="text-4xl text-white comic-font uppercase italic tracking-widest text-shadow-lg leading-none mb-1">NADIE</h3>
                    <p class="text-sm text-yellow-200 scouter-font font-bold"><span id="winner-points">0</span> Unidades de Energ√≠a</p>
                </div>
            </div>

            <!-- TABLA RANKING (MES ACTUAL) -->
            <div class="glass p-1 rounded-3xl border border-yellow-500/30 relative overflow-hidden shadow-xl">
                <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-yellow-500 via-red-500 to-yellow-500"></div>
                <div class="p-5">
                    <h2 class="text-2xl font-bold text-white comic-font flex items-center justify-center gap-3 italic tracking-widest uppercase mb-4">
                        <i data-lucide="swords" class="text-yellow-400 w-6 h-6"></i> Torneo Actual
                    </h2>
                    
                    <div class="overflow-x-auto rounded-xl bg-black/30 p-1 border border-slate-800">
                        <table class="w-full text-sm text-left text-slate-300">
                            <thead class="text-[9px] text-blue-400 uppercase tracking-widest bg-slate-900/50">
                                <tr>
                                    <th class="px-3 py-3 text-center">#</th>
                                    <th class="px-3 py-3">Guerrero</th>
                                    <th class="px-3 py-3 text-right text-yellow-200">Energ√≠a</th>
                                </tr>
                            </thead>
                            <tbody id="rankingTableBody" class="scouter-font text-base italic"></tbody>
                        </table>
                    </div>

                    <!-- LEYENDA R√ÅPIDA -->
                    <div class="flex justify-center gap-4 mt-3 text-[9px] text-slate-500 uppercase font-bold tracking-widest">
                        <span>üèãÔ∏è 150 Ki</span>
                        <span>üèÉ 200 Ki/KM</span>
                        <span>‚è±Ô∏è 10 Ki/Min</span>
                    </div>
                </div>
            </div>


            
			<div class="glass p-5 rounded-3xl border-l-4 border-blue-500 relative shadow-lg mt-6">
				<div class="flex items-center justify-between mb-4 border-b border-white/5 pb-2">
					<h3 class="text-xs font-bold text-blue-300 uppercase tracking-widest flex items-center gap-2 scouter-font">
						<i data-lucide="activity" class="w-4 h-4 text-blue-400"></i> M√©tricas de Combate
					</h3>
					<span class="text-[9px] text-slate-500 uppercase font-bold italic">Semana Actual</span>
				</div>
				
				<div class="grid grid-cols-2 gap-3">
					
					<div class="bg-slate-900/60 p-3 rounded-2xl border border-slate-700/50 flex flex-col justify-center relative overflow-hidden">
						<div class="flex justify-between items-end mb-1">
							<div class="flex items-center gap-1">
								<i data-lucide="scale" class="w-3 h-3 text-slate-400"></i>
								<span class="text-[8px] text-slate-400 uppercase font-black tracking-wider">Peso</span>
							</div>
							<span id="dash-weight-goal-text" class="text-[8px] text-blue-400 font-bold">0% Meta</span>
						</div>
						<div class="flex items-baseline gap-1">
							<div id="dash-weight-val" class="text-xl font-bold text-white scouter-font leading-none">--</div>
							<div id="dash-weight-diff" class="text-[9px] font-bold">--</div>
						</div>
						<div class="w-full h-1.5 bg-slate-800 rounded-full mt-2 overflow-hidden">
							<div id="dash-weight-bar" class="h-full bg-blue-500 rounded-full transition-all duration-1000" style="width: 0%"></div>
						</div>
					</div>

					<div class="bg-slate-900/60 p-3 rounded-2xl border border-purple-500/20 flex flex-col justify-center items-center relative">
						<div class="flex items-center gap-1 mb-1">
							<i data-lucide="brain-circuit" class="w-3 h-3 text-purple-400"></i>
							<span class="text-[8px] text-purple-300 uppercase font-black tracking-wider">Disciplina</span>
						</div>
						<div id="dash-discipline" class="text-xl font-bold text-purple-400 scouter-font leading-none">0%</div>
						<span class="text-[8px] text-purple-500/60 uppercase font-bold mt-1">Cumplimiento</span>
					</div>

					<div class="bg-slate-900/60 p-3 rounded-2xl border border-blue-500/20 flex flex-col justify-center items-center relative">
						<div class="flex items-center gap-1 mb-1">
							<i data-lucide="timer" class="w-3 h-3 text-blue-400"></i>
							<span class="text-[8px] text-blue-300 uppercase font-black tracking-wider">Tiempo</span>
						</div>
						<div id="dash-time" class="text-xl font-bold text-blue-400 scouter-font leading-none">0h 0m</div>
						<span class="text-[8px] text-blue-500/60 uppercase font-bold mt-1">Invertido</span>
					</div>

					<div class="bg-slate-900/60 p-3 rounded-2xl border border-orange-500/20 flex flex-col justify-center items-center relative">
						<div class="flex items-center gap-1 mb-1">
							<i data-lucide="flame" class="w-3 h-3 text-orange-400 animate-pulse"></i>
							<span class="text-[8px] text-orange-300 uppercase font-black tracking-wider">Fuego</span>
						</div>
						<div id="dash-fire" class="text-xl font-bold text-orange-400 scouter-font leading-none">0/7</div>
						<span class="text-[8px] text-orange-500/60 uppercase font-bold mt-1">D√≠as Activos</span>
					</div>
				</div>
			</div>
			            <!-- SAL√ìN DE LA FAMA (HISTORIAL POR A√ëOS) -->
            <div class="glass p-5 rounded-[2rem] border border-purple-500/30 relative">
                <div class="flex items-center justify-between mb-4 border-b border-white/10 pb-3">
                    <button onclick="changeRankingYear(-1)" class="p-2 hover:bg-white/10 rounded-full transition-colors text-slate-400 hover:text-white"><i data-lucide="chevron-left" class="w-5 h-5"></i></button>
                    <div class="text-center">
                        <h3 class="text-xs font-bold text-purple-300 uppercase tracking-widest flex items-center justify-center gap-2">
                            <i data-lucide="crown" class="w-4 h-4"></i> Sal√≥n de la Fama
                        </h3>
                        <span id="history-year-display" class="text-2xl font-bold text-white comic-font">2026</span>
                    </div>
                    <button onclick="changeRankingYear(1)" class="p-2 hover:bg-white/10 rounded-full transition-colors text-slate-400 hover:text-white"><i data-lucide="chevron-right" class="w-5 h-5"></i></button>
                </div>
                
                <!-- Lista de Ganadores Mensuales -->
                <div id="hall-of-fame-list" class="space-y-2 max-h-60 overflow-y-auto pr-1 custom-scrollbar">
                    <p class="text-center text-xs text-slate-500 italic py-4">Consultando los archivos antiguos...</p>
                </div>
            </div>
        </div>

        <div id="tab-plan" class="tab-content hidden-tab fade-in space-y-6">
		<!-- REEMPLAZAR EL DIV DE CONTROLES DE "tab-plan" POR ESTE BLOQUE: -->
			<div class="glass p-4 rounded-2xl border border-slate-700 flex flex-col gap-4 mb-4">
				
				<div class="flex flex-col sm:flex-row gap-3">
					<select id="week-selector" onchange="changeWeek()" class="w-full bg-slate-900 text-white scouter-font font-bold p-3 rounded-xl outline-none border border-slate-700 focus:border-yellow-500 transition-colors shadow-inner appearance-none text-center sm:text-left"></select>
					
					<button onclick="openSpyModal()" class="glass p-3 rounded-xl border border-purple-500/50 text-purple-300 font-bold text-xs flex items-center justify-center gap-2 hover:bg-purple-900/20 transition-all w-full sm:w-auto whitespace-nowrap shadow-lg">
						<i data-lucide="eye" class="w-4 h-4"></i> ESPIAR RIVALES
					</button>
				</div>
				
				<div class="flex items-center justify-between bg-slate-800/50 p-3 rounded-xl border border-white/5">
					<span class="text-xs text-slate-300 uppercase font-bold tracking-widest flex items-center gap-2">
						<i data-lucide="edit-3" class="w-4 h-4 text-yellow-500"></i> Modo Editor
					</span>
					<div class="relative inline-block w-12 mr-2 align-middle select-none transition duration-200 ease-in">
						<input type="checkbox" name="toggle" id="edit-mode-toggle" onchange="renderPlan()" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer border-slate-600 left-0 transition-all duration-300"/>
						<label for="edit-mode-toggle" class="toggle-label block overflow-hidden h-6 rounded-full bg-slate-700 cursor-pointer"></label>
					</div>
				</div>
			</div>
			

            <div class="grid grid-cols-7 gap-2 text-center" id="calendar-grid">
                <div class="calendar-day" onclick="scrollToDay(0)"><span>LUN</span><span class="day-num block font-bold text-lg">--</span></div>
                <div class="calendar-day" onclick="scrollToDay(1)"><span>MAR</span><span class="day-num block font-bold text-lg">--</span></div>
                <div class="calendar-day" onclick="scrollToDay(2)"><span>MI√â</span><span class="day-num block font-bold text-lg">--</span></div>
                <div class="calendar-day" onclick="scrollToDay(3)"><span>JUE</span><span class="day-num block font-bold text-lg">--</span></div>
                <div class="calendar-day" onclick="scrollToDay(4)"><span>VIE</span><span class="day-num block font-bold text-lg">--</span></div>
                <div class="calendar-day" onclick="scrollToDay(5)"><span>S√ÅB</span><span class="day-num block font-bold text-lg">--</span></div>
                <div class="calendar-day" onclick="scrollToDay(6)"><span>DOM</span><span class="day-num block font-bold text-lg">--</span></div>
            </div>
            <div id="plan-container" class="space-y-6"></div>
        </div>

<!-- SECTOR: CARDIO & DEPORTES (MULTI-SPORT) -->
        <div id="tab-running" class="tab-content hidden-tab fade-in space-y-6">
            
            <!-- Resumen -->
            <div class="grid grid-cols-2 gap-4">
                <div class="glass p-4 rounded-2xl border border-orange-500/20 flex flex-col items-center justify-center">
                    <span class="text-[10px] text-orange-300 uppercase tracking-widest font-bold">Total Actividad</span>
                    <span id="run-total-dist" class="text-2xl font-bold text-white comic-font mt-1">0.0 KM</span>
                </div>
                <div class="glass p-4 rounded-2xl border border-orange-500/20 flex flex-col items-center justify-center">
                    <span class="text-[10px] text-orange-300 uppercase tracking-widest font-bold">Tiempo Total</span>
                    <span id="run-total-time" class="text-2xl font-bold text-white comic-font mt-1">0h 0m</span>
                </div>
            </div>

            <!-- Formulario Multi-Deporte -->
            <div class="glass p-6 rounded-[2rem] border-l-4 border-orange-500 relative overflow-hidden shadow-xl">
                <div class="absolute right-0 top-0 p-10 bg-orange-600/10 blur-2xl rounded-full"></div>
                <h3 class="text-xl font-bold text-white mb-4 scouter-font uppercase italic flex items-center gap-2 relative z-10">
                    <i data-lucide="activity" class="w-5 h-5 text-orange-400"></i> Registrar Sesi√≥n
                </h3>
                <form id="runForm" class="space-y-4 relative z-10">
                    
                    <!-- Selector de Deporte -->
                    <div class="grid grid-cols-4 gap-2 mb-2">
                        <label class="cursor-pointer">
                            <input type="radio" name="sportType" value="run" class="peer sr-only" checked>
                            <div class="p-2 rounded-xl bg-slate-800 border border-slate-600 peer-checked:bg-orange-600 peer-checked:border-orange-400 peer-checked:text-white text-slate-400 flex flex-col items-center gap-1 transition-all">
                                <i data-lucide="footprints" class="w-4 h-4"></i><span class="text-[8px] font-bold uppercase">Correr</span>
                            </div>
                        </label>
                        <label class="cursor-pointer">
                            <input type="radio" name="sportType" value="padel" class="peer sr-only">
                            <div class="p-2 rounded-xl bg-slate-800 border border-slate-600 peer-checked:bg-blue-600 peer-checked:border-blue-400 peer-checked:text-white text-slate-400 flex flex-col items-center gap-1 transition-all">
                                <i data-lucide="table-2" class="w-4 h-4"></i><span class="text-[8px] font-bold uppercase">P√°del</span>
                            </div>
                        </label>
                        <label class="cursor-pointer">
                            <input type="radio" name="sportType" value="bike" class="peer sr-only">
                            <div class="p-2 rounded-xl bg-slate-800 border border-slate-600 peer-checked:bg-purple-600 peer-checked:border-purple-400 peer-checked:text-white text-slate-400 flex flex-col items-center gap-1 transition-all">
                                <i data-lucide="bike" class="w-4 h-4"></i><span class="text-[8px] font-bold uppercase">Bici</span>
                            </div>
                        </label>
                        <label class="cursor-pointer">
                            <input type="radio" name="sportType" value="other" class="peer sr-only">
                            <div class="p-2 rounded-xl bg-slate-800 border border-slate-600 peer-checked:bg-teal-600 peer-checked:border-teal-400 peer-checked:text-white text-slate-400 flex flex-col items-center gap-1 transition-all">
                                <i data-lucide="trophy" class="w-4 h-4"></i><span class="text-[8px] font-bold uppercase">Otro</span>
                            </div>
                        </label>
                    </div>

                    <div class="flex gap-4"><input type="date" id="runDate" class="bg-slate-900/80 border border-slate-700 p-3 rounded-xl text-white text-sm w-full outline-none focus:border-orange-500" required></div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div class="relative"><input type="number" id="runDist" step="0.01" placeholder="0.0" class="w-full bg-slate-900/80 border border-slate-700 p-4 rounded-xl text-2xl font-bold text-white text-center outline-none focus:border-orange-500"><span class="absolute right-3 bottom-2 text-[9px] text-slate-500 uppercase font-bold">KM</span></div>
                        <div class="relative"><input type="number" id="runTime" step="1" placeholder="00" class="w-full bg-slate-900/80 border border-slate-700 p-4 rounded-xl text-2xl font-bold text-white text-center outline-none focus:border-orange-500"><span class="absolute right-3 bottom-2 text-[9px] text-slate-500 uppercase font-bold">MIN</span></div>
                    </div>
                    
                    <button type="submit" class="w-full bg-gradient-to-r from-orange-700 to-orange-600 hover:from-orange-600 text-white font-bold py-4 rounded-xl uppercase scouter-font text-lg shadow-lg tracking-widest transition-all active:scale-95">Guardar Actividad</button>
                </form>
            </div>

			<div class="grid grid-cols-1 md:grid-cols-2 gap-4">
				<div class="glass p-4 rounded-3xl border border-slate-800">
					<h4 class="text-[10px] text-slate-400 uppercase font-bold mb-2 ml-2">Volumen Semanal (KM)</h4>
					<div class="chart-container h-40"><canvas id="chartRunningVolume"></canvas></div>
				</div>
				<div class="glass p-4 rounded-3xl border border-slate-800">
					<h4 class="text-[10px] text-orange-400 uppercase font-bold mb-2 ml-2">Evoluci√≥n de Ritmo (min/km)</h4>
					<div class="chart-container h-40"><canvas id="chartRunningPace"></canvas></div>
				</div>
			</div>
			<div class="space-y-3" id="runningListContainer"></div>
        </div>

        <div id="tab-strength" class="tab-content hidden-tab fade-in space-y-8">
			<!-- CONTENIDO DE id="tab-strength" -->
			<div class="glass p-8 rounded-3xl border border-blue-500/20 shadow-2xl">
				<h3 class="text-2xl font-bold text-white mb-6 scouter-font uppercase italic">Esc√°ner de Potencia</h3>
				<!-- OJO AQUI: onchange="handleStrengthSelectChange()" ES CR√çTICO -->
				<select id="exercise-select" onchange="handleStrengthSelectChange()" class="w-full bg-slate-900 border border-slate-700 p-4 rounded-xl text-white mb-6"></select>
				<div class="chart-container h-64"><canvas id="chartStrength"></canvas></div>
			</div>


			<h4 class="text-lg font-bold text-white scouter-font uppercase italic mt-8 border-b border-slate-800 pb-2">R√©cords Personales (PR)</h4>
			<div id="pr-list" class="space-y-3"></div>
        </div>

		<div id="tab-supplements" class="tab-content hidden-tab fade-in space-y-6">
			
			<div class="flex justify-between items-end border-b border-teal-500/30 pb-4">
				<div>
					<h3 class="text-3xl font-bold text-white scouter-font italic uppercase">Ki Suministros</h3>
					<p class="text-[10px] text-teal-400 font-bold uppercase tracking-widest">Arsenal Qu√≠mico</p>
				</div>
				<button onclick="openSuppModal()" class="bg-teal-700 hover:bg-teal-600 text-white px-5 py-3 rounded-xl font-bold uppercase text-[10px] tracking-widest shadow-lg border border-teal-500/50 transition-all active:scale-95">
					+ A√±adir Item
				</button>
			</div>

			<div id="supplements-list" class="grid gap-4">
				</div>

		</div>

        <div id="tab-gallery" class="tab-content hidden-tab fade-in space-y-8 text-center">
            <div class="glass p-10 rounded-3xl border border-purple-500/30">
                <h3 class="text-2xl font-bold mb-6 scouter-font uppercase italic">Expediente Visual</h3>
                <button onclick="document.getElementById('photo-input').click()" class="bg-purple-700 text-white px-8 py-4 rounded-2xl font-bold uppercase shadow-lg">+ Generar Captura</button>
                <input type="file" id="photo-input" accept="image/*" class="hidden" onchange="handlePhotoUpload(this)">
            </div>
            <div id="gallery-grid" class="grid grid-cols-2 gap-4"></div>
        </div>

        <div id="tab-profile" class="tab-content hidden-tab fade-in space-y-8">
    
    <div class="glass p-6 rounded-[2rem] border border-blue-500/30 flex items-center gap-4 shadow-xl">
        <div class="bg-blue-900/50 p-4 rounded-full border border-blue-400/30">
            <i data-lucide="user" class="w-8 h-8 text-blue-200"></i>
        </div>
        <div>
            <h2 class="text-2xl font-bold text-white scouter-font uppercase italic">Expediente Z</h2>
            <p class="text-xs text-slate-400">Configuraci√≥n Biol√≥gica y T√°ctica</p>
        </div>
    </div>

    <div class="glass p-6 rounded-3xl border-l-4 border-yellow-500 relative">
        <h3 class="text-sm font-bold text-yellow-400 uppercase tracking-widest mb-4 flex items-center gap-2">
            <i data-lucide="crosshair" class="w-4 h-4"></i> Objetivos & Limitaciones
        </h3>
        <div class="space-y-4">
            <div class="space-y-1">
                <label class="text-[10px] text-slate-400 font-bold uppercase ml-1">Meta de Peso (KG) <span class="text-red-400">*</span></label>
                <input type="number" id="profile-target" step="0.1" onchange="updateProfileData()" class="w-full bg-slate-900 border border-slate-700 rounded-xl p-4 text-white text-xl font-bold outline-none focus:border-yellow-500 transition-colors" placeholder="Ej: 80.0">
            </div>
            <div class="space-y-1">
                <label class="text-[10px] text-slate-400 font-bold uppercase ml-1">Lesiones / Notas M√©dicas <span class="text-red-400">*</span></label>
                <textarea id="profile-injuries" rows="2" onchange="updateProfileData()" class="w-full bg-slate-900 border border-slate-700 rounded-xl p-4 text-white text-sm outline-none focus:border-red-500 transition-colors placeholder-slate-600" placeholder="Ej: Dolor lumbar, rodilla derecha delicada..."></textarea>
            </div>
        </div>
    </div>

    <div class="glass p-6 rounded-3xl border-l-4 border-green-500 relative shadow-2xl">
        <div class="absolute -right-6 -top-6 text-green-500/5 rotate-12 pointer-events-none"><i data-lucide="activity" class="w-40 h-40"></i></div>
        
        <h3 class="text-sm font-bold text-green-400 uppercase tracking-widest mb-4 flex items-center gap-2 relative z-10">
            <i data-lucide="clipboard-pulse" class="w-4 h-4"></i> Registro Semanal de Batalla
        </h3>
        
        <form id="entryForm" class="space-y-4 relative z-10">
            <div class="grid grid-cols-2 gap-4">
                <div class="space-y-1">
                    <label class="text-[9px] text-slate-500 font-bold uppercase">Fecha</label>
                    <input type="date" id="inputDate" class="w-full bg-slate-900/80 border border-slate-600 rounded-xl p-3 text-white text-xs outline-none focus:border-green-500" required>
                </div>
                <div class="space-y-1">
                    <label class="text-[9px] text-blue-400 font-bold uppercase">Peso Hoy (KG) <span class="text-red-500">*</span></label>
                    <input type="number" id="inputWeight" step="0.1" class="w-full bg-slate-900/80 border border-blue-500/50 rounded-xl p-3 text-white text-lg font-bold outline-none focus:border-blue-400" placeholder="00.0" required>
                </div>
            </div>

            <div class="pt-2 border-t border-white/5">
                <p class="text-[9px] text-slate-500 uppercase font-bold mb-2 italic">Biometr√≠a Avanzada (Opcional)</p>
                <div class="grid grid-cols-3 gap-3">
                    <div class="space-y-1">
                        <label class="text-[8px] text-purple-400 font-bold uppercase">Sue√±o (h)</label>
                        <input type="number" id="inputSleep" step="0.5" class="w-full bg-slate-900 border border-slate-700 rounded-lg p-2 text-white text-sm text-center outline-none focus:border-purple-500">
                    </div>
                    <div class="space-y-1">
                        <label class="text-[8px] text-green-400 font-bold uppercase">VFC (ms)</label>
                        <input type="number" id="inputVfc" class="w-full bg-slate-900 border border-slate-700 rounded-lg p-2 text-white text-sm text-center outline-none focus:border-green-500">
                    </div>
                    <div class="space-y-1">
                        <label class="text-[8px] text-red-400 font-bold uppercase">PPM</label>
                        <input type="number" id="inputRhr" class="w-full bg-slate-900 border border-slate-700 rounded-lg p-2 text-white text-sm text-center outline-none focus:border-red-500">
                    </div>
                </div>
            </div>

            <button type="submit" class="w-full bg-green-700 hover:bg-green-600 text-white font-bold py-4 rounded-xl uppercase tracking-widest text-xs shadow-lg transition-all active:scale-95 mt-2">
                Guardar Estado F√≠sico
            </button>
        </form>
    </div>

	<div class="space-y-4">
        <h3 class="text-xs font-bold text-slate-500 uppercase tracking-widest ml-2">Tendencias Biom√©tricas</h3>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            
            <div id="container-weight" class="glass p-4 rounded-2xl border border-blue-900/20 text-center h-48 flex flex-col">
                <p class="text-[10px] text-blue-300 font-bold uppercase mb-1">Peso Corporal</p>
                <div class="chart-container flex-1 w-full"><canvas id="chartWeight"></canvas></div>
            </div>

            <div id="container-vfc" class="glass p-4 rounded-2xl border border-green-900/20 text-center h-48 flex flex-col">
                <p class="text-[10px] text-green-300 font-bold uppercase mb-1">VFC (Recuperaci√≥n)</p>
                <div class="chart-container flex-1 w-full"><canvas id="chartVfc"></canvas></div>
            </div>

            <div id="container-rhr" class="glass p-4 rounded-2xl border border-red-900/20 text-center h-48 flex flex-col">
                <p class="text-[10px] text-red-300 font-bold uppercase mb-1">PPM Reposo</p>
                <div class="chart-container flex-1 w-full"><canvas id="chartRhr"></canvas></div>
            </div>

            <div id="container-sleep" class="glass p-4 rounded-2xl border border-purple-900/20 text-center h-48 flex flex-col">
                <p class="text-[10px] text-purple-300 font-bold uppercase mb-1">Horas de Sue√±o</p>
                <div class="chart-container flex-1 w-full"><canvas id="chartSleep"></canvas></div>
            </div>

        </div>
    </div>

<div class="glass rounded-3xl overflow-hidden border border-slate-800 mt-6">
        <div class="bg-slate-900/50 p-4 border-b border-slate-800">
            <h4 class="text-xs font-bold text-slate-300 uppercase italic">Bit√°cora de Salud</h4>
        </div>
        <div class="overflow-x-auto max-h-60 overflow-y-auto">
            <table class="w-full text-xs text-left text-slate-400 table-fixed">
                <thead class="text-[9px] text-slate-500 uppercase bg-slate-950 sticky top-0 z-10">
                    <tr>
                        <th class="px-2 py-3 bg-slate-950 w-1/6">Fecha</th>
                        <th class="px-1 py-3 text-center text-blue-400 bg-slate-950 w-1/6">Peso</th>
                        <th class="px-1 py-3 text-center text-green-400 bg-slate-950 w-1/6">VFC</th>
                        <th class="px-1 py-3 text-center text-red-400 bg-slate-950 w-1/6">PPM</th>
                        <th class="px-1 py-3 text-center text-purple-400 bg-slate-950 w-1/6">Sue√±o</th>
                        <th class="px-1 py-3 text-right bg-slate-950 w-1/6"></th>
                    </tr>
                </thead>
                <tbody id="historyTableBody" class="divide-y divide-slate-800/50"></tbody>
            </table>
        </div>
    </div>


    <div class="pt-4">
        <button onclick="generatePDF()" class="w-full bg-slate-800 hover:bg-slate-700 border border-slate-600 text-white font-bold py-4 rounded-2xl flex items-center justify-center gap-3 transition-all">
            <i data-lucide="file-down" class="text-yellow-400 w-4 h-4"></i>
            <span class="uppercase text-[10px] tracking-widest">Generar Informe PDF</span>
        </button>
    </div>

</div>

    </main>

    <div id="spy-modal" class="hidden fixed inset-0 bg-black/98 z-50 flex items-center justify-center p-6 backdrop-blur-xl">
        <div class="glass bg-slate-900 w-full max-w-xl p-8 rounded-[2rem] border border-purple-500/50 relative h-[80vh] flex flex-col shadow-2xl">
            <button onclick="closeSpyModal()" class="absolute top-4 right-4 text-slate-400 p-2"><i data-lucide="x"></i></button>
            <h4 class="text-3xl font-bold text-purple-400 scouter-font mb-6 italic uppercase">Radar de Objetivos</h4>
            <div id="spy-user-list" class="flex gap-4 overflow-x-auto pb-4 border-b border-slate-800 mb-4"></div>
            <div id="spy-weeks-container" class="flex-1 overflow-y-auto space-y-4"></div>
        </div>
    </div>

    <div id="spy-preview-modal" class="hidden fixed inset-0 bg-black/99 z-[60] flex items-center justify-center p-6 backdrop-blur-3xl">
         <div class="glass bg-slate-950 w-full max-w-lg p-10 rounded-[2rem] border-2 border-blue-500 relative max-h-[85vh] flex flex-col shadow-2xl">
             <button onclick="closeSpyPreview()" class="absolute top-4 right-4 text-slate-400 p-2"><i data-lucide="x"></i></button>
             <h4 class="text-2xl font-bold text-white scouter-font mb-6 italic uppercase">Vista Previa</h4>
             <div id="spy-preview-content" class="flex-1 overflow-y-auto space-y-4 text-slate-200 text-xs italic bg-black/50 p-4 rounded-xl shadow-inner border border-slate-800"></div>
             <button id="btn-copy-preview" class="w-full bg-green-700 hover:bg-green-600 text-white font-bold py-6 rounded-2xl uppercase mt-4 shadow-xl transition-all active:scale-95">CLONAR PLAN Z</button>
         </div>
    </div>

    <div id="supp-modal" class="hidden fixed inset-0 bg-black/95 z-50 flex items-center justify-center p-6 backdrop-blur-sm">
        <div class="glass bg-slate-900 w-full max-w-lg p-8 rounded-3xl border border-teal-500 shadow-2xl">
            <h4 id="supp-modal-title" class="text-2xl font-bold text-white mb-6 uppercase italic">Editar Suministro</h4>
            <form id="suppForm" class="space-y-4">
                <input type="hidden" id="suppId">
                <input type="text" id="suppName" class="w-full bg-slate-800 p-4 rounded-xl text-white border border-slate-700 outline-none" placeholder="Nombre" required>
                <input type="text" id="suppDose" class="w-full bg-slate-800 p-4 rounded-xl text-white border border-slate-700 outline-none" placeholder="Dosis" required>
                <select id="suppTiming" class="w-full bg-slate-800 p-4 rounded-xl text-white border border-slate-700 outline-none">
                    <option value="morning">Ma√±ana</option>
                    <option value="workout">Entrenamiento</option>
                    <option value="meal">Comidas</option>
                    <option value="night">Noche</option>
                </select>
                <textarea id="suppDesc" class="w-full bg-slate-800 p-4 rounded-xl text-white border border-slate-700 outline-none" placeholder="Descripci√≥n"></textarea>
                <div class="flex items-center gap-3"><input type="checkbox" id="suppActive" class="w-5 h-5 rounded" checked> <label class="text-sm font-bold uppercase italic">Fase Activa</label></div>
                <div class="flex gap-4 pt-4">
                    <button type="button" onclick="deleteCurrentSupp()" id="btn-delete-supp" class="bg-red-900/50 text-red-200 border border-red-800 p-4 rounded-xl flex-1 hidden transition-all">Borrar</button>
                    <button type="submit" class="bg-teal-600 hover:bg-teal-500 text-white p-4 rounded-xl flex-[2] font-bold uppercase transition-all shadow-lg">Guardar Registro</button>
                </div>
            </form>
        </div>
    </div>
<!-- CRON√ìMETRO FLOTANTE INTELIGENTE -->
    <div id="rest-timer-widget" class="fixed bottom-24 right-4 z-[70] flex flex-col items-end pointer-events-none">
        
        <!-- Panel del Reloj -->
        <div id="timer-display" class="bg-slate-900/95 border-2 border-yellow-500/50 p-4 rounded-2xl shadow-[0_0_30px_rgba(234,179,8,0.2)] mb-3 backdrop-blur-md pointer-events-auto hidden transform transition-all origin-bottom-right w-64">
            
            <!-- Configuraci√≥n R√°pida -->
            <div class="flex justify-between items-center mb-4 border-b border-white/10 pb-2">
                <div class="flex items-center gap-2">
                    <span class="text-[9px] font-bold text-slate-400 uppercase">Auto-Start</span>
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" id="timer-auto-switch" class="sr-only peer">
                        <div class="w-7 h-4 bg-slate-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-3 after:w-3 after:transition-all peer-checked:bg-yellow-500"></div>
                    </label>
                </div>
                <div class="flex items-center gap-1">
                    <input type="number" id="timer-default-time" value="90" class="w-10 bg-black border border-slate-600 rounded text-center text-white text-xs py-1" onchange="localStorage.setItem('pepeRestTime', this.value)">
                    <span class="text-[9px] text-slate-500">seg</span>
                </div>
            </div>

            <!-- Cuenta Atr√°s -->
            <div class="text-center">
                <span id="timer-countdown" class="font-mono text-5xl font-black text-white tabular-nums tracking-tighter drop-shadow-lg">00:00</span>
                <p class="text-[9px] text-yellow-500 uppercase tracking-widest mb-3 mt-1 font-bold animate-pulse" id="timer-status">Esperando serie...</p>
                
                <!-- Controles -->
                <div class="flex justify-between gap-2">
                    <button onclick="stopTimer()" class="flex-1 bg-red-900/80 hover:bg-red-800 text-red-100 text-[10px] py-2 rounded-lg uppercase font-bold border border-red-700/50">Stop</button>
                    <button onclick="addTime(30)" class="flex-1 bg-blue-900/80 hover:bg-blue-800 text-blue-100 text-[10px] py-2 rounded-lg uppercase font-bold border border-blue-700/50">+30s</button>
                </div>
            </div>
        </div>

        <!-- Bot√≥n Flotante -->
        <button onclick="toggleTimer()" class="pointer-events-auto bg-yellow-500 hover:bg-yellow-400 text-black p-4 rounded-full shadow-[0_0_20px_rgba(234,179,8,0.6)] transition-all transform active:scale-90 flex items-center justify-center border-4 border-black/20 z-50 group">
            <i data-lucide="timer" class="w-7 h-7 group-hover:rotate-12 transition-transform"></i>
        </button>
    </div>
<!-- WIDGET SPOTIFY (MUSICAL) MEJORADO -->
    <div id="spotify-widget" class="fixed bottom-24 left-4 z-[60] flex flex-col items-start pointer-events-none">
        <!-- Contenedor del Reproductor -->
        <div id="spotify-controls" class="hidden mb-4 bg-black/90 p-4 rounded-2xl border-2 border-[#1DB954] shadow-[0_0_30px_rgba(29,185,84,0.3)] backdrop-blur-xl transform transition-all origin-bottom-left w-80 max-w-[85vw] pointer-events-auto">
            
            <div class="flex justify-between items-center mb-3">
                <label class="text-[10px] text-[#1DB954] font-black uppercase tracking-widest flex items-center gap-2">
                    <i data-lucide="radio" class="w-3 h-3 animate-pulse"></i> Frecuencia Z
                </label>
                <!-- ENLACE AL WEB PLAYER (Ayuda a refrescar la cookie) -->
                <a href="https://open.spotify.com" target="_blank" class="text-[9px] text-slate-400 hover:text-white border border-slate-600 hover:border-[#1DB954] rounded px-2 py-1 transition-colors flex items-center gap-1">
                    <i data-lucide="external-link" class="w-2 h-2"></i> Abrir Spotify Web
                </a>
            </div>
            
            <!-- SELECTOR DE LISTAS -->
            <select id="spotify-selector" onchange="changeSpotifyPlaylist(this.value)" class="w-full bg-slate-800 text-white text-xs font-bold p-3 rounded-xl mb-4 outline-none border border-slate-700 focus:border-[#1DB954] transition-colors appearance-none">
                <!-- TU LISTA PERSONALIZADA AHORA ES LA PRIMERA -->
                <option value="37i9dQZF1E8NUfUW0nHIT7">üéß Mi Selecci√≥n</option>
                <option value="37i9dQZF1DX76Wlfdnj7AP">üí™ Beast Mode (Phonk/Gym)</option>
                <option value="37i9dQZF1DX0XUsuxWHRQd">üî• Reggaeton Duro</option>
                <option value="37i9dQZF1DWTXx3N4W0hP7">üé∏ Rock Entrenamiento</option>
                <option value="37i9dQZF1DX5c9ae2b7pYv">üíÉ Rumba & Fiesta</option>
            </select>
            
            <!-- REPRODUCTOR -->
            <iframe id="spotify-iframe" style="border-radius:12px" src="https://open.spotify.com/embed/playlist/37i9dQZF1E8NUfUW0nHIT7?utm_source=generator&theme=0" width="100%" height="152" frameBorder="0" allowfullscreen="" allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture" loading="lazy" class="shadow-lg"></iframe>
            
            <!-- AVISO T√âCNICO -->
            <div class="mt-2 p-2 bg-yellow-900/30 border border-yellow-700/50 rounded-lg text-center">
                <p class="text-[8px] text-yellow-500 leading-tight">
                    <strong>¬øSolo oyes 30 segundos?</strong><br>
                    Tu navegador bloquea las cookies de terceros.<br>
                    <span class="text-slate-400">Soluci√≥n: Habilita cookies para spotify.com en la configuraci√≥n de tu navegador.</span>
                </p>
            </div>
        </div>
        
        <!-- BOT√ìN ACTIVADOR -->
        <button onclick="toggleSpotify()" class="pointer-events-auto bg-[#1DB954] hover:bg-[#1ed760] text-black p-4 rounded-full shadow-[0_0_20px_rgba(29,185,84,0.6)] transition-all transform active:scale-95 hover:scale-110 flex items-center justify-center border-4 border-black/20 z-50">
            <i data-lucide="music" class="w-7 h-7"></i>
        </button>
    </div>
       
    <nav class="fixed bottom-0 w-full bg-slate-900/98 backdrop-blur-3xl border-t border-slate-800 p-1 pb-10 z-50 flex justify-around shadow-[0_-20px_60px_rgba(0,0,0,0.98)]">
        <button onclick="switchTab('home')" id="btn-home" class="nav-btn active p-2 w-full flex flex-col items-center gap-1"><i data-lucide="home"></i></button>
        <button onclick="switchTab('ranking')" id="btn-ranking" class="nav-btn p-2 w-full flex flex-col items-center gap-1"><i data-lucide="trophy"></i></button>
        <button onclick="switchTab('plan')" id="btn-plan" class="nav-btn p-2 w-full flex flex-col items-center gap-1"><i data-lucide="calendar-days"></i></button>
        <button onclick="switchTab('running')" id="btn-running" class="nav-btn p-2 w-full flex flex-col items-center gap-1"><i data-lucide="footprints"></i></button>
        <button onclick="switchTab('strength')" id="btn-strength" class="nav-btn p-2 w-full flex flex-col items-center gap-1"><i data-lucide="dumbbell"></i></button>
        <button onclick="switchTab('supplements')" id="btn-supplements" class="nav-btn p-2 w-full flex flex-col items-center gap-1"><i data-lucide="pill"></i></button>
        <button onclick="switchTab('profile')" id="btn-profile" class="nav-btn p-2 w-full flex flex-col items-center gap-1"><i data-lucide="user-circle"></i></button>
    </nav>
<!-- CANVAS OCULTO PARA GENERAR GR√ÅFICAS DEL PDF -->
    <div style="position: absolute; left: -9999px; top: -9999px;">
        <canvas id="pdfHiddenCanvas" width="800" height="400"></canvas>
    </div>
<script>
        // --- üî¥ CONFIGURACI√ìN DE FIREBASE üî¥ ---
        const firebaseConfig = {
            apiKey: "AIzaSyCa9FJBYgHvwzT_MT-bfsOTJSOnMxhmcss", 
            authDomain: "pepe-entrenamiento-2026.firebaseapp.com",
            projectId: "pepe-entrenamiento-2026",
            storageBucket: "pepe-entrenamiento-2026.firebasestorage.app",
            messagingSenderId: "725522983850",
            appId: "1:725522983850:web:909a18e2541bc99349d9d3"
        };
        // ----------------------------------------------------

        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        let currentUser = null;


// --- ESTADO GLOBAL (STORE) ---
        // Declaramos TODAS las variables gr√°ficas aqu√≠ para evitar errores de duplicado
        let runningChartInstance = null;
        let runningVolumeChartInstance = null; // Esta faltaba o estaba duplicada
        let weightChartInstance = null;
        let vfcChartInstance = null;
        let rhrChartInstance = null;
        let sleepChartInstance = null;
        let strengthChartInstance = null;

        let appData = {
            nickname: "Guerrero Z", group: "Global", targetWeight: 0,
            plan: [], strength: {}, running: [], progress: [], supplements: []
        };
        let galleryData = JSON.parse(localStorage.getItem('pepeGallery')) || []; 
        let currentWeekIndex = 0;
        let spyUsersCache = []; 
        let spyPendingWeek = null;
		let rankingYear = new Date().getFullYear();
		
        let runningPaceChartInstance = null;   // Variable global para gr√°fica ritmo (renombrada para claridad)

        // --- SISTEMA DE AUTENTICACI√ìN ---
        auth.onAuthStateChanged(user => {
            if (user) {
                currentUser = user;
                document.getElementById('auth-screen').classList.add('hidden');
                document.getElementById('user-email-display').innerText = user.email;
                loadDataFromCloud();
            } else {
                document.getElementById('auth-screen').classList.remove('hidden');
            }
        });

        document.getElementById('login-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const email = document.getElementById('auth-email').value, pass = document.getElementById('auth-pass').value, nick = document.getElementById('auth-nickname').value;
            const errorMsg = document.getElementById('auth-error'); errorMsg.classList.add('hidden');
            
            auth.signInWithEmailAndPassword(email, pass).catch(err => {
                if (['auth/user-not-found', 'auth/invalid-credential', 'auth/invalid-login-credentials'].includes(err.code)) {
                    const nickField = document.getElementById('register-nickname-field');
                    if (nickField.classList.contains('hidden')) { 
                        nickField.classList.remove('hidden'); 
                        errorMsg.innerText = "Usuario no detectado. Escribe un apodo y pulsa de nuevo para registrarte."; 
                        errorMsg.classList.remove('hidden'); return; 
                    }
                    auth.createUserWithEmailAndPassword(email, pass).then(() => initializeNewUser(nick || "Novato Z")).catch(e => {
                        errorMsg.innerText = e.code === 'auth/email-already-in-use' ? "Identidad registrada. Contrase√±a mal." : e.message;
                        errorMsg.classList.remove('hidden');
                    });
                } else { errorMsg.innerText = err.message; errorMsg.classList.remove('hidden'); }
            });
        });

        function logout() { auth.signOut().then(() => window.location.reload()); }

        // --- SINCRONIZACI√ìN NUBE ---
        async function loadDataFromCloud() {
            if (!currentUser) return;
            try {
                const doc = await db.collection('users').doc(currentUser.uid).get();
                if (doc.exists) {
                    const data = doc.data();
                    // Reparar labels undefined
                    if (data.plan) {
                        data.plan.forEach((w, i) => { if (!w.label || w.label === "undefined") w.label = `Ciclo Z ${i + 1}`; });
                    }
                    // Parche estructura
                    if (data.plan && data.plan.length > 0 && !data.plan[0].days) {
                         data.plan = [{ id: "rec-" + Date.now(), label: "Plan Maestro Recuperado", days: data.plan }];
                    }
                    appData = { ...appData, ...data };
                    if (!appData.plan || appData.plan.length === 0) appData.plan = [{ id: "w1", label: "Ciclo 1 (Inicio Maestro)", days: getDefaultPlan() }];
                    if (!appData.supplements || appData.supplements.length === 0) appData.supplements = getDefaultSupplements();
                } else { initializeNewUser(appData.nickname); }
                initAppUI(); loadLeaderboard(); updateExerciseSelector();
            } catch (error) { console.error("Error sincronizaci√≥n:", error); initAppUI(); }
        }

        function saveDataToCloud() {
            if (!currentUser) return;
            db.collection('users').doc(currentUser.uid).set(appData, { merge: true }).then(() => updateLeaderboardEntry());
        }

        function initializeNewUser(nick) {
            appData.nickname = nick || "Guerrero Z";
            appData.plan = [{ id: "w-init", label: "Semana 1 (Protocolo Inicial)", days: getDefaultPlan() }];
            appData.supplements = getDefaultSupplements();
            saveDataToCloud();
        }

        // --- CALENDARIO DIN√ÅMICO (TIEMPO REAL) ---
		function updateCalendarDates() {
            const today = new Date();
            const dayOfWeek = today.getDay(); 
            const diff = today.getDate() - dayOfWeek + (dayOfWeek === 0 ? -6 : 1);
            const monday = new Date(new Date().setDate(diff));

            const calendarDays = document.querySelectorAll('.calendar-day');
            calendarDays.forEach((el, i) => {
                const date = new Date(monday);
                date.setDate(monday.getDate() + i);
                const numSpan = el.querySelector('.day-num');
                if(numSpan) numSpan.innerText = date.getDate();
                
                // Marcar d√≠a actual
                el.classList.remove('active');
                if (i === (dayOfWeek === 0 ? 6 : dayOfWeek - 1)) {
                    el.classList.add('active');
                }
            });
        }

        function scrollToDay(idx) {
            const target = document.getElementById(`day-card-${idx}`);
            if(target) target.scrollIntoView({ behavior: "smooth", block: "center" });
        }

        // --- INICIALIZACI√ìN UI ---
        function initAppUI() {
            currentWeekIndex = Math.max(0, appData.plan.length - 1);
            document.getElementById('header-username').innerText = appData.nickname;
            updateCalendarDates();
            renderPlan(); 
            renderSupplements(); 
            updateHistoryTable(); 
            updateRunningUI(); 
            renderGallery();
            updateExerciseSelector();
            updateHomeMiniStats();
            switchTab('home');
			document.getElementById('profile-target').value = appData.targetWeight || "";
			document.getElementById('profile-injuries').value = appData.injuries || "";
        }

	function updateHomeMiniStats() {
		// --- 1. PESO Y META (Evoluci√≥n) ---
		if(appData.progress.length > 0) {
			const s = [...appData.progress].sort((a,b)=>new Date(a.date)-new Date(b.date));
			const current = s[s.length-1].weight;
			const start = s[0].weight; 
			const target = appData.targetWeight || start; 
			
			// Diferencia
			const diff = current - start;
			document.getElementById('dash-weight-val').innerText = current + " kg";
			const diffEl = document.getElementById('dash-weight-diff');
			diffEl.innerText = (diff > 0 ? "+" : "") + diff.toFixed(1);
			diffEl.className = diff > 0 ? "text-[9px] font-bold text-red-400 ml-1" : "text-[9px] font-bold text-green-400 ml-1";

			// % Meta
			let percent = 0;
			const totalToLose = start - target;
			const lostSoFar = start - current;
			if (totalToLose !== 0) percent = (lostSoFar / totalToLose) * 100;
			percent = Math.max(0, Math.min(100, percent)); // Limitar entre 0 y 100
			
			document.getElementById('dash-weight-bar').style.width = percent + "%";
			document.getElementById('dash-weight-goal-text').innerText = percent.toFixed(0) + "% META";
		}

		// VARIABLES ACUMULADORAS
		const currentWeek = appData.plan[currentWeekIndex];
		let totalChecksPossible = 0;
		let totalChecksDone = 0;
		let activeDaysCount = 0;
		
		// --- BUCLE PRINCIPAL (Recorremos la semana) ---
		if (currentWeek && currentWeek.days) {
			currentWeek.days.forEach(day => {
				let dayHasActivity = false;

				if (day.exercises) {
					day.exercises.forEach(ex => {
						// Si pone "Check", asumimos 1 set para el c√°lculo
						const sets = parseInt(ex.sets) || 1; 
						totalChecksPossible += sets;
						
						if (ex.checks) {
							const marked = ex.checks.filter(c => c === true).length;
							totalChecksDone += marked;
							if (marked > 0) dayHasActivity = true;
						}
					});
				}
				if (dayHasActivity) activeDaysCount++;
			});
		}

		// --- 2. DISCIPLINA (% Completado) ---
		const discipline = totalChecksPossible > 0 ? Math.round((totalChecksDone / totalChecksPossible) * 100) : 0;
		document.getElementById('dash-discipline').innerText = discipline + "%";

		// --- 3. TIEMPO (Estimaci√≥n) ---
		// Cardio Real (Running tab) + Gym Estimado (3 min/serie)
		const oneWeekAgo = new Date(); oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);
		const recentCardio = appData.running.filter(r => new Date(r.date) >= oneWeekAgo);
		const cardioMinutes = recentCardio.reduce((acc, r) => acc + (parseFloat(r.time)||0), 0);
		
		const gymMinutes = totalChecksDone * 3; 
		const totalMinutes = cardioMinutes + gymMinutes;
		
		const h = Math.floor(totalMinutes/60); 
		const m = Math.floor(totalMinutes%60);
		document.getElementById('dash-time').innerText = `${h}h ${m}m`;

		// --- 4. FUEGO (D√≠as Activos) ---
		document.getElementById('dash-fire').innerText = `${activeDaysCount}/${currentWeek.days ? currentWeek.days.length : 7}`;

		lucide.createIcons();
	}

function renderPlan() {
    const isEditMode = document.getElementById('edit-mode-toggle')?.checked; 
    const s = document.getElementById('week-selector');
    
    // Configurar Selector
    if(appData.plan.length === 0) return;
    s.innerHTML = appData.plan.map((w, i) => `<option value="${i}" ${i === currentWeekIndex ? 'selected' : ''}>${w.label || "Protocolo"}</option>`).join('');
    if(!appData.plan[currentWeekIndex]) return;

    // --- C√ÅLCULO DE FECHAS REALES (L√≥gica de Calendario) ---
    const today = new Date();
    const currentDay = today.getDay(); 
    // Calcular la fecha del Lunes de la semana actual
    const diff = today.getDate() - currentDay + (currentDay === 0 ? -6 : 1); 
    const mondayDate = new Date(today);
    mondayDate.setDate(diff);

    // Renderizar D√≠as
    document.getElementById('plan-container').innerHTML = appData.plan[currentWeekIndex].days.map((day, dIdx) => {
        let color = day.type === 'gym' ? 'border-blue-500' : day.type === 'cardio' ? 'border-green-500' : 'border-purple-500';
        
        // Calcular fecha espec√≠fica de ESTA tarjeta (Lunes + dIdx d√≠as)
        const cardDate = new Date(mondayDate);
        cardDate.setDate(mondayDate.getDate() + dIdx);
        // Obtener nombre del mes corto en may√∫sculas (Ej: ENE, FEB)
        const monthShort = cardDate.toLocaleString('es-ES', { month: 'short' }).toUpperCase().replace('.', '');

        const exHtml = day.exercises.map((ex, eIdx) => {
            if (isEditMode) {
                // ... (C√≥digo de edici√≥n igual que antes) ...
                return `<div class="py-4 border-b border-slate-700/50 bg-slate-800/30 p-2 rounded mb-2"><div class="grid grid-cols-12 gap-2 mb-2"><div class="col-span-12"><label class="text-[9px] text-yellow-500 font-bold uppercase">Ejercicio</label><input type="text" value="${ex.name}" onchange="updateExerciseData(${dIdx}, ${eIdx}, 'name', this.value)" class="w-full bg-slate-900 border border-slate-600 rounded px-2 py-1 text-white text-sm font-bold"></div><div class="col-span-4"><label class="text-[9px] text-blue-300 font-bold uppercase">Series</label><input type="text" value="${ex.sets}" onchange="updateExerciseData(${dIdx}, ${eIdx}, 'sets', this.value)" class="w-full bg-slate-900 border border-slate-600 rounded px-2 py-1 text-white text-xs text-center"></div><div class="col-span-4"><label class="text-[9px] text-blue-300 font-bold uppercase">Reps</label><input type="text" value="${ex.reps}" onchange="updateExerciseData(${dIdx}, ${eIdx}, 'reps', this.value)" class="w-full bg-slate-900 border border-slate-600 rounded px-2 py-1 text-white text-xs text-center"></div><div class="col-span-4 flex items-end"><button onclick="deleteExercise(${dIdx}, ${eIdx})" class="w-full bg-red-900/50 text-red-300 border border-red-800 rounded py-1 text-[10px] uppercase font-bold hover:bg-red-800">Borrar</button></div></div></div>`;
            } else {
                const vid = ex.vid ? `<a href="${ex.vid}" target="_blank" class="text-pink-400 text-[10px] ml-2 border border-pink-500/30 rounded px-2 py-0.5 font-bold uppercase italic">Video</a>` : '';
                let inputHtml = '';
                const sets = parseInt(ex.sets) || 1; 
                const potentialKi = sets * 100; 

                // CASO A: Series M√∫ltiples (Gym)
                if (ex.track && sets > 1 && sets < 10) {
                    const saved = (ex.weight || "").toString().split('/');
                    const checks = ex.checks || []; 
                    let boxes = '';
                    for(let i=0; i<sets; i++) {
                        const isChecked = checks[i] === true;
                        const btnClass = isChecked ? "bg-green-600 text-white border-green-500" : "bg-slate-700/50 text-slate-400 border-slate-600";
                        const inpClass = isChecked ? "completed-set" : "";
                        boxes += `<div class="flex flex-col items-center gap-1"><input type="number" placeholder="kg" value="${saved[i]||''}" class="bg-slate-800 border-slate-600 rounded-lg w-12 text-center text-white text-xs py-2 focus:border-yellow-400 outline-none transition-colors ${inpClass}" onchange="saveMultiSetWeight(${dIdx}, ${eIdx}, ${sets}, this)"><button onclick="toggleSetCheck(${dIdx}, ${eIdx}, ${i}, this)" class="w-12 h-6 hover:bg-green-500 rounded text-[10px] transition-all border ${btnClass}">‚úî</button></div>`;
                    }
                    inputHtml = `<div class="flex flex-wrap justify-end items-center mt-2 gap-1"><span class="text-[8px] text-slate-500 mr-2 font-bold italic uppercase self-start mt-2">Series:</span>${boxes}</div>`;
                } 
                // CASO B: Check Simple (H√°bitos)
                else {
                    const isChecked = (ex.checks && ex.checks[0] === true);
                    const btnClass = isChecked ? "bg-green-600 text-white border-green-500 shadow-[0_0_10px_rgba(34,197,94,0.5)]" : "bg-slate-700/50 text-slate-400 border-slate-600";
                    const weightInput = ex.track ? `<input type="text" placeholder="KG" value="${ex.weight || ''}" class="bg-slate-800 border-slate-600 rounded-lg w-16 text-center text-white text-xs py-2 focus:border-yellow-500 outline-none transition-colors ${isChecked ? 'completed-set' : ''}" onchange="saveWeight(${dIdx}, ${eIdx}, this.value)">` : '';
                    inputHtml = `<div class="flex items-center gap-2 mt-2 sm:mt-0">${weightInput}<button onclick="toggleSetCheck(${dIdx}, ${eIdx}, 0, this)" class="w-10 h-10 hover:bg-green-500 rounded-xl transition-all border flex items-center justify-center ${btnClass}"><i data-lucide="check" class="w-5 h-5"></i></button></div>`;
                }

                return `<div class="py-3 border-b border-slate-800/50 flex flex-col sm:flex-row sm:items-center justify-between group hover:bg-slate-800/10 rounded-xl px-2 transition-colors">
                    <div class="flex-1 pr-4">
                        <div class="flex items-center flex-wrap">
                            <span class="text-white font-bold text-sm uppercase italic mr-2">${ex.name}</span>
                            ${vid}
                        </div>
                        <div class="flex gap-2 items-center mt-1">
                            <span class="text-[10px] text-blue-300 font-mono bg-blue-900/30 px-1.5 rounded">${ex.sets} x ${ex.reps}</span>
                            
                            <span class="text-[9px] text-yellow-500 font-bold uppercase tracking-tighter flex items-center gap-1 bg-yellow-900/20 px-2 rounded border border-yellow-500/10">
                                <i data-lucide="zap" class="w-3 h-3"></i> ${potentialKi} Ki ‚Ä¢ ${monthShort}
                            </span>
                        </div>
                        <div class="text-[10px] text-slate-500 italic mt-1 leading-tight">${ex.desc || ''}</div>
                    </div>
                    ${inputHtml}
                </div>`;
            }
        }).join('');

        const addBtn = isEditMode ? `<button onclick="addNewExercise(${dIdx})" class="w-full mt-2 py-2 bg-green-900/30 text-green-400 border border-green-800 border-dashed rounded-xl text-xs font-bold uppercase hover:bg-green-900/50 transition-all">+ A√±adir Ejercicio</button>` : '';

        return `<div id="day-card-${dIdx}" class="glass rounded-3xl shadow-lg border-l-4 ${color} mb-5 anime-border overflow-hidden transition-all">
            <div class="p-4 bg-slate-900/80 flex justify-between items-center border-b border-slate-800 shadow-sm">
                <h3 class="font-bold text-white text-[12px] uppercase tracking-widest italic flex items-center gap-2">
                    ${day.day} | ${day.title} 
                    <span class="text-[9px] text-slate-500 font-mono">(${cardDate.getDate()}/${monthShort})</span>
                </h3>
                <button onclick="editDay(${dIdx})" class="p-2 hover:bg-slate-700 rounded-xl transition-all text-slate-500 hover:text-white"><i data-lucide="edit-3" class="w-4 h-4"></i></button>
            </div>
            <div class="p-3 bg-slate-900/20">${exHtml}${addBtn}${day.notes ? `<div class="mt-3 text-[10px] text-yellow-200 bg-yellow-900/30 p-3 rounded-xl border border-yellow-500/10 flex gap-2 italic"><i data-lucide="sticky-note" class="w-4 h-4 mt-0.5 flex-shrink-0 text-yellow-500"></i>${day.notes}</div>` : ''}</div>
        </div>`;
    }).join('');
    lucide.createIcons();
}
		function changeWeek() {
            const selector = document.getElementById('week-selector');
            currentWeekIndex = parseInt(selector.value);
            renderPlan();
            // Esto hace que al cambiar de semana, el calendario se actualice visualmente
            updateCalendarDates(); 
        }

	function saveMultiSetWeight(d, e, s, el) {
		const inputs = el.parentElement.querySelectorAll('input');
		const vals = Array.from(inputs).map(i => i.value);
		appData.plan[currentWeekIndex].days[d].exercises[e].weight = vals.join('/');
		saveDataToCloud();
		
		// L√ìGICA AUTO-TIMER: Si hay valor, color verde y arranca el crono
		if(el.value !== "") {
			el.classList.add('completed-set'); 
			triggerAutoTimer(); 
		} else {
			el.classList.remove('completed-set');
		}
	}

	function saveWeight(d, e, v) {
		appData.plan[currentWeekIndex].days[d].exercises[e].weight = v;
		const n = parseFloat(v);
		if (!isNaN(n) && n > 0) {
			saveStrengthRecord(appData.plan[currentWeekIndex].days[d].exercises[e].name, n);
		}
		saveDataToCloud();

		// L√ìGICA AUTO-TIMER
		const inputEl = document.activeElement; 
		if(inputEl && inputEl.tagName === 'INPUT' && v !== "") {
			inputEl.classList.add('completed-set');
			triggerAutoTimer();
		} else if (inputEl) {
			inputEl.classList.remove('completed-set');
		}
	}
        function saveStrengthRecord(n, w) {
            if(!appData.strength[n]) appData.strength[n] = [];
            const today = new Date().toISOString().split('T')[0];
            const existing = appData.strength[n].find(e => e.date === today);
            if(existing) existing.weight = w; else appData.strength[n].push({ date: today, weight: w });
            updateExerciseSelector(); updatePRs();
        }
		function updateExerciseSelector() {
			const select = document.getElementById('exercise-select'); 
			if(!select) return;
			
			const keys = Object.keys(appData.strength).sort();
			const defaults = ["Prensa de Piernas", "Jal√≥n al Pecho", "Press Pecho M√°quina", "Extensi√≥n Cu√°driceps", "Curl Femoral", "Face Pull"];
			const all = [...new Set([...defaults, ...keys])];
			const curr = select.value;
			
			select.innerHTML = all.map(k => `<option value="${k}" ${k===curr?'selected':''}>${k}</option>`).join('');
			
			// IMPORTANTE: Forzamos la actualizaci√≥n de la tabla y gr√°fica al cargar el selector
			handleStrengthSelectChange();
		}
        function renderStrengthChart() {
            const select = document.getElementById('exercise-select'); if(!select) return;
            const data = (appData.strength[select.value] || []).sort((a,b) => new Date(a.date) - new Date(b.date));
            const canvas = document.getElementById('chartStrength'); if(!canvas) return;
            const ctx = canvas.getContext('2d'); if(strengthChartInstance) strengthChartInstance.destroy();
            strengthChartInstance = new Chart(ctx, { type: 'line', data: { labels: data.map(d=>d.date.slice(5)), datasets: [{ label: 'POTENCIA (KG)', data: data.map(d=>d.weight), borderColor: '#60a5fa', tension: 0.3, fill: true, backgroundColor: 'rgba(59,130,246,0.15)', pointBackgroundColor: '#fbbf24' }] }, options: { maintainAspectRatio: false, plugins: { legend: { display: false } } } });
        }
        function updatePRs() {
            const list = document.getElementById('pr-list'); if(!list) return;
            list.innerHTML = Object.keys(appData.strength).sort().map(k => {
                const max = Math.max(...appData.strength[k].map(d=>parseFloat(d.weight)||0));
                return max > 0 ? `<div class="flex justify-between items-center border-b border-slate-800 pb-2 mb-2 group hover:bg-slate-800/20 px-2 rounded-lg transition-all"><span class="text-slate-400 font-bold uppercase tracking-widest text-[10px] italic">${k}</span><span class="text-white font-bold scouter-font text-2xl tracking-tighter drop-shadow-md">${max}<span class="text-[10px] text-yellow-500 ml-1 font-sans">KG</span></span></div>` : '';
            }).join('');
        }

		
		
// --- LOGICA DE GUARDADO DE SALUD (INTELIGENTE) ---
		// --- GUARDADO DE SALUD BLINDADO ---
		// --- LOGICA DE GUARDADO DE SALUD ---
		document.getElementById('entryForm').addEventListener('submit', e => {
			e.preventDefault();
			
			// Funci√≥n auxiliar: Si el campo est√° vac√≠o, guarda null.
			// Si tiene algo, lo guarda como n√∫mero.
			const getVal = (id) => {
				const val = document.getElementById(id).value;
				return val === "" ? null : parseFloat(val);
			};

			const newEntry = {
				date: document.getElementById('inputDate').value,
				weight: parseFloat(document.getElementById('inputWeight').value),
				vfc: getVal('inputVfc'),
				rhr: getVal('inputRhr'),
				sleep: getVal('inputSleep')
			};
			
			// Si no existe el array, lo creamos
			if (!appData.progress) appData.progress = [];
			
			appData.progress.push(newEntry);
			saveDataToCloud(); 
			updateHistoryTable(); 
			
			// Limpieza visual
			e.target.reset();
			document.getElementById('inputDate').valueAsDate = new Date();
			document.getElementById('inputWeight').value = newEntry.weight; // Dejamos el peso puesto
			
			alert("‚úÖ Registro guardado correctamente.");
		});

		// --- FUNCI√ìN TABLA (SOLUCI√ìN ESTRUCTURAL) ---
		function updateHistoryTable() {
			const tbody = document.getElementById('historyTableBody'); 
			if(!tbody) return;
			
			const list = appData.progress || [];
			// Ordenamos y guardamos √≠ndice real
			const sorted = list.map((item, index) => ({...item, originalIndex: index}))
							   .sort((a,b) => new Date(b.date) - new Date(a.date));

			if (sorted.length === 0) {
				tbody.innerHTML = '<tr><td colspan="6" class="p-4 text-center text-slate-500 italic">Sin datos.</td></tr>';
				return;
			}

			tbody.innerHTML = sorted.map((r) => {
				// 1. LIMPIEZA DE DATOS (Nullish Coalescing)
				// Usamos ?? para que el 0 sea v√°lido. Si es null/undefined, probamos otros nombres.
				const valWeight = r.weight ?? r.inputWeight ?? r.peso;
				const valVfc    = r.vfc    ?? r.inputVfc;
				const valRhr    = r.rhr    ?? r.inputRhr   ?? r.ppm;
				const valSleep  = r.sleep  ?? r.inputSleep ?? r.sueno;

				// 2. FORMATEO VISUAL (Guiones visibles si no hay dato)
				// Peso
				const showWeight = (valWeight !== null && valWeight !== "") 
					? `<span class="text-white font-bold">${valWeight}</span>` 
					: '<span class="text-slate-600">--</span>';

				// VFC
				const showVfc = (valVfc !== null && valVfc !== "") 
					? `<span class="text-green-400 font-bold">${valVfc}</span>` 
					: '<span class="text-slate-600 font-bold">-</span>';

				// PPM
				const showRhr = (valRhr !== null && valRhr !== "") 
					? `<span class="text-red-400 font-bold">${valRhr}</span>` 
					: '<span class="text-slate-600 font-bold">-</span>';

				// SUE√ëO (La columna problem√°tica)
				const showSleep = (valSleep !== null && valSleep !== "") 
					? `<span class="text-purple-400 font-bold">${valSleep}h</span>` 
					: '<span class="text-slate-600 font-bold">-</span>';

				// 3. GENERACI√ìN DE FILA (6 CELDAS EXACTAS)
				return `
				<tr class="hover:bg-slate-800/40 transition-colors">
					<td class="px-2 py-3 font-mono text-slate-400 text-[10px] font-bold uppercase truncate">
						${r.date ? r.date.slice(5) : '??-??'}
					</td>
					
					<td class="px-1 py-3 text-center text-sm">
						${showWeight}
					</td>
					
					<td class="px-1 py-3 text-center text-xs">
						${showVfc}
					</td>

					<td class="px-1 py-3 text-center text-xs">
						${showRhr}
					</td>

					<td class="px-1 py-3 text-center text-xs">
						${showSleep}
					</td>
					
					<td class="px-2 py-3 text-right">
						<button onclick="delProg(${r.originalIndex})" class="bg-red-900/10 hover:bg-red-900/30 text-red-500 p-2 rounded-lg transition-colors">
							<i data-lucide="trash-2" class="w-4 h-4"></i>
						</button>
					</td>
				</tr>`;
			}).join('');
			
			lucide.createIcons(); 
			
			if (typeof renderStatsCharts === 'function') renderStatsCharts(); 
		}
		// --- FUNCI√ìN DE BORRADO DE SALUD ---
		function delProg(realIndex) { 
			if(confirm("¬øEliminar este registro de salud?")) { 
				// Borrado directo y seguro usando el √≠ndice real
				if (appData.progress && appData.progress[realIndex]) {
					appData.progress.splice(realIndex, 1); 
					saveDataToCloud(); 
					updateHistoryTable(); 
				} else {
					alert("Error al borrar: √≠ndice no encontrado.");
					// Recargar por si acaso
					updateHistoryTable();
				}
			} 
		}

		function renderStatsCharts() {
			const data = [...(appData.progress || [])].sort((a,b) => new Date(a.date) - new Date(b.date));
			if (data.length === 0) return;
			
			const lbs = data.map(d => d.date.slice(5)); // Fechas eje X

			// Funci√≥n constructora inteligente
			const buildSmartChart = (canvasId, containerId, label, rawData, color) => {
				const container = document.getElementById(containerId);
				const canvas = document.getElementById(canvasId);
				
                // Si no existe el elemento en el HTML, salimos sin error
				if(!container || !canvas) return;

				// 1. COMPROBACI√ìN INTELIGENTE: ¬øHay alg√∫n dato v√°lido en todo el historial?
				const hasData = rawData.some(v => v !== null && v !== 0 && v !== undefined && !isNaN(v));

				if (!hasData) {
					// NO HAY DATOS: Ocultamos el contenedor entero (el cuadro con borde)
					container.classList.add('hidden');
					return; // No dibujamos nada m√°s
				} else {
					// S√ç HAY DATOS: Mostramos el contenedor
					container.classList.remove('hidden');
				}

				const ctx = canvas.getContext('2d');
				// Destruir gr√°fica anterior para evitar bugs visuales
				if(window[canvasId+'Inst']) window[canvasId+'Inst'].destroy();
				
				window[canvasId+'Inst'] = new Chart(ctx, { 
					type: 'line', 
					data: { 
						labels: lbs, 
						datasets: [{ 
							label, 
							data: rawData, 
							borderColor: color, 
							backgroundColor: color+'15', 
							fill: true, 
							tension: 0.3, 
							pointRadius: 3,
                            // CR√çTICO: spanGaps true une los puntos aunque haya d√≠as vac√≠os (null) entre medias
							spanGaps: true 
						}] 
					}, 
					options: { 
						maintainAspectRatio: false, 
						plugins: { legend: { display: false } }, 
						scales: { 
							x: { display: false }, 
							y: { ticks: { color: '#64748b', font: { size: 9 } }, grid: { color: 'rgba(255,255,255,0.05)' } } 
						} 
					} 
				});
			};

			buildSmartChart('chartWeight', 'container-weight', 'Peso', data.map(d=>d.weight), '#3b82f6');
			buildSmartChart('chartVfc', 'container-vfc', 'VFC', data.map(d=>d.vfc), '#22c55e');
			buildSmartChart('chartRhr', 'container-rhr', 'PPM', data.map(d=>d.rhr), '#ef4444');
			buildSmartChart('chartSleep', 'container-sleep', 'Sue√±o', data.map(d=>d.sleep), '#a855f7');
		}
		// --- FUNCI√ìN DE BORRADO DE SALUD ---
		function delProg(realIndex) { 
			if(confirm("¬øEliminar este registro de salud?")) { 
				// Borrado directo y seguro usando el √≠ndice real
				if (appData.progress && appData.progress[realIndex]) {
					appData.progress.splice(realIndex, 1); 
					saveDataToCloud(); 
					updateHistoryTable(); 
				} else {
					alert("Error al borrar: √≠ndice no encontrado.");
					// Recargar por si acaso
					updateHistoryTable();
				}
			} 
		}

        function openSuppModal(id) {
            document.getElementById('suppForm').reset();
            document.getElementById('suppId').value = id || '';
            const s = id ? appData.supplements.find(i=>i.id===id) : null;
            if(s) {
                document.getElementById('suppName').value=s.name; document.getElementById('suppDose').value=s.dose; 
                document.getElementById('suppTiming').value=s.timing; document.getElementById('suppDesc').value=s.desc;
                document.getElementById('suppActive').checked=s.active;
                document.getElementById('btn-delete-supp').classList.remove('hidden');
            } else {
                document.getElementById('suppActive').checked=true;
                document.getElementById('btn-delete-supp').classList.add('hidden');
            }
            document.getElementById('supp-modal').classList.remove('hidden');
        }
        function closeSuppModal() { document.getElementById('supp-modal').classList.add('hidden'); }
        function deleteCurrentSupp() { const id=document.getElementById('suppId').value; if(confirm("¬øBorrar?")){ appData.supplements=appData.supplements.filter(s=>s.id!==id); saveDataToCloud(); renderSupplements(); closeSuppModal(); } }
        document.getElementById('suppForm').addEventListener('submit', e=>{
            e.preventDefault(); const id=document.getElementById('suppId').value;
            const obj={ id:id||"s"+Date.now(), name:document.getElementById('suppName').value, dose:document.getElementById('suppDose').value, timing:document.getElementById('suppTiming').value, desc:document.getElementById('suppDesc').value, active:document.getElementById('suppActive').checked };
            if(id) { const i=appData.supplements.findIndex(x=>x.id===id); if(i>-1) appData.supplements[i]=obj; } else { appData.supplements.push(obj); }
            saveDataToCloud(); renderSupplements(); closeSuppModal();
        });

        // --- ESP√çA (SHARINGAN) ---
		async function openSpyModal() {
            const l = document.getElementById('spy-user-list');
            l.innerHTML = '<span class="text-xs animate-pulse p-4">Escaneando guerreros...</span>';
            document.getElementById('spy-modal').classList.remove('hidden');

            try {
                // Buscamos a todos los usuarios en la tabla de ranking
                const snap = await db.collection('leaderboard').get();
                spyUsersCache = [];
                snap.forEach(doc => { 
                    if(doc.id !== currentUser.uid) {
                        spyUsersCache.push({id: doc.id, name: doc.data().nickname}); 
                    }
                });
                
                l.innerHTML = spyUsersCache.map(u => `
                    <button onclick="loadSpyPlan('${u.id}')" class="bg-slate-800 text-slate-300 border border-slate-700 px-6 py-4 rounded-2xl text-[10px] whitespace-nowrap hover:bg-purple-900 transition-all font-bold uppercase italic tracking-widest">
                        ${u.name}
                    </button>
                `).join('') || '<span class="text-xs text-slate-500 italic p-4">No hay se√±ales de otros clanes.</span>';
            } catch(e) {
                console.error(e);
                l.innerHTML = '<span class="text-red-500 text-xs p-4">Fallo en el radar.</span>';
            }
        }
        function closeSpyModal() { document.getElementById('spy-modal').classList.add('hidden'); }

        async function loadSpyPlan(uid) {
            const container = document.getElementById('spy-weeks-container');
            container.innerHTML = '<p class="text-center animate-pulse text-purple-400 text-xs font-bold uppercase mt-20 tracking-widest italic">Interceptando se√±al remota...</p>';
            try {
                const doc = await db.collection('users').doc(uid).get();
                if(doc.exists && doc.data().plan) {
                    container.innerHTML = doc.data().plan.map(w => `
                        <div class="bg-slate-900/70 border border-slate-800 p-5 rounded-2xl flex justify-between items-center mb-4 shadow-xl border-l-4 border-purple-500/50">
                            <p class="text-white text-xs font-bold uppercase italic tracking-tighter">${w.label || "T√°ctica"}</p>
                            <div class="flex gap-3">
                                <button onclick='previewSpyWeek(${JSON.stringify(w).replace(/'/g,"&#39;")})' class="bg-blue-600/30 text-blue-200 px-4 py-2 rounded-xl text-[10px] border border-blue-500/40 hover:bg-blue-600 font-bold uppercase transition-all italic">Ojeada</button>
                                <button onclick='copySpyWeek(${JSON.stringify(w).replace(/'/g,"&#39;")})' class="bg-green-700/80 text-white px-4 py-2 rounded-xl text-[10px] font-bold hover:bg-green-600 uppercase transition-all italic shadow-lg">Clonar</button>
                            </div>
                        </div>`).join('');
                } else container.innerHTML = '<p class="text-red-400 text-center text-[10px] uppercase font-bold mt-20">Terminal encriptado.</p>';
            } catch(e) { container.innerHTML = '<p class="text-red-400 text-center text-xs mt-20 uppercase">Fallo de enlace.</p>'; }
        }
        function previewSpyWeek(w) {
            spyPendingWeek = w;
            document.getElementById('spy-preview-content').innerHTML = w.days.map(d => `<div class="border-b border-slate-900 pb-3 mb-3"><p class="text-yellow-400 font-bold text-[11px] uppercase italic tracking-widest mb-1">${d.day}: ${d.title}</p><ul class="text-[10px] text-slate-400 list-disc ml-5 space-y-1">${d.exercises.map(e => `<li><span class="text-slate-200">${e.name}</span> <span class="text-[9px] text-blue-400 font-mono ml-1">(${e.sets}x${e.reps})</span></li>`).join('')}</ul></div>`).join('');
            document.getElementById('spy-preview-modal').classList.remove('hidden');
        }
        function closeSpyPreview() { document.getElementById('spy-preview-modal').classList.add('hidden'); spyPendingWeek = null; }
        document.getElementById('btn-copy-preview').onclick = () => { if(spyPendingWeek) copySpyWeek(spyPendingWeek); };
        function copySpyWeek(w) {
            if(confirm(`¬øClonar "${w.label}"?`)){
                const nw = JSON.parse(JSON.stringify(w)); nw.id = "clon-" + Date.now(); nw.label = (nw.label || "Semana") + " (Copia)"; appData.plan.push(nw);
                saveDataToCloud(); alert("Protocolo clonado."); closeSpyPreview(); closeSpyModal(); changeWeek();
            }
        }

        // --- IA PROMPT MAESTRO ---
		function copyPrompt() {
			// 1. SEGURIDAD: Comprobar Datos Obligatorios
			if (!appData.targetWeight || appData.targetWeight <= 0 || !appData.injuries) {
				alert("‚ö†Ô∏è ¬°FALTAN DATOS!\n\nPor favor, rellena tu META DE PESO y tus LESIONES en la secci√≥n 'Objetivos & Limitaciones' (Perfil).");
				document.getElementById('profile-target').focus();
				return;
			}

			const today = new Date();
			const dStr = today.toLocaleDateString('es-ES', { day: 'numeric', month: 'long' });
			
			// Obtener datos reales
			const ultimoPeso = appData.progress.length > 0 ? appData.progress[appData.progress.length-1].weight : "No registrado";
			const misSupps = appData.supplements.length > 0 ? appData.supplements.map(s => s.name).join(", ") : "Ninguna";
			
			// --- L√ìGICA CORREGIDA ---
			// Si NO hay planes (array vac√≠o), es modo G√âNESIS (Semana 1).
			// Si HAY alg√∫n plan (aunque sea la Semana 1), es modo EVOLUCI√ìN (Semana 2+).
			let isGenesisMode = false;
			
			if (appData.plan.length === 0) {
				isGenesisMode = true;
			}

			let prompt = "";

			if (isGenesisMode) {
				// --- MODO G√âNESIS (Principiante / Reset total) ---
				prompt = `Act√∫a como mi entrenador personal Saiyan experto en biomec√°nica.
		Genera el c√≥digo JSON para mi SEMANA 1 de entrenamiento.

		DATOS DEL GUERRERO:
		- Peso Actual: ${ultimoPeso} kg.
		- Meta de Peso: ${appData.targetWeight} kg.
		- Lesiones (CR√çTICO): ${appData.injuries}.
		- Suplementaci√≥n: ${misSupps}.

		INSTRUCCIONES T√âCNICAS:
		1. Responde SOLO con el c√≥digo JSON.
		2. Estructura de 7 d√≠as.
		3. Usa "track": true para ejercicios de pesas.
		4. Basa el dise√±o en los OBJETIVOS que escribo abajo.

		ESTRUCTURA JSON REQUERIDA:
		{
		  "id": "gen-w1-${Date.now()}",
		  "label": "Semana 1: El Despertar",
		  "days": [ ... ]
		}

		üëá EL USUARIO DEBE COMPLETAR ESTO AQU√ç ABAJO üëá
		-------------------------------------------------------
		OBJETIVO PRINCIPAL: [ESCRIBE AQU√ç]
		D√çAS DISPONIBLES: [ESCRIBE AQU√ç]
		PREFERENCIAS: [ESCRIBE AQU√ç]
		-------------------------------------------------------`;
				
				alert("üìã MODO G√âNESIS COPIADO (No se detectaron planes previos).");

			} else {
				// --- MODO EVOLUCI√ìN (Siguiente Nivel) ---
				// Cogemos el plan que tienes seleccionado actualmente en pantalla
				const planActual = JSON.stringify(appData.plan[currentWeekIndex] || {}, null, 2);
				const nombrePlan = appData.plan[currentWeekIndex].label;

				prompt = `Act√∫a como entrenador Saiyan. He completado el ciclo: "${nombrePlan}".
		DATOS ACTUALIZADOS:
		- Peso: ${ultimoPeso}kg.
		- Meta: ${appData.targetWeight}kg.
		- Lesiones: ${appData.injuries}.

		TAREA: Genera el JSON de la SIGUIENTE semana (Evoluci√≥n) empezando el ${dStr}.

		REGLAS DE PROGRESI√ìN (SOBRECARGA PROGRESIVA):
		1. Aumenta la dificultad respecto al JSON que te pego abajo (sube peso, reps, o cambia a ejercicios m√°s complejos).
		2. Mant√©n la estructura de d√≠as si funciona, pero optimiza el volumen.
		3. Respeta estrictamente mis lesiones.

		PLAN ANTERIOR (BASE):
		${planActual}

		ESTRUCTURA RESPUESTA: Solo el JSON v√°lido. Usa IDs nuevos.

		üëá MODIFICACIONES T√ÅCTICAS (Opcional) üëá
		-------------------------------------------------------
		CAMBIOS DESEADOS: [Escribe aqu√≠ si quieres cambiar algo espec√≠fico, ej: "Quiero entrenar 5 d√≠as en vez de 4" o "Me duele la rodilla con las zancadas". Si no, d√©jalo en blanco.]
		-------------------------------------------------------`;
				
				alert("üî• MODO EVOLUCI√ìN COPIADO.\n\nEl sistema usar√° tu semana actual como base para crear una m√°s dura.");
			}

			navigator.clipboard.writeText(prompt);
		}
        // --- UTILS RESTANTES ---
		function switchTab(id) {
			// 1. Ocultar todas
			document.querySelectorAll('.tab-content').forEach(e => {
				e.classList.add('hidden-tab');
				e.classList.add('hidden'); 
			});
			// 2. Desactivar botones
			document.querySelectorAll('.nav-btn').forEach(e => e.classList.remove('active')); 
			
			// 3. Mostrar target
			const target = document.getElementById(`tab-${id}`);
			if(target) {
				target.classList.remove('hidden-tab');
				target.classList.remove('hidden');
			}
			
			// 4. Activar bot√≥n
			const btn = document.getElementById(`btn-${id}`); 
			if(btn) btn.classList.add('active'); 

			// 5. Cargas autom√°ticas
			if(id==='strength') { renderStrengthChart(); updatePRs(); }
			if(id==='running') updateRunningUI();
			
			// AHORA PROFILE CARGA TODO LO DE SALUD
			if(id==='profile') { 
				document.getElementById('profile-target').value = appData.targetWeight || "";
				document.getElementById('profile-injuries').value = appData.injuries || "";
				updateHistoryTable(); // Esto carga la tabla Y las gr√°ficas de salud
			}
			
			if(id==='ranking') { 
				loadLeaderboard(); 
				updateHomeMiniStats(); 
			}
			
			if(id==='supplements') renderSupplements();
			if(id==='home') updateHomeMiniStats();
			
			lucide.createIcons();
		}


        function renderStatsCharts() {
            const data = [...appData.progress].sort((a,b) => new Date(a.date) - new Date(b.date));
            if (data.length === 0) return;
            const lbs = data.map(d => d.date.slice(5));

            const build = (id, label, set, col) => {
                const canvas = document.getElementById(id); if(!canvas) return;
                const ctx = canvas.getContext('2d'); 
                if(window[id+'Inst']) window[id+'Inst'].destroy();
                window[id+'Inst'] = new Chart(ctx, { 
                    type: 'line', 
                    data: { labels: lbs, datasets: [{ label, data: set, borderColor: col, backgroundColor: col+'15', fill: true, tension: 0.3, pointRadius: 2 }] }, 
                    options: { maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { display: false }, y: { ticks: { color: '#64748b', font: { size: 8 } } } } } 
                });
            };

            build('chartWeight', 'Peso', data.map(d=>d.weight), '#3b82f6');
            build('chartVfc', 'VFC', data.map(d=>d.vfc), '#22c55e');
            build('chartRhr', 'PPM', data.map(d=>d.rhr), '#ef4444');
            build('chartSleep', 'Sue√±o', data.map(d=>d.sleep), '#a855f7');
        }


        function toggleSettings() { document.getElementById('settings-panel').classList.toggle('hidden'); }
        function changeNickname() { const n=prompt("Nuevo apodo:", appData.nickname); if(n){ appData.nickname=n; document.getElementById('header-username').innerText=n; saveDataToCloud(); } }
        function changeGroup() { const g=prompt("Nuevo clan:", appData.group); if(g){ appData.group=g.trim(); saveDataToCloud(); loadLeaderboard(); } }
        function resetDefaultPlan() { if(confirm("¬øRestaurar plan inicial?")){ appData.plan = [{id:"w-res-"+Date.now(), label:"Semana 1 (Inicio)", days:getDefaultPlan()}]; saveDataToCloud(); renderPlan(); } }
        function editDay(i) { const n=prompt("Notas t√°cticas de campo:", appData.plan[currentWeekIndex].days[i].notes); if(n!==null){ appData.plan[currentWeekIndex].days[i].notes=n; saveDataToCloud(); renderPlan(); } }
        
		function editDay(i) { 
            const n = prompt("Notas t√°cticas de campo:", appData.plan[currentWeekIndex].days[i].notes); 
            if(n !== null) { 
                appData.plan[currentWeekIndex].days[i].notes = n; 
                saveDataToCloud(); 
                renderPlan(); 
            } 
        }
		function updateProfileData() {
            appData.targetWeight = parseFloat(document.getElementById('profile-target').value) || 0;
            appData.injuries = document.getElementById('profile-injuries').value || "";
            saveDataToCloud(); // Guarda autom√°ticamente en Firebase
        }
		function importNewWeek() { 
			try { 
				let text = document.getElementById('import-code-area').value.trim();
				text = text.replace(/```json/g, "").replace(/```/g, "").trim();
				
				const w = JSON.parse(text); 
				if(!w.days) throw new Error("Formato inv√°lido"); 
				
				w.label = w.label || w.title || `Ciclo Z ${appData.plan.length + 1}`;
				w.id = w.id || "tactica-" + Date.now();

				// DETECCI√ìN ROBUSTA (Id√©ntica a copyPrompt)
				let isExamplePlan = true;
				if (appData.plan.length > 0) {
					const first = appData.plan[0];
					if (first.id !== 'w-init' && !first.label.includes('Protocolo Inicial') && !first.label.includes('Semana 1')) {
						isExamplePlan = false;
					}
				}

				if (isExamplePlan) {
					if(confirm("‚ö† DETECTADO PLAN DE INICIO.\n\n¬øQuieres SOBRESCRIBIRLO con esta nueva rutina personalizada?\n(Recomendado para empezar limpio)")) {
						appData.plan = [w]; 
						currentWeekIndex = 0;
						alert("üöÄ ¬°Plan de Ejemplo eliminado! Tu Semana 1 comienza ahora.");
					} else {
						appData.plan.push(w); 
						currentWeekIndex = appData.plan.length - 1;
					}
				} else {
					appData.plan.push(w); 
					currentWeekIndex = appData.plan.length - 1;
					alert("‚úÖ ¬°Nueva semana cargada! A por la sobrecarga."); 
				}

				saveDataToCloud(); 
				renderPlan(); 
				toggleSettings(); 
				document.getElementById('import-code-area').value = "";
				
			} catch(e) { 
				alert("‚ùå ERROR: El c√≥digo JSON es incorrecto. Aseg√∫rate de copiar solo el c√≥digo que te da la IA."); 
			} 
		}

        function deleteCurrentWeek() {
            if (appData.plan.length <= 1) {
                alert("No puedes borrar el √∫ltimo protocolo. El sistema requiere al menos un plan activo.");
                return;
            }
            if (confirm(`¬øEliminar permanentemente "${appData.plan[currentWeekIndex].label}"?`)) {
                appData.plan.splice(currentWeekIndex, 1);
                currentWeekIndex = Math.max(0, currentWeekIndex - 1);
                saveDataToCloud();
                renderPlan();
                toggleSettings();
                alert("Ciclo eliminado.");
            }
        }

        function resetDefaultPlan() {
            if(confirm("¬øRestaurar plan inicial? Se borrar√°n todos tus ciclos actuales.")){ 
                appData.plan = [{id:"w-res-"+Date.now(), label:"Semana 1 (Inicio)", days:getDefaultPlan()}]; 
                currentWeekIndex = 0;
                saveDataToCloud(); 
                renderPlan(); 
                toggleSettings();
            } 
        }
		function resetDefaultPlan() { if(confirm("¬øRestaurar plan inicial?")){ appData.plan = [{id:"w-res-"+Date.now(), label:"Semana 1 (Inicio)", days:getDefaultPlan()}]; currentWeekIndex = 0; saveDataToCloud(); renderPlan(); toggleSettings(); } }
				
				/* --- TU PLAN ORIGINAL CON V√çDEOS A√ëADIDOS --- */
				        /* --- TU PLAN MAESTRO 360¬∫ (MODIFICADO) --- */
        function getDefaultPlan() {
            return [
                {
                  "day": "Lunes",
                  "title": "Torso + Higiene Postural",
                  "notes": "Desayuno: Avena+Prote (07:00). Comida: Omega3 (15:30). Cena: Magnesio.",
                  "type": "gym",
                  "id": "d1-lun",
                  "exercises": [
                    {
                      "name": "‚òÄÔ∏è TRABAJO: El Flamenco",
                      "sets": "1", "reps": "Check", "track": false,
                      "desc": "Cada hora: Lev√°ntate, ponte a la pata coja 10 seg/lado. Activa gl√∫teo y despierta el equilibrio.",
                      "vid": "https://www.youtube.com/results?search_query=ejercicio+equilibrio+unipodal"
                    },
                    {
                      "name": "‚òÄÔ∏è TRABAJO: Abrazo al Mundo",
                      "sets": "1", "reps": "Check", "track": false,
                      "desc": "Sentado: Encorva la espalda estirando brazos al frente, luego abre brazos y saca pecho. 3 veces.",
                      "vid": "https://www.youtube.com/results?search_query=movilidad+toracica+sentado"
                    },
                    {
                      "name": "üî• CALENTAMIENTO GYM",
                      "sets": "5", "reps": "min", "track": false,
                      "desc": "El√≠ptica ritmo suave. Sube la temperatura corporal.",
                      "vid": "https://www.youtube.com/results?search_query=calentamiento+eliptica"
                    },
                    {
                      "name": "Movilidad: Libro Abierto",
                      "sets": "1", "reps": "10/lado", "track": false,
                      "desc": "Tumbado de lado, gira el torso. Desbloquea tu dolor de esc√°pula.",
                      "vid": "https://www.youtube.com/results?search_query=ejercicio+libro+abierto+movilidad"
                    },
                    {
                      "name": "Remo en M√°quina (Apoyo Pecho)",
                      "sets": "3", "reps": "12", "track": true, "weight": "47/47/47",
                      "desc": "Haz 1 serie sin peso antes. Luego pon tu peso. El apoyo protege tu lumbar.",
                      "vid": "https://www.youtube.com/results?search_query=tecnica+remo+maquina+pecho+apoyado"
                    },
                    {
                      "name": "Press Banca Multipower",
                      "sets": "3", "reps": "10-12", "track": true, "weight": "40/50/50",
                      "desc": "Baja controlando hasta el pecho. Pies clavados en el suelo.",
                      "vid": "https://www.youtube.com/results?search_query=tecnica+press+banca+multipower"
                    },
                    {
                      "name": "Jal√≥n al Pecho",
                      "sets": "3", "reps": "12", "track": true, "weight": "41/41/41",
                      "desc": "Lleva la barra a la clav√≠cula. Espalda recta.",
                      "vid": "https://www.youtube.com/results?search_query=tecnica+jalon+al+pecho"
                    },
                    {
                      "name": "Press Hombros Sentado",
                      "sets": "3", "reps": "12", "track": true, "weight": "23/23/23",
                      "desc": "Espalda pegada al respaldo. Sube sin chocar mancuernas.",
                      "vid": "https://www.youtube.com/results?search_query=tecnica+press+hombros+mancuernas"
                    },
                    {
                      "name": "Face Pull",
                      "sets": "3", "reps": "15", "track": true, "weight": "23/23/23",
                      "desc": "Tira a la frente. Corrige postura de ordenador.",
                      "vid": "https://www.youtube.com/results?search_query=tecnica+face+pull"
                    },
                    {
                      "name": "Cardio: El√≠ptica",
                      "sets": "20", "reps": "min", "track": false,
                      "desc": "Ritmo medio. Sin impacto."
                    },
                    {
                      "name": "üåô NOCHE: Cadera 90/90",
                      "sets": "1", "reps": "Check", "track": false,
                      "desc": "Sentado en suelo, piernas 90¬∫. Lado a lado suavemente.",
                      "vid": "https://www.youtube.com/results?search_query=movilidad+cadera+90+90"
                    }
                  ]
                },
                {
                  "day": "Martes",
                  "title": "Pierna Segura + Psoas",
                  "notes": "Foco hoy: Espalda NEUTRA (ni arqueada ni chepa).",
                  "type": "gym",
                  "id": "d2-mar",
                  "exercises": [
                    {
                      "name": "‚òÄÔ∏è TRABAJO: Estiramiento Psoas",
                      "sets": "1", "reps": "Check", "track": false,
                      "desc": "Zancada atr√°s, aprieta culo. Siente tir√≥n en la ingle.",
                      "vid": "https://www.youtube.com/results?search_query=estiramiento+psoas+de+pie"
                    },
                    {
                      "name": "üî• CALENTAMIENTO GYM",
                      "sets": "5", "reps": "min", "track": false,
                      "desc": "El√≠ptica o Bici suave."
                    },
                    {
                      "name": "Movilidad: Gato-Camello",
                      "sets": "1", "reps": "10", "track": false,
                      "desc": "Cuadrupedia. Arquea y redondea espalda.",
                      "vid": "https://www.youtube.com/results?search_query=ejercicio+gato+camello"
                    },
                    {
                      "name": "Plancha Abdominal",
                      "sets": "3", "reps": "30seg", "track": false,
                      "desc": "Activa cintur√≥n natural. Para si duele lumbar.",
                      "vid": "https://www.youtube.com/results?search_query=tecnica+plancha+abdominal"
                    },
                    {
                      "name": "Prensa de Piernas",
                      "sets": "3", "reps": "12-15", "track": true,
                      "desc": "Pies altos en plataforma. Calienta con mitad de peso.",
                      "vid": "https://www.youtube.com/results?search_query=tecnica+prensa+45+grados"
                    },
                    {
                      "name": "Goblet Squat",
                      "sets": "3", "reps": "10", "track": true,
                      "desc": "Mancuerna al pecho. Baja lento abriendo rodillas.",
                      "vid": "https://www.youtube.com/results?search_query=tecnica+goblet+squat"
                    },
                    {
                      "name": "Extensi√≥n Cu√°driceps",
                      "sets": "3", "reps": "15", "track": true,
                      "desc": "Sin patadas bruscas. Aguanta 1s arriba.",
                      "vid": "https://www.youtube.com/results?search_query=tecnica+extension+cuadriceps"
                    },
                    {
                      "name": "Curl Femoral Tumbado",
                      "sets": "3", "reps": "12-15", "track": true,
                      "desc": "Cadera pegada al banco. Vital rodilla.",
                      "vid": "https://www.youtube.com/results?search_query=tecnica+curl+femoral+tumbado"
                    },
                    {
                      "name": "Gemelo (Talones)",
                      "sets": "3", "reps": "20", "track": true,
                      "desc": "Pausas abajo. Estira bien (periostitis).",
                      "vid": "https://www.youtube.com/results?search_query=tecnica+gemelo+maquina"
                    },
                    {
                      "name": "üåô NOCHE: La Rana",
                      "sets": "1", "reps": "Check", "track": false,
                      "desc": "Rodillas al suelo separadas. Culo atr√°s.",
                      "vid": "https://www.youtube.com/results?search_query=estiramiento+rana+yoga"
                    }
                  ]
                },
                {
                  "day": "Mi√©rcoles",
                  "title": "Descanso Activo",
                  "type": "rest",
                  "id": "d3-mie",
                  "notes": "D√≠a sin pesas. Cumple los snacks de trabajo.",
                  "exercises": [
                    {
                      "name": "‚òÄÔ∏è TRABAJO: Cuello y Hombros",
                      "sets": "1", "reps": "Check", "track": false,
                      "desc": "Mueve cuello suave. Rota hombros atr√°s 10 veces.",
                      "vid": "https://www.youtube.com/results?search_query=ejercicios+movilidad+cuello+oficina"
                    },
                    {
                      "name": "Caminata Aire Libre",
                      "sets": "45", "reps": "min", "track": false,
                      "desc": "Camina ligero. Sin impacto."
                    },
                    {
                      "name": "Estiramiento Pectoral (Marco)",
                      "sets": "1", "reps": "Check", "track": false,
                      "desc": "Antebrazo en marco puerta, gira cuerpo. Abre pecho.",
                      "vid": "https://www.youtube.com/results?search_query=estiramiento+pectoral+marco+puerta"
                    },
                    {
                      "name": "üåô NOCHE: Respiraci√≥n 4-7-8",
                      "sets": "1", "reps": "Check", "track": false,
                      "desc": "Inhala 4s, aguanta 7s, exhala 8s.",
                      "vid": "https://www.youtube.com/results?search_query=tecnica+respiracion+4-7-8"
                    }
                  ]
                },
                {
                  "day": "Jueves",
                  "title": "Torso + Postura",
                  "type": "gym",
                  "id": "d4-jue",
                  "notes": "Revisa Omega 3. Mejora t√©cnica de Remo.",
                  "exercises": [
                    {
                      "name": "‚òÄÔ∏è TRABAJO: Sentadilla Silla",
                      "sets": "1", "reps": "Check", "track": false,
                      "desc": "Al ir al ba√±o, 5 sentadillas al aire antes de sentarte.",
                      "vid": "https://www.youtube.com/results?search_query=tecnica+sentadilla+aire"
                    },
                    {
                      "name": "üî• CALENTAMIENTO GYM",
                      "sets": "5", "reps": "min", "track": false
                    },
                    {
                      "name": "Movilidad: Libro Abierto",
                      "sets": "1", "reps": "Check", "track": false,
                      "desc": "Lado derecho e izquierdo.",
                      "vid": "https://www.youtube.com/results?search_query=ejercicio+libro+abierto"
                    },
                    {
                      "name": "Jal√≥n al Pecho",
                      "sets": "3", "reps": "12", "track": true,
                      "desc": "Serie aprox primero.",
                      "vid": "https://www.youtube.com/results?search_query=tecnica+jalon+al+pecho"
                    },
                    {
                      "name": "Press Banca Mancuernas",
                      "sets": "3", "reps": "10-12", "track": true,
                      "desc": "Control total. Baja peso si tiemblas.",
                      "vid": "https://www.youtube.com/results?search_query=tecnica+press+banca+mancuernas"
                    },
                    {
                      "name": "Remo en M√°quina",
                      "sets": "3", "reps": "12", "track": true,
                      "desc": "Codos pegados al cuerpo.",
                      "vid": "https://www.youtube.com/results?search_query=tecnica+remo+maquina"
                    },
                    {
                      "name": "Press Hombros",
                      "sets": "3", "reps": "12", "track": true,
                      "desc": "Mant√©n tensi√≥n.",
                      "vid": "https://www.youtube.com/results?search_query=tecnica+press+hombros+maquina"
                    },
                    {
                      "name": "Face Pull",
                      "sets": "3", "reps": "15", "track": true,
                      "desc": "Rompe la cuerda hacia la cara.",
                      "vid": "https://www.youtube.com/results?search_query=tecnica+face+pull"
                    },
                    {
                      "name": "üåô NOCHE: Ni√±o (Yoga)",
                      "sets": "1", "reps": "Check", "track": false,
                      "desc": "Culo a talones, brazos delante. Relaja lumbar.",
                      "vid": "https://www.youtube.com/results?search_query=postura+nino+yoga"
                    }
                  ]
                },
                {
                  "day": "Viernes",
                  "title": "Pierna + Fin de Semana",
                  "type": "gym",
                  "id": "d5-vie",
                  "notes": "√öltimo esfuerzo. Cumple aunque bajes peso.",
                  "exercises": [
                    {
                      "name": "‚òÄÔ∏è TRABAJO: Psoas de Pie",
                      "sets": "1", "reps": "Check", "track": false,
                      "desc": "Zancada atr√°s, aprieta culo.",
                      "vid": "https://www.youtube.com/results?search_query=estiramiento+psoas+pie"
                    },
                    {
                      "name": "Activaci√≥n Gl√∫teo",
                      "sets": "2", "reps": "15", "track": false,
                      "desc": "Puente de gl√∫teo en suelo.",
                      "vid": "https://www.youtube.com/results?search_query=puente+gluteo+suelo"
                    },
                    {
                      "name": "Prensa de Piernas",
                      "sets": "3", "reps": "12-15", "track": true,
                      "desc": "Pies bien colocados.",
                      "vid": "https://www.youtube.com/results?search_query=tecnica+prensa+piernas"
                    },
                    {
                      "name": "Goblet Squat",
                      "sets": "3", "reps": "10", "track": true,
                      "desc": "Si duele espalda, haz Sentadilla Caj√≥n.",
                      "vid": "https://www.youtube.com/results?search_query=tecnica+goblet+squat"
                    },
                    {
                      "name": "Curl Femoral",
                      "sets": "3", "reps": "15", "track": true,
                      "desc": "Lento. 2 seg bajada.",
                      "vid": "https://www.youtube.com/results?search_query=tecnica+curl+femoral"
                    },
                    {
                      "name": "Extensi√≥n Cu√°driceps",
                      "sets": "3", "reps": "15", "track": true,
                      "desc": "Aguanta el quemaz√≥n.",
                      "vid": "https://www.youtube.com/results?search_query=tecnica+extension+cuadriceps"
                    },
                    {
                      "name": "Gemelo",
                      "sets": "3", "reps": "20", "track": true,
                      "desc": "Rango completo.",
                      "vid": "https://www.youtube.com/results?search_query=tecnica+gemelo+maquina"
                    },
                    {
                      "name": "üåô NOCHE: Piernas en Alto",
                      "sets": "1", "reps": "Check", "track": false,
                      "desc": "Piernas en pared 5 min. Circulaci√≥n.",
                      "vid": "https://www.youtube.com/results?search_query=beneficios+piernas+arriba"
                    }
                  ]
                },
                {
                  "day": "S√°bado",
                  "title": "Test CA-CO (Tibia)",
                  "type": "run",
                  "id": "d6-sab",
                  "notes": "Vitamina D. Escucha a tus tibias.",
                  "exercises": [
                    {
                      "name": "Caminar R√°pido",
                      "sets": "5", "reps": "min", "track": false,
                      "desc": "Calentamiento tobillos."
                    },
                    {
                      "name": "Bloque CA-CO x8",
                      "sets": "40", "reps": "min", "track": false,
                      "desc": "4 min Caminar / 1 min Trote suave. Repite 8 veces.",
                      "vid": "https://www.youtube.com/results?search_query=metodo+caco+correr"
                    },
                    {
                      "name": "‚ö†Ô∏è SEM√ÅFORO PERIOSTITIS",
                      "sets": "1", "reps": "Info", "track": false,
                      "desc": "Dolor=ROJO (Para). Molestia=AMARILLO. Nada=VERDE.",
                      "vid": "https://www.youtube.com/results?search_query=sintomas+periostitis+tibial"
                    },
                    {
                      "name": "üåô NOCHE: Masaje Plantar",
                      "sets": "1", "reps": "Check", "track": false,
                      "desc": "Masajea planta con pelota tenis.",
                      "vid": "https://www.youtube.com/results?search_query=masaje+miofascial+pie+pelota"
                    }
                  ]
                },
                {
                  "day": "Domingo",
                  "title": "Descanso & Prep",
                  "type": "rest",
                  "id": "d7-dom",
                  "notes": "Prepara tuppers de Avena+Prote√≠na.",
                  "exercises": [
                    {
                      "name": "Meal Prep (Avenas)",
                      "sets": "1", "reps": "Check", "track": false,
                      "desc": "Deja listos desayunos Lunes-Mi√©rcoles.",
                      "vid": "https://www.youtube.com/results?search_query=receta+avena+nocturna+proteica"
                    },
                    {
                      "name": "Movilidad: 90/90",
                      "sets": "10", "reps": "reps", "track": false,
                      "desc": "Suave en el sal√≥n.",
                      "vid": "https://www.youtube.com/results?search_query=movilidad+cadera+90+90"
                    },
                    {
                      "name": "üåô NOCHE: Respiraci√≥n Relax",
                      "sets": "5", "reps": "min", "track": false,
                      "desc": "Desconexi√≥n para el lunes.",
                      "vid": "https://www.youtube.com/results?search_query=respiracion+para+dormir"
                    }
                  ]
                }
            ];
        }
		function getDefaultSupplements() { return [{ id: '1', name: 'Prote√≠na Whey Isolate', dose: '1 Scoop (30g)', timing: 'workout', active: true, desc: 'Reparaci√≥n de Ki.' }, { id: '2', name: 'Omega 3 EPA/DHA', dose: '2 Perlas', timing: 'meal', active: true, desc: 'Salud cardiovascular.' }, { id: '3', name: 'Magnesio Bisglicinato', dose: '2 C√°psulas', timing: 'night', active: true, desc: 'Reparaci√≥n profunda.' }]; }

// --- C√ÅLCULO DE ENERG√çA MENSUAL (RANKING) ---
        function updateLeaderboardEntry() {
            if(!currentUser) return;
            
            // 1. Obtener fecha actual para clave mensual
            const date = new Date();
            const monthKey = `energy_${date.getMonth() + 1}_${date.getFullYear()}`; // ej: energy_5_2026

            // 2. Calcular Fuerza (Basado en CHECKS REALES, lo m√°s justo)
            let totalChecks = 0;
            appData.plan.forEach(w => w.days.forEach(d => d.exercises.forEach(e => {
                if(e.track && e.checks) {
                    // Contamos cuantos 'true' hay en el array de checks
                    totalChecks += e.checks.filter(c => c === true).length;
                }
            })));

            // 3. Calcular Cardio/Deportes (Filtrando por MES ACTUAL)
            let totalKm = 0;
            let totalMinutes = 0;
            
            if (appData.running) {
                appData.running.forEach(r => {
                    // Verificar si la actividad es de este mes/a√±o
                    const rDate = new Date(r.date);
                    if(rDate.getMonth() === date.getMonth() && rDate.getFullYear() === date.getFullYear()) {
                        totalKm += parseFloat(r.dist) || 0;
                        totalMinutes += parseFloat(r.time) || 0;
                    }
                });
            }

            // 4. LA F√ìRMULA MENSUAL
            // 1 Check = 100 Ki
            // 1 KM = 200 Ki
            // 1 Minuto = 10 Ki
            const monthlyEnergy = (totalChecks * 100) + (totalKm * 200) + (totalMinutes * 10);

            // Guardamos en Firebase bajo la clave del mes
            const updateData = {
                nickname: appData.nickname,
                group: appData.group,
                lastUpdate: new Date()
            };
            updateData[monthKey] = Math.floor(monthlyEnergy); // Campo din√°mico

            db.collection('leaderboard').doc(currentUser.uid).set(updateData, {merge:true});
        }

// --- FUNCI√ìN PARA CAMBIAR A√ëO DEL HISTORIAL ---
        function changeRankingYear(offset) {
            rankingYear += offset;
            loadLeaderboard(); // Recargamos para pintar el nuevo a√±o
        }

        // --- CARGA DEL RANKING Y SAL√ìN DE LA FAMA ---
        async function loadLeaderboard() { 
            try { 
                const snap = await db.collection('leaderboard').get(); 
                const users = []; 
                const cg = appData.group || "Global";
                
                // Fechas Actuales
                const date = new Date();
                const currentMonth = date.getMonth() + 1;
                const currentYear = date.getFullYear();
                
                // Clave del mes ACTUAL para la tabla principal (ej: energy_5_2026)
                const monthKey = `energy_${currentMonth}_${currentYear}`;
                const monthName = date.toLocaleString('es-ES', { month: 'long' }).toUpperCase();
                
                // Actualizar etiquetas visuales
                const groupDisplay = document.getElementById('ranking-group-display');
                if(groupDisplay) groupDisplay.innerText = `${cg} | ${monthName}`;
                
                const yearDisplay = document.getElementById('history-year-display');
                if(yearDisplay) yearDisplay.innerText = rankingYear;
                
                // Procesar usuarios del clan
                snap.forEach(doc => { 
                    const d = doc.data(); 
                    if(d.group === cg) {
                        // Leemos la energ√≠a de ESTE mes. Si no existe es 0.
                        const currentEnergy = d[monthKey] || 0;
                        // Guardamos todo el objeto 'd' para poder buscar meses pasados luego
                        users.push({...d, id:doc.id, currentEnergy: currentEnergy}); 
                    }
                });
                
                // --- 1. RANKING ACTUAL (TABLA PRINCIPAL) ---
                users.sort((a,b) => b.currentEnergy - a.currentEnergy);
                
                // Ganador Actual (GIF)
                const championDiv = document.getElementById('champion-display');
                const winnerName = document.getElementById('winner-name');
                const winnerPoints = document.getElementById('winner-points');

                if(users.length > 0 && users[0].currentEnergy > 0) {
                    championDiv.classList.remove('hidden'); 
                    winnerName.innerText = users[0].nickname; 
                    winnerPoints.innerText = users[0].currentEnergy.toLocaleString();
                } else {
                    championDiv.classList.add('hidden');
                }

                // Pintar Tabla Principal
                document.getElementById('rankingTableBody').innerHTML = users.map((u,i) => {
                    const isMe = u.id === currentUser.uid;
                    let medal = `#${i+1}`;
                    if(i===0) medal = 'üëë'; if(i===1) medal = 'ü•à'; if(i===2) medal = 'ü•â';
                    const rowClass = isMe ? 'bg-yellow-500/10 border-l-2 border-yellow-500' : 'border-b border-slate-800 hover:bg-white/5';
                    
                    return `
                    <tr class="${rowClass} transition-colors">
                        <td class="px-3 py-3 text-center font-bold ${i===0 ? 'text-yellow-400 text-lg' : 'text-slate-500'}">${medal}</td>
                        <td class="px-3 py-3">
                            <div class="${isMe ? 'text-white font-bold' : 'text-slate-300'} text-sm">${u.nickname} ${isMe ? '(T√∫)' : ''}</div>
                        </td>
                        <td class="px-3 py-3 text-right">
                            <span class="text-sm font-mono font-bold text-yellow-200">${(u.currentEnergy).toLocaleString()}</span>
                            <span class="text-[9px] text-slate-500 block uppercase">KI ${monthName}</span>
                        </td>
                    </tr>`;
                }).join('');

                // --- 2. SAL√ìN DE LA FAMA (HISTORIAL POR A√ëOS) ---
                const historyContainer = document.getElementById('hall-of-fame-list');
                let historyHTML = '';
                
                const monthIcons = ["‚òÉÔ∏è","üíò","üçÄ","üåßÔ∏è","üå∏","‚òÄÔ∏è","üèñÔ∏è","üç¶","üéí","üéÉ","üçÇ","üéÑ"];
                const monthNames = ["Enero","Febrero","Marzo","Abril","Mayo","Junio","Julio","Agosto","Septiembre","Octubre","Noviembre","Diciembre"];

                // Recorremos los 12 meses del a√±o seleccionado en la variable rankingYear
                for(let m=1; m<=12; m++) {
                    const histKey = `energy_${m}_${rankingYear}`;
                    
                    // Buscamos qui√©n gan√≥ en ese mes hist√≥rico
                    let winner = null;
                    let maxScore = -1;

                    users.forEach(u => {
                        // Accedemos din√°micamente a la propiedad energy_X_XXXX
                        const score = u[histKey] || 0;
                        if(score > maxScore && score > 0) {
                            maxScore = score;
                            winner = u;
                        }
                    });

                    // Solo pintamos el mes si ya ha pasado, es el actual, o si estamos viendo un a√±o pasado.
                    // Si estamos en el futuro (ej: Diciembre 2026), no pintamos nada a√∫n.
                    if (rankingYear < currentYear || (rankingYear === currentYear && m <= currentMonth)) {
                        const isCurrent = (rankingYear === currentYear && m === currentMonth);
                        const rowStyle = isCurrent ? 'border-l-4 border-yellow-500 bg-yellow-500/10' : 'border-b border-slate-800 hover:bg-white/5';
                        const winnerText = winner ? winner.nickname : 'Desierto';
                        const winnerClass = winner ? 'text-white' : 'text-slate-600 italic';

                        historyHTML += `
                        <div class="flex items-center justify-between p-3 ${rowStyle} rounded-lg transition-all">
                            <div class="flex items-center gap-3">
                                <span class="text-xl">${monthIcons[m-1]}</span>
                                <div>
                                    <p class="text-[10px] font-bold text-slate-400 uppercase tracking-wider">${monthNames[m-1]}</p>
                                    <p class="text-sm font-bold comic-font tracking-wide text-shadow ${winnerClass}">${winnerText}</p>
                                </div>
                            </div>
                            ${winner ? `
                            <div class="text-right">
                                <span class="text-xs font-mono font-bold text-yellow-500">${maxScore.toLocaleString()}</span>
                                <span class="text-[8px] text-slate-500 block uppercase">Ki</span>
                            </div>` : ''}
                        </div>`;
                    }
                }
                
                historyContainer.innerHTML = historyHTML || '<p class="text-center text-xs text-slate-500 italic py-4">Sin registros en este a√±o.</p>';
                lucide.createIcons();

            } catch(e) {
                console.error("Error ranking:", e);
            }
        }

		// --- LOGICA DE GUARDADO MULTI-DEPORTE (CORREGIDA) ---
		document.getElementById('runForm').onsubmit = function(e) { // Usamos onsubmit para evitar duplicados
			e.preventDefault();
			
			const dist = parseFloat(document.getElementById('runDist').value) || 0; 
			const timeInput = document.getElementById('runTime').value;
			const time = parseFloat(timeInput);
			
			// Obtener el tipo de deporte seleccionado
			const sportTypeEl = document.querySelector('input[name="sportType"]:checked');
			const sportType = sportTypeEl ? sportTypeEl.value : 'run';
			
			// Validaci√≥n estricta
			if(timeInput === "" || isNaN(time) || time <= 0) {
				alert("‚ö†Ô∏è Introduce el tiempo en minutos.");
				return;
			}
			
			const pace = dist > 0 ? time / dist : 0; 

			// Guardamos con ID √∫nico para poder borrar bien luego
			appData.running.push({
				id: Date.now(), // ID Vital para el borrado
				date: document.getElementById('runDate').value,
				dist: dist,
				time: time,
				pace: pace,
				type: sportType 
			});

			saveDataToCloud();
			updateRunningUI();
			
			// Resetear formulario
			e.target.reset();
			document.getElementById('runDate').valueAsDate = new Date();
			// Resetear radio button a run
			const runRadio = document.querySelector('input[value="run"]');
			if(runRadio) runRadio.checked = true;
			
			alert("‚úÖ Actividad registrada correctamente.");
		};

function updateRunningUI() {
    // 1. Sanitizaci√≥n de IDs (Para que borrar funcione siempre)
    let needsSave = false;
    appData.running.forEach((r, index) => { if (!r.id) { r.id = Date.now() + index; needsSave = true; } });
    if (needsSave) saveDataToCloud();

    const s = [...appData.running].sort((a,b) => new Date(a.date) - new Date(b.date));
    const container = document.getElementById('runningListContainer');
    const sportConfig = {
        'run': { icon: 'footprints', color: 'text-orange-400', border: 'border-orange-500/30', bg: 'bg-orange-900/40', label: 'Running' },
        'padel': { icon: 'table-2', color: 'text-blue-400', border: 'border-blue-500/30', bg: 'bg-blue-900/40', label: 'P√°del' },
        'bike': { icon: 'bike', color: 'text-purple-400', border: 'border-purple-500/30', bg: 'bg-purple-900/40', label: 'Bici' },
        'other': { icon: 'trophy', color: 'text-teal-400', border: 'border-teal-500/30', bg: 'bg-teal-900/40', label: 'Otro' }
    };

    // Stats Totales
    const totalKm = s.reduce((sum, r) => sum + (parseFloat(r.dist)||0), 0);
    const totalTime = s.reduce((sum, r) => sum + (parseFloat(r.time)||0), 0);
    if(document.getElementById('run-total-dist')) document.getElementById('run-total-dist').innerText = totalKm.toFixed(1) + " KM";
    if(document.getElementById('run-total-time')) {
        const h = Math.floor(totalTime/60); const m = totalTime%60;
        document.getElementById('run-total-time').innerText = `${h}h ${m}m`;
    }

    // --- RENDERIZADO DE LA LISTA ---
    const reversedS = [...s].reverse();
    const monthShortNames = ["ENE","FEB","MAR","ABR","MAY","JUN","JUL","AGO","SEP","OCT","NOV","DIC"];

    container.innerHTML = reversedS.map((r) => {
        const conf = sportConfig[r.type] || sportConfig['run'];
        const paceText = r.dist > 0 ? `${Math.floor(r.pace)}'${Math.round((r.pace%1)*60)}"/km` : '';
        
        // --- C√ÅLCULO DE KI VISUAL ---
        const distKi = (parseFloat(r.dist) || 0) * 200;
        const timeKi = (parseFloat(r.time) || 0) * 10;
        const totalKi = Math.round(distKi + timeKi);
        
        // Obtener Mes
        const dateObj = new Date(r.date);
        const monthTag = monthShortNames[dateObj.getMonth()];

        return `
        <div class="glass p-3 rounded-xl border-l-4 ${conf.border} flex justify-between items-center relative overflow-hidden group mb-2">
            <div class="flex-1">
                <div class="flex items-center justify-between mr-2 mb-1">
                    <div class="flex items-center gap-2">
                        <span class="text-[9px] text-slate-400 font-mono font-bold uppercase">${r.date}</span>
                        <span class="text-[9px] ${conf.bg} ${conf.color} px-2 rounded-full flex items-center gap-1 uppercase font-bold border border-white/5">
                            <i data-lucide="${conf.icon}" class="w-3 h-3"></i> ${conf.label}
                        </span>
                    </div>
                    <span class="text-[9px] text-yellow-400 font-black bg-yellow-900/30 px-2 py-0.5 rounded border border-yellow-500/20 shadow-[0_0_10px_rgba(234,179,8,0.2)]">
                        ‚ö° ${totalKi} <span class="text-yellow-600 ml-0.5">[${monthTag}]</span>
                    </span>
                </div>
                <div class="text-white font-bold text-sm flex items-baseline mt-1">
                    <span class="text-lg mr-1">${r.time}</span> <span class="text-[9px] text-slate-500 uppercase mr-3">MIN</span>
                    ${r.dist > 0 ? `<span class="text-lg mr-1">${r.dist}</span> <span class="text-[9px] ${conf.color} uppercase">KM</span>` : ''}
                    ${paceText ? `<span class="ml-auto text-[9px] text-slate-500 font-mono bg-black/20 px-2 rounded">${paceText}</span>` : ''}
                </div>
            </div>
            <button onclick="delRun('${r.id}')" class="relative z-10 text-slate-600 hover:text-red-500 p-3 hover:bg-red-900/20 rounded-lg transition-all ml-2 cursor-pointer">
                <i data-lucide="trash-2" class="w-4 h-4"></i>
            </button>
        </div>
    `}).join('');
    lucide.createIcons();
    
    // --- GR√ÅFICAS (Igual que antes, omitido por brevedad pero necesario mantenerlo) ---
    renderRunCharts(s); // He extra√≠do las gr√°ficas a una funci√≥n auxiliar para limpiar c√≥digo
}

		// --- GR√ÅFICA DE RUNNING: VERSI√ìN ESTABILIZADA ---
		function renderRunCharts(s) {
			// 1. Filtrar y ordenar datos
			const paceData = s
				.filter(r => r.dist > 0 && r.pace > 0)
				.sort((a,b) => new Date(a.date) - new Date(b.date));

			// Funci√≥n auxiliar: Convierte decimal a formato corredor (9'12")
			const formatPace = (decimal) => {
				const mins = Math.floor(decimal);
				const secs = Math.round((decimal % 1) * 60); 
				return `${mins}'${secs.toString().padStart(2, '0')}"`;
			};

			// --- GR√ÅFICA 1: RITMO ---
			if(document.getElementById('chartRunningPace')) { 
				const ctxPace = document.getElementById('chartRunningPace').getContext('2d');
				
				if(runningPaceChartInstance) runningPaceChartInstance.destroy();
				
				runningPaceChartInstance = new Chart(ctxPace, { 
					type: 'line', 
					data: { 
						labels: paceData.map(d => d.date.slice(5)), 
						datasets: [{ 
							label: 'Ritmo', 
							data: paceData.map(d => d.pace), 
							borderColor: '#f97316', 
							borderWidth: 3, 
							tension: 0.3, 
							pointBackgroundColor: '#1e293b', 
							pointBorderColor: '#f97316',
							pointRadius: 5,
							fill: true, 
							backgroundColor: 'rgba(249, 115, 22, 0.1)' 
						}] 
					}, 
					options: { 
						maintainAspectRatio: false, 
						interaction: {
							intersect: false,
							mode: 'index',
						},
						scales: { 
							y: { 
								reverse: true, // Arriba es m√°s r√°pido
								beginAtZero: false,
								grace: '20%', // Mucho margen arriba y abajo para que no toque los bordes
								grid: { color: 'rgba(255,255,255,0.1)' }, 
								ticks: { 
									color: '#fbbf24', 
									font: {size: 10, weight: 'bold'},
									maxTicksLimit: 6, // M√ÅXIMO 6 L√çNEAS (Evita saturaci√≥n)
									autoSkip: true,   // Salta etiquetas si no caben
									callback: function(value, index, values) { 
										const label = formatPace(value);
										
										// L√≥gica Anti-Duplicados Visuales
										if (index > 0) {
											const prevValue = values[index - 1].value;
											const prevLabel = formatPace(prevValue);
											// Si este tick visualmente es igual al anterior, lo ocultamos
											if (label === prevLabel) return null;
										}
										return label + "/km";
									}
								} 
							}, 
							x: { 
								display: true, 
								grid: { display: false },
								ticks: { color: '#94a3b8', font: {size: 9} } 
							} 
						}, 
						plugins: { 
							legend: { display: false },
							tooltip: {
								callbacks: {
									label: function(context) {
										return `Ritmo: ${formatPace(context.raw)}/km`;
									}
								}
							}
						} 
					} 
				});
			}

			// --- GR√ÅFICA 2: VOLUMEN (Sin cambios) ---
			const weeksMap = {}; 
			s.forEach(r => { 
				if(r.dist > 0) { 
					const d = new Date(r.date); 
					const day = d.getDay(); 
					const diff = d.getDate() - day + (day == 0 ? -6 : 1); 
					const monday = new Date(d.setDate(diff)).toISOString().split('T')[0]; 
					
					if(!weeksMap[monday]) weeksMap[monday] = { label: monday.slice(5), total: 0 }; 
					weeksMap[monday].total += parseFloat(r.dist); 
				} 
			});
			
			const sortedWeeks = Object.keys(weeksMap).sort();
			
			if(document.getElementById('chartRunningVolume')) {
				const ctxVol = document.getElementById('chartRunningVolume').getContext('2d');
				if(runningVolumeChartInstance) runningVolumeChartInstance.destroy();
				
				runningVolumeChartInstance = new Chart(ctxVol, { 
					type: 'bar', 
					data: { 
						labels: sortedWeeks.map(k => weeksMap[k].label), 
						datasets: [{ 
							label: 'KM', 
							data: sortedWeeks.map(k => weeksMap[k].total), 
							backgroundColor: '#fbbf24', 
							borderRadius: 4, 
							barThickness: 20 
						}] 
					}, 
					options: { 
						maintainAspectRatio: false, 
						scales: { 
							y: { 
								beginAtZero: true, 
								grid: { color: 'rgba(255,255,255,0.05)' }, 
								ticks: { color: '#94a3b8', font: {size: 9} } 
							}, 
							x: { 
								grid: { display: false }, 
								ticks: { color: '#94a3b8', font: {size: 9} } 
							} 
						}, 
						plugins: { legend: { display: false } } 
					} 
				});
			}
		}

// --- FUNCI√ìN DE BORRADO DEFINITIVA ---
// La asignamos a window para asegurarnos de que el HTML la encuentre siempre
window.delRun = function(idToDelete) {
    if(!confirm("¬øEliminar esta actividad permanentemente?")) return;

    // Buscamos si existe
    const exists = appData.running.some(r => r.id == idToDelete);
    
    if (exists) {
        // Filtramos: Nos quedamos con todos MENOS el que tenga ese ID
        // Usamos != (comparaci√≥n flexible) porque el ID del HTML viene como texto
        appData.running = appData.running.filter(r => r.id != idToDelete);
        
        saveDataToCloud();
        updateRunningUI();
    } else {
        alert("‚ö†Ô∏è Error: No se encontr√≥ el registro. Refresca la p√°gina.");
    }
};
        // --- GENERADOR DE PDF (ZENKAI REPORT) ---
        async function generatePDF() {
            if (!window.jspdf) return alert("Error: Librer√≠a PDF no cargada. Refresca.");
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Estilos Base
            const gold = [251, 191, 36];
            const blue = [59, 130, 246];
            
            // CABECERA
            doc.setFillColor(15, 23, 42); // Fondo oscuro cabecera
            doc.rect(0, 0, 210, 40, 'F');
            
            doc.setFontSize(22);
            doc.setTextColor(...gold);
            doc.setFont("helvetica", "bold");
            doc.text("ZENKAI Z: INFORME DE COMBATE", 105, 20, null, null, "center");
            
            doc.setFontSize(10);
            doc.setTextColor(200, 200, 200);
            doc.text(`Guerrero: ${appData.nickname || 'An√≥nimo'}  |  Clan: ${appData.group || 'Sin Clan'}`, 105, 30, null, null, "center");
            doc.text(`Fecha del Informe: ${new Date().toLocaleDateString()}`, 105, 35, null, null, "center");

            let yPos = 50;

            // 1. BIOMETR√çA (Salud)
            doc.setFontSize(14);
            doc.setTextColor(0, 0, 0);
            doc.text("1. Diagn√≥stico Vital (Peso & Salud)", 14, yPos);
            yPos += 3;
            
            const statsData = appData.progress.map(p => [p.date, p.weight + " kg", p.vfc + " ms", p.rhr + " ppm", p.sleep + " h"]);
            doc.autoTable({
                startY: yPos,
                head: [['Fecha', 'Peso', 'VFC', 'PPM Reposo', 'Sue√±o']],
                body: statsData,
                theme: 'striped',
                headStyles: { fillColor: [59, 130, 246], fontStyle: 'bold' }, // Azul
                styles: { fontSize: 9 }
            });
            yPos = doc.lastAutoTable.finalY + 15;

            // 2. RUNNING (Cardio)
            doc.text("2. Registro Aer√≥bico (Running)", 14, yPos);
            yPos += 3;
            const runData = appData.running.map(r => [r.date, r.dist + " km", r.time + " min", Math.floor(r.pace) + "'" + Math.round((r.pace % 1) * 60) + '"/km']);
            doc.autoTable({
                startY: yPos,
                head: [['Fecha', 'Distancia', 'Tiempo', 'Ritmo Medio']],
                body: runData,
                theme: 'striped',
                headStyles: { fillColor: [249, 115, 22], fontStyle: 'bold' }, // Naranja
                styles: { fontSize: 9 }
            });
            yPos = doc.lastAutoTable.finalY + 15;

            // 3. FUERZA (R√©cords)
            doc.text("3. R√©cords de Poder (PRs)", 14, yPos);
            yPos += 3;
            const strengthData = Object.keys(appData.strength).map(k => {
                const max = Math.max(...appData.strength[k].map(d => parseFloat(d.weight) || 0));
                return [k, max + " kg"];
            });
            doc.autoTable({
                startY: yPos,
                head: [['Ejercicio', 'Carga M√°xima Hist√≥rica']],
                body: strengthData,
                theme: 'grid',
                headStyles: { fillColor: [34, 197, 94], fontStyle: 'bold' }, // Verde
                styles: { fontSize: 10, fontStyle: 'bold' }
            });

            // PIE DE P√ÅGINA
            const pageCount = doc.internal.getNumberOfPages();
            for(let i = 1; i <= pageCount; i++) {
                doc.setPage(i);
                doc.setFontSize(8);
                doc.setTextColor(150);
                doc.text('Generado por Plan Pepe System - Final Form', 105, 290, null, null, 'center');
            }

            // Descargar
            doc.save(`Informe_Zenkai_${new Date().toISOString().split('T')[0]}.pdf`);
        }
        function delRun(i) { if(confirm("¬øBorrar?")){ const s=[...appData.running].sort((a,b)=>new Date(b.date)-new Date(a.date)); const realIdx=appData.running.indexOf(s[i]); if(realIdx>-1){appData.running.splice(realIdx,1); saveDataToCloud(); updateRunningUI();} } }
        function handlePhotoUpload(input) { const f = input.files[0]; if(!f) return; const r = new FileReader(); r.onload = e => { const img = new Image(); img.onload = () => { const c = document.createElement('canvas'); const ctx = c.getContext('2d'); const max = 800; let w = img.width, h = img.height; if(w > max){ h *= max/w; w = max; } c.width = w; c.height = h; ctx.drawImage(img, 0, 0, w, h); galleryData.unshift({ date: new Date().toISOString().split('T')[0], img: c.toDataURL('image/jpeg', 0.8) }); localStorage.setItem('pepeGallery', JSON.stringify(galleryData)); renderGallery(); }; img.src = e.target.result; }; r.readAsDataURL(f); }
        function renderGallery() { const g = document.getElementById('gallery-grid'); if(!g) return; if(!galleryData.length) { g.innerHTML='<p class="text-[10px] text-slate-600 text-center col-span-2 uppercase font-black italic mt-10 opacity-40">Sin archivos visuales.</p>'; return; } g.innerHTML = galleryData.map((x,i) => `<div class="relative group overflow-hidden rounded-2xl shadow-xl"><img src="${x.img}" class="w-full h-40 object-cover transition-transform duration-500 group-hover:scale-110" onclick="window.open('${x.img}')"><button onclick="delPhoto(${i})" class="absolute top-2 right-2 bg-black/60 text-white rounded-lg p-2 opacity-0 group-hover:opacity-100 transition-opacity"><i data-lucide="trash-2" class="w-4 h-4"></i></button></div>`).join(''); lucide.createIcons(); }
        function delPhoto(i) { if(confirm("¬øBorrar?")){ galleryData.splice(i,1); localStorage.setItem('pepeGallery', JSON.stringify(galleryData)); renderGallery(); } }

		function updateProfileData() {
            appData.targetWeight = parseFloat(document.getElementById('profile-target').value) || 0;
            appData.injuries = document.getElementById('profile-injuries').value || "";
            saveDataToCloud();
        }
		function closeSpyModal() { document.getElementById('spy-modal').classList.add('hidden'); }
        function closeSpyPreview() { document.getElementById('spy-preview-modal').classList.add('hidden'); spyPendingWeek = null; }
        // Corregir espiar
        async function loadSpyPlan(uid) {
            const container = document.getElementById('spy-weeks-container');
            container.innerHTML = '<p class="text-center animate-pulse py-10">Interceptando se√±al...</p>';
            try {
                const doc = await db.collection('users').doc(uid).get();
                if(doc.exists && doc.data().plan) {
                    container.innerHTML = doc.data().plan.map(w => `
                        <div class="bg-slate-800/70 p-4 rounded-xl flex justify-between items-center mb-3 border border-slate-700">
                            <span class="text-white font-bold text-sm">${w.label || "Protocolo"}</span>
                            <div class="flex gap-2">
                                <button onclick='previewSpyWeek(${JSON.stringify(w).replace(/'/g,"&apos;")})' class="bg-blue-600 px-3 py-1 rounded text-[10px] font-bold">VER</button>
                                <button onclick='copySpyWeek(${JSON.stringify(w).replace(/'/g,"&apos;")})' class="bg-green-600 px-3 py-1 rounded text-[10px] font-bold">CLONAR</button>
                            </div>
                        </div>`).join('');
                }
            } catch(e) { container.innerHTML = '<p class="text-red-500">Error de conexi√≥n.</p>'; }
        }
		
		
		// --- SPOTIFY LOGIC ---
        function toggleSpotify() {
            document.getElementById('spotify-controls').classList.toggle('hidden');
        }

        function changeSpotifyPlaylist(id) {
            // Cambia el 'src' del iframe manteniendo la estructura de embed
            document.getElementById('spotify-iframe').src = `https://open.spotify.com/embed/playlist/${id}?utm_source=generator&theme=0`;
        }
		// Activa el bot√≥n de clonado en la previsualizaci√≥n
        document.getElementById('btn-copy-preview').onclick = () => { if(spyPendingWeek) copySpyWeek(spyPendingWeek); };
        window.onload = () => { document.getElementById('inputDate').valueAsDate = new Date(); document.getElementById('runDate').valueAsDate = new Date(); lucide.createIcons(); };
		function updateKiStatus() {
    const card = document.getElementById('ki-status-card');
    const text = document.getElementById('ki-status-text');
    if (!card || !appData.progress.length) return;

    card.classList.remove('hidden');
    const lastVfc = appData.progress[appData.progress.length - 1].vfc;

    if (lastVfc >= 65) {
        card.style.borderColor = "#22c55e"; 
        text.innerHTML = `<span class="text-green-400 font-bold font-sans">KI ALTO (${lastVfc}):</span> Tu sistema nervioso est√° recuperado. Es el momento de buscar un nuevo R√©cord Personal (PR).`;
    } else if (lastVfc >= 45) {
        card.style.borderColor = "#fbbf24"; 
        text.innerHTML = `<span class="text-yellow-400 font-bold font-sans">KI ESTABLE (${lastVfc}):</span> Recuperaci√≥n normal. Entrena con intensidad moderada, sin llegar al fallo extremo.`;
    } else {
        card.style.borderColor = "#ef4444"; 
        text.innerHTML = `<span class="text-red-400 font-bold font-sans">KI AGOTADO (${lastVfc}):</span> Estr√©s alto detectado. Considera un d√≠a de descanso o una sesi√≥n muy suave para evitar lesiones.`;
    }
}
	// --- FUNCIONES NUEVAS DE EDICI√ìN DEL PLAN ---
	function updateExerciseData(dayIdx, exIdx, field, value) {
		appData.plan[currentWeekIndex].days[dayIdx].exercises[exIdx][field] = value;
		saveDataToCloud();
	}

	function deleteExercise(dayIdx, exIdx) {
		if(confirm("¬øEliminar este ejercicio?")) {
			appData.plan[currentWeekIndex].days[dayIdx].exercises.splice(exIdx, 1);
			saveDataToCloud(); renderPlan();
		}
	}

	function addNewExercise(dayIdx) {
		appData.plan[currentWeekIndex].days[dayIdx].exercises.push({ name: "Nuevo Ejercicio", sets: "3", reps: "10", track: true, weight: "" });
		saveDataToCloud(); renderPlan();
	}

	// --- FUNCIONES MEJORADAS DE FUERZA (Para borrar si el input est√° vac√≠o) ---
	function saveWeight(d, e, v) {
		appData.plan[currentWeekIndex].days[d].exercises[e].weight = v;
		const n = parseFloat(v);
		if (!isNaN(n) && n > 0) {
			saveStrengthRecord(appData.plan[currentWeekIndex].days[d].exercises[e].name, n);
		} else if (v === "") {
			// L√≥gica opcional: Si borras el peso hoy, ¬øquieres borrar el record de hoy?
			// Por seguridad, mejor usar la tabla de historial para borrar.
		}
		saveDataToCloud();
	}

	// --- GESTOR DE HISTORIAL Y SELECTOR ---
	function handleStrengthSelectChange() {
		renderStrengthChart();
		renderStrengthHistory();
	}

	function renderStrengthHistory() {
		const select = document.getElementById('exercise-select');
		const tbody = document.getElementById('strengthHistoryBody');
		if (!select || !tbody) return;

		const exerciseName = select.value;
		const data = (appData.strength[exerciseName] || []).sort((a,b) => new Date(b.date) - new Date(a.date)); // Ordenar por m√°s reciente

		tbody.innerHTML = data.map((record, index) => `
			<tr class="border-b border-slate-800 hover:bg-slate-800/30">
				<td class="p-3 text-slate-400 font-mono text-xs">${record.date}</td>
				<td class="p-3 text-white font-bold">${record.weight} kg</td>
				<td class="p-3 text-right">
					<button onclick="deleteHistoryEntry('${exerciseName}', ${index})" class="text-red-500 hover:text-red-400 p-1 hover:bg-red-900/20 rounded">
						<i data-lucide="trash-2" class="w-4 h-4"></i>
					</button>
				</td>
			</tr>
		`).join('') || '<tr><td colspan="3" class="p-4 text-center text-slate-600 italic text-xs">Sin registros.</td></tr>';
		lucide.createIcons();
	}

	function deleteHistoryEntry(exerciseName, index) {
		// Nota: El index viene del array ordenado (m√°s reciente primero), necesitamos encontrar el real
		// O simplificar: trabajar sobre el array ordenado y guardar.
		if(confirm("¬øBorrar este registro hist√≥rico?")) {
			// Recuperamos el array original
			let data = appData.strength[exerciseName] || [];
			// Lo ordenamos igual que en la vista para coincidir √≠ndices
			data.sort((a,b) => new Date(b.date) - new Date(a.date));
			
			// Eliminamos el elemento
			data.splice(index, 1);
			
			// Guardamos el array modificado de vuelta
			appData.strength[exerciseName] = data;
			saveDataToCloud();
			
			// Actualizamos UI
			renderStrengthChart();
			renderStrengthHistory();
			updatePRs();
		}
	}

	// MODIFICACI√ìN DE "saveStrengthRecord" PARA QUE ACTUALICE LA TABLA AL INSTANTE
	function saveStrengthRecord(n, w) {
		const cleanName = n.trim();
		if(!appData.strength[cleanName]) appData.strength[cleanName] = [];
		const today = new Date().toISOString().split('T')[0];
		const existingIndex = appData.strength[cleanName].findIndex(e => e.date === today);
		
		if(existingIndex > -1) {
			appData.strength[cleanName][existingIndex].weight = w; // Actualiza si ya existe hoy
		} else {
			appData.strength[cleanName].push({ date: today, weight: w }); // Crea nuevo
		}
		
		updateExerciseSelector(); 
		updatePRs();
		// Si estamos viendo ese ejercicio, actualizar gr√°fica y tabla
		const currentSelect = document.getElementById('exercise-select');
		if(currentSelect && currentSelect.value === cleanName) {
			renderStrengthChart();
			renderStrengthHistory();
		}
	}
		function exportPlanJSON() {
		if(!appData.plan || appData.plan.length === 0) return alert("No hay plan para exportar.");
		// Exportamos el plan actual (la semana que est√°s viendo)
		const currentPlan = appData.plan[currentWeekIndex];
		// Convertimos a texto bonito
		const jsonString = JSON.stringify(currentPlan, null, 2);
		
		// Lo copiamos al portapapeles o lo mostramos
		navigator.clipboard.writeText(jsonString).then(() => {
			alert("‚úÖ JSON de tu plan copiado al portapapeles.\n\nPuedes peg√°rselo a la IA para que lo use de base.");
		}).catch(err => {
			prompt("Copia este c√≥digo manualmente:", jsonString);
		});
	}
	// --- GESTI√ìN DE HISTORIAL DE FUERZA ---

		// Esta funci√≥n se llama al cambiar el desplegable
		function handleStrengthSelectChange() {
			renderStrengthChart();
			renderStrengthHistory(); // ¬°Esto faltaba o fallaba antes!
		}

		// Dibuja la tabla debajo de la gr√°fica
		function renderStrengthHistory() {
			const select = document.getElementById('exercise-select');
			const tbody = document.getElementById('strengthHistoryBody');
			
			// Si no existen los elementos en el DOM, paramos para no dar error
			if (!select || !tbody) return;

			const exerciseName = select.value;
			// Obtenemos datos, si no hay (ejercicio nuevo), array vac√≠o
			const data = (appData.strength[exerciseName] || []).sort((a,b) => new Date(b.date) - new Date(a.date));

			tbody.innerHTML = data.map((record, index) => `
				<tr class="border-b border-slate-800 hover:bg-slate-800/30 transition-colors">
					<td class="p-3 text-slate-400 font-mono text-xs">${record.date}</td>
					<td class="p-3 text-white font-bold">${record.weight} kg</td>
					<td class="p-3 text-right">
						<button onclick="deleteHistoryEntry('${exerciseName}', ${index})" class="text-red-500 hover:text-red-400 p-2 hover:bg-red-900/20 rounded-lg transition-all">
							<i data-lucide="trash-2" class="w-4 h-4"></i>
						</button>
					</td>
				</tr>
			`).join('') || '<tr><td colspan="3" class="p-4 text-center text-slate-600 italic text-xs">Sin registros a√∫n.</td></tr>';
			
			lucide.createIcons();
		}

		// Borra una entrada espec√≠fica y actualiza todo
		function deleteHistoryEntry(exerciseName, index) {
			if(confirm("¬øBorrar este registro hist√≥rico? Se recalcular√° tu gr√°fica.")) {
				// Trabajamos con el array ordenado para coincidir con lo que ve el usuario
				let data = appData.strength[exerciseName] || [];
				data.sort((a,b) => new Date(b.date) - new Date(a.date));
				
				// Borramos
				data.splice(index, 1);
				
				// Guardamos
				appData.strength[exerciseName] = data;
				saveDataToCloud();
				
				// Refrescamos UI
				renderStrengthChart();
				renderStrengthHistory();
				updatePRs();
			}
		}

		
        // --- CRON√ìMETRO INTELIGENTE (AUTO-REST) ---
        let timerInterval; let timeRemaining = 0; const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        
        // Cargar preferencia guardada
        window.addEventListener('load', () => {
            const savedTime = localStorage.getItem('pepeRestTime');
            if(savedTime) document.getElementById('timer-default-time').value = savedTime;
        });

        function toggleTimer() { 
            const d = document.getElementById('timer-display'); 
            d.classList.toggle('hidden'); 
        }

        // Esta funci√≥n la llamaremos cuando guardes un peso
        function triggerAutoTimer() {
            const autoOn = document.getElementById('timer-auto-switch').checked;
            if(autoOn) {
                const secs = parseInt(document.getElementById('timer-default-time').value) || 90;
                startTimer(secs);
                // Abrir el panel si est√° cerrado para que veas que ha empezado
                document.getElementById('timer-display').classList.remove('hidden');
            }
        }

        function startTimer(seconds) { 
            clearInterval(timerInterval); 
            timeRemaining = seconds; 
            updateTimerVisuals(); 
            document.getElementById('timer-status').innerText = "RECUPERANDO...";
            document.getElementById('timer-status').classList.remove('text-green-500');
            document.getElementById('timer-status').classList.add('text-yellow-500');

            timerInterval = setInterval(() => { 
                timeRemaining--; 
                updateTimerVisuals(); 
                if (timeRemaining <= 0) { 
                    clearInterval(timerInterval); 
                    playAlarm(); 
                    if(navigator.vibrate) navigator.vibrate([200, 100, 200]); 
                    document.getElementById('timer-status').innerText = "¬°A LA BATALLA!";
                    document.getElementById('timer-status').classList.replace('text-yellow-500', 'text-green-500');
                } 
            }, 1000); 
        }

        function stopTimer() { clearInterval(timerInterval); timeRemaining = 0; updateTimerVisuals(); document.getElementById('timer-status').innerText = "PAUSADO"; }
        function addTime(s) { timeRemaining += s; updateTimerVisuals(); }
        
        function updateTimerVisuals() { 
            const m = Math.floor(timeRemaining / 60); const s = timeRemaining % 60; 
            document.getElementById('timer-countdown').innerText = `${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`; 
        }
        
        function playAlarm() { /* (Mismo c√≥digo de sonido beep de antes) */ if (audioContext.state === 'suspended') audioContext.resume(); const osc = audioContext.createOscillator(); const gain = audioContext.createGain(); osc.connect(gain); gain.connect(audioContext.destination); osc.type = 'square'; osc.frequency.setValueAtTime(880, audioContext.currentTime); osc.frequency.setValueAtTime(440, audioContext.currentTime + 0.1); gain.gain.setValueAtTime(0.1, audioContext.currentTime); gain.gain.exponentialRampToValueAtTime(0.00001, audioContext.currentTime + 0.5); osc.start(); osc.stop(audioContext.currentTime + 0.5); }
// --- FUNCI√ìN DEL CHECK CON GUARDADO EN NUBE ---
        function toggleSetCheck(dayIdx, exIdx, setIdx, btn) {
            // Accedemos al ejercicio concreto
            const exercise = appData.plan[currentWeekIndex].days[dayIdx].exercises[exIdx];
            
            // Inicializamos el array de checks si no existe
            if (!exercise.checks) exercise.checks = [];
            
            // Cambiamos el estado (True <-> False)
            const newState = !exercise.checks[setIdx];
            exercise.checks[setIdx] = newState;

            // Actualizamos visualmente al instante (para que se sienta r√°pido)
            const wrapper = btn.parentElement;
            const input = wrapper.querySelector('input');
            
            if (newState) {
                // MARCADO
                if(input) input.classList.add('completed-set');
                btn.classList.remove('bg-slate-700/50', 'text-slate-400', 'border-slate-600');
                btn.classList.add('bg-green-600', 'text-white', 'border-green-500');
                triggerAutoTimer(); // Lanzar crono
            } else {
                // DESMARCADO
                if(input) input.classList.remove('completed-set');
                btn.classList.remove('bg-green-600', 'text-white', 'border-green-500');
                btn.classList.add('bg-slate-700/50', 'text-slate-400', 'border-slate-600');
            }

            // Guardar en Firebase y recalcular Ranking
            saveDataToCloud();
        }
		// --- RENDERIZADOR DE SUPLEMENTOS BLINDADO ---
		function renderSupplements() {
			const container = document.getElementById('supplements-list'); 
			if(!container) return;

			// 1. Seguridad: Si la lista no existe, la inicializamos vac√≠a
			if (!appData.supplements) appData.supplements = [];

			// 2. Si est√° vac√≠a, mostramos mensaje de ayuda
			if(appData.supplements.length === 0) {
				container.innerHTML = `
					<div class="text-center p-10 border-2 border-dashed border-slate-700 rounded-3xl bg-slate-900/50">
						<i data-lucide="flask-conical" class="w-10 h-10 text-slate-600 mx-auto mb-3"></i>
						<p class="text-slate-500 text-xs italic">Tu inventario est√° vac√≠o.</p>
						<button onclick="appData.supplements=getDefaultSupplements(); saveDataToCloud(); renderSupplements();" class="mt-4 text-[10px] text-teal-400 underline uppercase font-bold">Cargar B√°sicos</button>
					</div>`;
				lucide.createIcons();
				return;
			}

			// 3. Mapeo de Textos para que se vea bonito
			const timeMap = {
				'morning': '‚òÄÔ∏è Ma√±ana',
				'workout': '‚ö° Entreno',
				'meal': 'üçΩÔ∏è Comida',
				'night': 'üåô Noche'
			};

			// 4. Generar HTML
			container.innerHTML = appData.supplements.map(s => {
				// Estilos din√°micos seg√∫n si est√° activo o no
				const opacityClass = s.active ? 'opacity-100' : 'opacity-40 grayscale';
				const borderClass = s.active ? 'border-teal-500' : 'border-slate-600';
				const activeDot = s.active ? '<span class="w-2 h-2 rounded-full bg-teal-400 animate-pulse shadow-[0_0_8px_#2dd4bf]"></span>' : '<span class="w-2 h-2 rounded-full bg-slate-600"></span>';

				return `
				<div class="glass p-5 rounded-3xl border-l-4 ${borderClass} relative group transition-all ${opacityClass} overflow-hidden">
					<div class="absolute right-0 top-0 w-24 h-24 bg-teal-500/5 rounded-bl-full pointer-events-none"></div>

					<div class="flex justify-between items-start relative z-10">
						<div class="flex-1 pr-8">
							<div class="flex items-center gap-2 mb-1">
								${activeDot}
								<h4 class="font-bold text-white text-base uppercase italic tracking-wider">${s.name}</h4>
							</div>
							<div class="text-[11px] text-teal-300 font-mono font-bold uppercase bg-teal-900/30 inline-block px-2 py-0.5 rounded border border-teal-500/20">
								${s.dose}
							</div>
						</div>
						
						<span class="text-[9px] bg-slate-800 text-slate-300 px-3 py-1 rounded-lg border border-slate-600 uppercase font-bold tracking-wider">
							${timeMap[s.timing] || s.timing}
						</span>
					</div>

					<p class="text-[10px] text-slate-400 mt-4 italic border-t border-white/5 pt-2 leading-relaxed">
						${s.desc || 'Sin descripci√≥n t√°ctica.'}
					</p>

					<button onclick="openSuppModal('${s.id}')" class="absolute top-4 right-4 text-slate-500 hover:text-white p-2 rounded-full hover:bg-slate-700/50 transition-all">
						<i data-lucide="edit-2" class="w-4 h-4"></i>
					</button>
				</div>`;
			}).join('');

			lucide.createIcons();
		}
    </script>
</body>
</html>
